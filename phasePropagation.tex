\newchapter{phasePropagation}{Phase Propagation}

The PFF system uses the upstream phase measurement to correct the downstream phase. In this scheme any differences between the initial upstream phase and the downstream phase cannot be removed by the PFF system. The PFF system is therefore very sensitive to the ``phase propagation'', or the extent to which the upstream phase predicts the actual downstream phase. As, at CTF3, the upstream and downstream phase monitors are separated by roughly 150~m of beam line there are many potential sources that may change the downstream phase with respect to the upstream phase. This chapter derives the requirements that the PFF system places on the phase propagation before describing its original status during the first PFF tests and the extensive work that has been needed to improve it.

\newsection{pffEquations}{Feedforward Algorithm}

In the PFF system the voltage sent to the kickers in the TL2 chicane (see Figures~\ref{f:ctfpffLayout}~and~\ref{f:newTL2Lattice}) is varied depending on the upstream phase. The corrected downstream phase, \(\phi_{PFF}\), can therefore be simply modelled as subtracting the upstream phase, \(\phi_u\), from the initial downstream phase \(\phi_d\):
\begin{equation}
\phi_{PFF} = \phi_d - g\phi_u
\label{e:pffEq1}
\end{equation}
where \(g\) is the applied correction gain. The corrected downstream phase jitter, \(\sigma_{PFF}\), can then be defined using the standard result of subtracting correlated variances \cite{sumVar}:
\begin{equation}
\sigma_{PFF}^2 = \sigma_d^2 + g^2\sigma_u^2 - 2g\rho_{ud}\sigma_u\sigma_d
\label{e:pffEq2}
\end{equation}
where \(\rho_{ud}\) is the correlation coefficient between the upstream phase and the downstream phase. Setting the partial differential of Equation~\ref{e:pffEq2} with respect to the gain equal to zero yields an expression for the theoretical optimal gain value to apply:
\begin{equation}
\frac{\partial \sigma_{PFF}^2}{\partial g} = 2g\sigma_u^2 - 2\rho_{ud}\sigma_u\sigma_d = 0
\end{equation}
\begin{equation}
g = \rho_{ud}\left(\frac{\sigma_d}{\sigma_u}\right)
\label{e:theoretOptGain}
\end{equation}
In the case where the phase propagation is perfect and the downstream phase is identical to the upstream phase the optimal gain factor is 1, as expected. Alternatively, if there is no correlation between the upstream and downstream phase the PFF system could only act to increase the downstream phase jitter, thus the optimal gain would be zero. If the downstream phase jitter is amplified with respect to the upstream phase jitter (\(\phi_d = \mathrm{const}\times\phi_u\)), this can be removed by the PFF system via the dependence of the optimal gain on the upstream--downstream phase jitter ratio.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/theoretJitvsCorr}
  \caption{Dependence of the ratio between the theoretical corrected and initial downstream phase jitter (\(\sigma_{PFF}/\sigma_d\)) on the initial upstream-downstream phase correlation (\(\rho_{ud}\)).}
  \label{f:theoretJitvsCorr}
\end{figure}

Substituting the optimal gain value back in to Equation~\ref{e:pffEq2} gives an expression for the theoretical limit on the corrected downstream phase jitter using the PFF system:
\begin{equation}
\sigma_{PFF} = \sigma_d\sqrt{1-\rho_{ud}^2}
\label{e:theoretJitOptGain}
\end{equation}
With the optimal PFF setup the achievable corrected downstream phase jitter has no dependence on the upstream phase jitter. It depends only on the initial downstream phase jitter and the upstream--downstream phase correlation. The dependence of the achievable corrected downstream phase jitter on the phase monitor resolution (Section~\ref{s:resolutionEqs}) is implicit, as this contributes to the measured upstream--downstream phase correlation. If non-optimal gains are used there is also a dependence on the upstream phase jitter and the gain as per Equation~\ref{e:pffEq2}. Figure~\ref{f:theoretJitvsCorr} shows how the achievable corrected downstream phase jitter depends on the upstream--downstream phase correlation. A factor 2 reduction in the initial downstream phase jitter requires a correlation of 86.6\%, for example.

Equations~\ref{e:pffEq2},~\ref{e:theoretOptGain}~and~\ref{e:theoretJitOptGain} are used extensively in the remainder of this thesis to determine the beam conditions needed to achieve a \(0.2^\circ\) correction at CTF3, as well as to calculate the expected effect of the PFF system given the beam conditions and PFF setup.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/propagation/origMeanPhJit}
  \caption{Typical initial mean phase jitter upstream (blue) and downstream (red) during early PFF tests, across a dataset containing 213 pulses.}
   \label{f:origMeanPhJit}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/origUpVsDown}
  \caption{Typical initial correlation between the downstream phase and the upstream phase during early PFF tests.}
  \label{f:origUpVsDown}
\end{figure}


\newsection{origJitter}{Characteristics of Uncorrected Phase Jitter}

This section summarises the status of the phase propagation during the first PFF tests to demonstrate why the work in this chapter was necessary and to provide a point of comparison to the improved conditions later achieved in Section~\ref{s:bestPhaseProp}.

\subsubsection{Mean Phase}



Figure~\ref{f:origMeanPhJit} compares the mean phase upstream and downstream across one dataset of 213 pulses, or roughly 5 minutes. The downstream phase jitter is more than double the upstream rms phase jitter --- at \(1.86\pm0.09^\circ\) compared to \(0.81\pm0.04^\circ\) upstream. Theoretically the PFF system could still remove the amplified downstream phase jitter providing the jitter is well correlated with the upstream phase, as derived in the previous section. Unfortunately, as shown in Figure~\ref{f:origUpVsDown}, there is almost no correlation between the upstream and downstream phase, with a calculated coefficient of \(0.34\pm0.06\) in this case.


\subsubsection{Phase Along Pulse}

In addition to the differences in the mean phase there are also large discrepancies between the upstream and downstream phase along the pulse. Figure~\ref{f:origPhaseAlong} shows one example of this. The overall phase sag along the pulse is approximately equivalent for both the upstream and downstream phase. However, there are many oscillations along the downstream phase, up to \(10^\circ\) peak-to-peak, that are not present upstream.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/origPhaseAlong}
  \caption{Mean upstream (blue) and downstream (red) phase along the pulse during early PFF tests, averaged across 213 pulses.}
  \label{f:origPhaseAlong}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/origJitterAlong}
  \caption{Upstream (blue) and downstream (red) phase jitter along the pulse during early PFF tests, across a dataset containing 213 pulses.}
  \label{f:origJitterAlong}
\end{figure}

As well as the static variations in the downstream phase along the pulse, there are also large differences in the phase jitter along the pulse. An example is shown in Figure~\ref{f:origJitterAlong}. The point by point upstream phase jitter along the pulse is quite flat at around 1 degree, slightly larger than the jitter on the mean. Conversely, the downstream phase jitter has large variations along the pulse. In some regions the downstream jitter is a factor 4 higher than the upstream phase jitter, whilst in others it is only 50\% higher.

\subsubsection{Consequences for the PFF System}

The differences between the mean upstream and downstream phase, both on the mean and along the pulse, need to be removed to enable phase jitters close to the CLIC target to be achieved with the PFF prototype at CTF3. Using Equation~\ref{e:theoretJitOptGain}, with the optimal PFF gain and \(0.34\pm0.06\) upstream--downstream phase correlation, an initial downstream phase jitter of \(1.86\pm0.09^\circ\) could be reduced to \(1.51\pm0.09^\circ\). This is only a modest improvement of around 20\%, and far from the CLIC target of \(0.2^\circ\) phase stability. %Also, the limitations of the actual PFF system, such as in the correction range (Section~\ref{ss:corrRange}), means that in reality even this 20\% reduction would be difficult to achieve.

Assuming the initial downstream phase jitter could be reduced to the same level as the upstream phase jitter, to \(0.8^\circ\), the upstream--downstream phase correlation required to theoretically achieve \(0.2^\circ\) corrected phase jitter is 97\%. This chapter will describe the procedures developed to achieve this level of downstream phase jitter and correlation. The first effect investigated was the energy dependence of the downstream phase, for the reasons described in Section~\ref{s:r56}.

\newsection{r56}{First Order Energy Dependences}

The transfer matrix coefficient \(R_{56}\) defines the phase shift between two points in the lattice resulting from a beam energy offset (Section~\ref{s:tl2OpticsReqs}). Due to issues with meeting all the optics constraints for the PFF system a non-zero \(R_{56}\) value had to be tolerated in the TL2 chicane (Section~\ref{s:matchedOptics}).  Therefore, a dependence of the downstream phase on the beam energy is expected, and this was the first place to look to try to understand and improve the poor upstream--downstream phase correlation and high downstream phase jitter.

\subsection{Beam Energy Variations}
\label{ss:energyVariations}

The best way to measure variations in the beam energy at CTF3 is via the beam position in one of the chicanes or rings, where the position after a bending magnet depends on the beam energy. The beam position offset, \(\Delta x\), in a BPM (beam position monitor) in these regions is linked to the relative energy offset, \(\Delta p / p\), as follows:
\begin{equation}
\frac{\Delta p}{p} = \frac{\Delta x}{D_x}
\label{e:dxToEn}
\end{equation}
where \(D_{x}\) is the dispersion at that location given by the machine optics. Regions where \(D_{x}\) is non-zero are referred to as dispersive regions.

With the beam setup used for the PFF system operation (bypassing the Frascati chicane and delay loop, see Figure~\ref{f:ctfLayout}) the first dispersive BPM after the CTF3 linac is the BPM CT.0608 in the transfer line TL1.  TL1 is introduced in more detail in Section~\ref{ss:tl1Optics}. The BPM CT.0608 is placed roughly 1~m after the first dipole magnet in TL1, with a horizontal dispersion of \(D_{x} = -0.61\)~m at this point according to the CTF3 MADX model. There are no quadrupoles or other elements between the dipole and CT.0608, which reduces the sensitivity of this dispersion value to any inaccuracies in the model. All quoted energy measurements in this chapter are obtained using the horizontal position in BPM CT.0608, converted in to the energy using the Equation~\ref{e:dxToEn}. %The only exception is Section~\ref{ss:corrPhaseEnergy}, as this includes measurements from an earlier setup where the stretching chicane was in use. A dispersive BPM in the stretching chicane, CT.0285, is used instead in that section but both BPMs give equivalent measured energies.

It should be noted that whilst this provides an accurate measurement of the relative energy jitter and variations along the pulse, it cannot be used to determine the absolute energy value. For example, the mean beam position in CT.0608 is non-zero due to device misalignments, and can change depending on the setup of CTF3. The mean position offset is subtracted in all cases so that the resulting energy values are centred around zero, although the actual mean energy offset may be non-zero. In certain simulations in this chapter non-zero mean energy offsets are used to improve the agreement with the data, as indicated.

\subsubsection{Mean Beam Energy}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/enJitter_mean}
  \caption{Example of variations in the mean beam energy (\(\Delta p/p\)) across 500 pulses, with a relative jitter of \(1.2\times 10^{-3}\).}
  \label{f:enJitter_mean}
\end{figure}

Figure~\ref{f:enJitter_mean} shows an example of variations in the mean beam energy on medium to long timescales at CTF3, in this case 500 pulses or roughly 10 minutes. Relative energy jitter on the mean is typically at the level of \(1 \times 10^{-3}\), and varies by roughly \(\pm50\%\) about this value. For shorter timescales, in datasets up to a couple of hundred pulses or a few minutes in length, the relative energy jitter is routinely closer to the \(0.5 \times 10^{-3}\) level (see Figure~\ref{f:r56Scan_upstreamParams}, for example). The main sources of drifts in the mean energy at CTF3 are variations in beam current and temperature dependent effects on the klystron phase and RF power feedback loops \cite{lukasIPAC16}. Recent improvements have demonstrated an energy stability better than \(1 \times 10^{-3}\) on longer timescales (see Section~\ref{ss:t566Mitigation}), which will aid future PFF tests.

\subsubsection{Energy Variations Along the Pulse}

The energy stability point-by-point along the pulse is at the same level as the mean energy stability, with relative jitter at, or slightly above, the \(1 \times 10^{-3}\) level, as seen in Figure~\ref{f:enJitter_along}. Typically the energy stability is slightly worse at the start and end of the pulse (due to transients, for example). In addition to the jitter there are also static variations in the energy along the pulse. Figure~\ref{f:enMeanAlong} shows one example of this. Variations in the mean energy along the pulse are normally several times larger than the energy jitter, at the level of 2---\(5\times 10^{-3}\) (peak-to-peak). New feedbacks have also been recently developed at CTF3 to reduce variations in energy along the pulse (Section~\ref{ss:t566Mitigation}).

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/enJitter_along}
  \caption{Example of relative energy jitter (\(\sigma_p\)) along the pulse. Each point is the rms energy variation at that point along the pulse across a dataset of 213 pulses.}
  \label{f:enJitter_along}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/enMeanAlong}
  \caption{Example of variations in energy (\(\Delta p/p\)) along the pulse, showing the mean taken across a dataset of 213 pulses.}
  \label{f:enMeanAlong}
\end{figure}



\subsection{Correlation between Phase and Energy}
\label{ss:corrPhaseEnergy}

Figure~\ref{f:corrDownstream_En} shows one example of the typical dependence of the mean downstream phase on the beam energy during the first PFF attempts. It's immediately clear that there is a strong relationship between the two, with a correlation in this case of \(0.82\pm0.03\). 

In contrast, in Figure~\ref{f:corrUpstream_En} there is almost no dependence of the upstream phase on the energy. However, the calculated correlation coefficient of \(0.19\pm0.06\) is statistically significant and this has consequences for the discussions in the remainder of this chapter. Normally the small upstream phase--energy correlation typically varies between 0 and 0.4 at CTF3 depending on the conditions, in particular the energy jitter, at that time. In certain setups there can also be high correlations between the upstream phase and energy (Section~\ref{ss:r56ScanWithEnergy}).

By itself having a high correlation between the downstream phase and the energy is not an issue for the PFF system. The problem is the difference between the upstream phase--energy correlation and the downstream phase--energy correlation, which leads to low correlation between the upstream and downstream phase. The high downstream phase jitter is also a problem for the PFF system due to its limited correction range, as previously mentioned.

The goal of this section is to determine whether the non-zero optics \(R_{56}\) value between the upstream and downstream phase monitors is sufficient to explain both the large amplification in downstream phase jitter and the low upstream--downstream phase correlation seen here. To start with, the effect of \(R_{56}\) on the downstream phase jitter and upstream--downstream phase correlation will be more formally defined.

\begin{figure}
  \centering
    \includegraphics[width=0.8\textwidth]{Figures/propagation/corrDownstreamEn}
  \caption{Dependence of the mean downstream phase on the beam energy (\(\Delta p/p\)).}
  \label{f:corrDownstream_En}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/corrUpstreamEn}
  \caption{Dependence of the mean upstream phase on the beam energy (\(\Delta p/p\)).}
  \label{f:corrUpstream_En}
\end{figure}

\subsection{R56}
\label{ss:r56Equations}

Assuming energy is the only source of differences between the upstream and downstream phase, the downstream phase, \(\phi_d\), can be expressed in terms of the optics transfer matrix coefficient, \(R_{56}\) (Section~\ref{s:opticsIntro}), as follows:
\begin{equation}
\phi_d = \phi_u + R_{56}\frac{\Delta p}{p}
\label{e:r56PhasEq}
\end{equation}
where \(\phi_u\) is the upstream phase, \(\Delta p / p\) is the relative energy offset and \(R_{56}\) is the matrix coefficient between the upstream and downstream phase monitors, defined by the machine optics. The units of \(R_{56}\) in the equation above are radians at 12~GHz per unit relative energy offset (\(\Delta p/p = 1\)). MADX uses units of metres and this value is what will be referred to in this chapter. To obtain the \(R_{56}\) value to use in the equation above the MADX value must be multiplied by the conversion factor \(2\pi/0.025\), where 0.025~m is the 12~GHz wavelength.

In terms of jitters Equation~\ref{e:r56PhasEq} becomes:
\begin{equation}
\sigma_d = \sqrt{\sigma_u^2 + R_{56}^2\sigma_{p}^2 + 2R_{56}\rho_{up}\sigma_{u}\sigma_{p}}
\label{e:r56JitEq}
\end{equation}
where \(\sigma_d\) is the downstream phase jitter, \(\sigma_u\) is the upstream phase jitter, \(\sigma_p\) is the relative energy jitter and \(\rho_{up}\) is the correlation between the upstream phase and the energy. This follows from the result of adding correlated variances. Clearly, any non-zero \(R_{56}\) between the upstream and downstream phase monitors introduces an additional energy component to the downstream phase that increases the downstream phase jitter.

The effect of \(R_{56}\) on the upstream-downstream phase correlation, \(\rho_{ud}\), can also be defined starting from the definition of the Pearson product-moment correlation coefficient:
\begin{equation}
\rho_{ud} = \frac{\mathrm{cov}\left[\phi_u,\phi_d\right]}{\sigma_u\sigma_d}
\qquad\mathrm{;}\qquad
\mathrm{cov}\left[\phi_u,\phi_d\right] = \frac{1}{N} \sum_{i=1}^{N}\phi_{ui}\phi_{di}
\label{e:r56CorrDef1}
\end{equation}
where \(\mathrm{cov}\left[\phi_u,\phi_d\right]\) is the covariance between the upstream and downstream phase, and the index \(i\) refers to the pulse number out of a dataset containing \(N\) beam pulses.
%\begin{equation}
% \mathrm{cov}\left[\phi_u,\phi_d\right] = \frac{1}{N} \sum_{i=1}^{N}%\phi_{ui}\phi_{di}
%\label{e:r56CorrDef2}
%\end{equation} 
By inserting the definition of the downstream phase from Equation~\ref{e:r56PhasEq} and separating the terms in the sum the covariance becomes:
\begin{equation}
\mathrm{cov}\left[\phi_u,\phi_d\right] = \frac{1}{N} \sum_{i=1}^{N}\phi_{ui}^{2} + R_{56}\frac{1}{N} \sum_{i=1}^{N}\phi_{ui}\frac{\Delta p_i}{p}
\label{e:r56CorrDef3}
\end{equation}
The first term is now the variance of the upstream phase, \(\sigma_u^2\), and the second term is \(R_{56}\) multiplied by the covariance between the upstream phase and the energy, \(\mathrm{cov}\left[\phi_u,\frac{\Delta p}{p}\right]\), which can be expressed in terms of the correlation between the upstream phase and the energy, \(\rho_{up}\):
\begin{equation}
\mathrm{cov}\left[\phi_u,\frac{\Delta p}{p}\right] = \rho_{up}\sigma_u\sigma_{p}
\label{e:r56CorrDef4}
\end{equation}
Therefore, Equation~\ref{e:r56CorrDef3} becomes:
\begin{equation}
\mathrm{cov}\left[\phi_u,\phi_d\right] = \sigma_u^2 + R_{56}\rho_{up}\sigma_u\sigma_p
\label{e:r56CorrDef5}
\end{equation}
Finally, substituting Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDef5} into Equation~\ref{e:r56CorrDef1} gives:
\begin{equation}
\rho_{ud} = \frac{\sigma_u + R_{56}\rho_{up}\sigma_p}{\sqrt{\sigma_u^2 + R_{56}^2\sigma_{p}^2 + 2R_{56}\rho_{up}\sigma_{u}\sigma_{p}}}
\label{e:r56CorrDefFinal}
\end{equation}

Considering that in this model the only difference between the upstream and downstream phase results from the \(R_{56}\), it is perhaps obvious that the best conditions for the PFF correction are obtained when the \(R_{56}\) coefficient between the upstream and downstream phase monitors is zero. In these conditions \(\sigma_d = \sigma_u\) and \(\rho_{ud} = 1\). This can be more formally defined by using the expression for the theoretical corrected downstream phase jitter when using the optimal gain factor as derived in Section~\ref{s:pffEquations}:
\begin{equation}
\sigma_{PFF} = \sigma_d\sqrt{1-\rho_{ud}^2}
\end{equation}
The initial downstream phase jitter and upstream-downstream phase correlation have been defined in terms of the \(R_{56}\) in Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDefFinal} above. Inserting them in to this equation gives the following expression for the corrected downstream phase jitter in terms of the \(R_{56}\):
\begin{equation}
\sigma_{PFF} = \left|R_{56}\right|\sigma_p\sqrt{1-\rho_{up}^2}
\label{e:r56PFFJit}
\end{equation}
As expected the achievable corrected downstream phase jitter is minimised when \(R_{56}~=~0\). Note that this equation does not take in to account that the minimum achievable downstream phase jitter is limited by the phase monitor resolution (Section~\ref{s:resolutionEqs}).

In principle, the beam conditions for the PFF correction can also be improved by reducing the relative energy jitter (\(\sigma_p\)) or by increasing the upstream phase-energy correlation (\(\rho_{up}\)). Reducing the relative energy jitter decreases the additional phase jitter created by non-zero \(R_{56}\). Increasing the upstream phase-energy correlation (\(\rho_{up}\)) reduces the effect that non-zero \(R_{56}\) has on the upstream-downstream phase correlation (\(\rho_{ud}\)), as the additional energy dependent downstream phase jitter is correlated with the upstream phase in this case. 
%For example, if \(\rho_{up}=1\) the source of all upstream phase jitter is energy jitter. In that case although non-zero \(R_{56}\) would further increase the downstream phase jitter, the additional jitter would be well correlated with the upstream phase and the upstream-downstream phase correlation would not be affected. 
In practice \(\sigma_p\) and \(\rho_{up}\) are defined by the CTF3 injector and can not be varied with a great degree of flexibility, so having zero \(R_{56}\) is the only way to obtain ideal conditions for the PFF correction. However, recent improvements at CTF3 have reduced the relative energy jitter, as discussed later in Section~\ref{ss:t566Mitigation}. High upstream phase-energy correlations can also be created at CTF3 but not without greatly amplifying the upstream phase jitter, which causes issues for the PFF system due to its limited correction range (Section~\ref{ss:corrRange}).

An interesting consequence of Equations~\ref{e:r56JitEq}~and~\ref{e:r56PFFJit} is that the best beam conditions for the PFF correction are not given by minimising the initial downstream phase jitter in the case where the upstream phase-energy correlation, \(\rho_{up}\), is non-zero. As seen in Section~\ref{ss:corrPhaseEnergy} in normal conditions there is a small correlation between the upstream phase and the energy at CTF3, typically around \(\rho_{up}=0.2\). In these conditions the downstream phase jitter can in theory be reduced to below the level of the upstream phase jitter by using optics with negative \(R_{56}\) between the upstream and downstream phase monitors. This then removes the energy component present upstream from the downstream phase. Differentiating Equation~\ref{e:r56JitEq} gives the minimum downstream phase jitter to be obtained when \(R_{56} = -\rho_{up}\sigma_u/\sigma_p\). However, using this \(R_{56}\) value would degrade the upstream-downstream phase correlation and increase the achievable corrected downstream jitter, which is always minimised when \(R_{56} = 0\) as in Equation~\ref{e:r56PFFJit}. The phase propagation optimisations in this chapter must therefore be focused on zeroing the \(R_{56}\) value between the upstream and downstream phase monitors, rather than minimising the initial downstream phase jitter. 
%This is significant for the \(R_{56}\) optimisation attempts presented later in this chapter, as it must always be kept in mind that the goal is to maximise the upstream-downstream phase correlation rather than to create the most stable downstream phase (with the PFF system off).

\subsection{Effect of R56 in TL2}
\label{ss:r56TL2Effect}


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/jitVsR56}
  \caption{Initial (blue) and corrected (red) downstream phase jitter (\(\sigma_d\)) vs. the \(R_{56}\) coefficient between the upstream and downstream phase monitors. The horizontal black line shows the CLIC target of 0.2~degrees corrected downstream phase jitter.}
  \label{f:jitVsR56}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/corrVsR56}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) vs. the \(R_{56}\) coefficient between the upstream and downstream phase monitors. The horizontal black line shows the 97\% correlation needed to achieve 0.2~degrees corrected phase jitter at CTF3.}
  \label{f:corrVsR56}
\end{figure}

%Unfortunately, it was not possible to find optics for the TL2 chicane that met all the PFF requirements and thus an \(R_{56}\) in the chicane of close to -0.2~m had to be accepeted (Section~\ref{ss:tl2PFFOptics}). 
The PFF optics have an \(R_{56}\) value of close to \(-0.2\)~m between the entrance and exit of the TL2 horizontal chicane (Section~\ref{ss:tl2PFFOptics}).
All the other sections of CTF3 between the upstream and downstream phase monitors (CT~line, TL1, combiner ring and TBL, see Figure~\ref{f:ctfLayout}) nominally have zero \(R_{56}\) \cite{CTF3}. Therefore they don't introduce additional phase jitter via energy, at least to first order and to within the accuracy of the CTF3 MADX model. The overall \(R_{56}\) between the upstream phase monitors (in the CT line) and the downstream phase monitors (in the TBL line, labelled CB, after the TL2 chicane) is therefore -0.2~m also. Whether this can explain the low upstream-downstream phase correlation and high downstream phase jitter seen in Section~\ref{s:origJitter}, as well as what residual \(R_{56}\) between the two monitors can be tolerated to be able to achieve CLIC-level phase stability at CTF3, is discussed in this section.

Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDefFinal} can be used to estimate the downstream phase jitter and upstream-downstream phase correlation in the conditions at CTF3. Typical values for the various parameters in the equations have already been presented in previous sections, and these values are summarised in Table~\ref{t:r56Params}. The value \(R_{56}\simeq -0.2\)~m was obtained in Section~\ref{ss:tl2PFFOptics} as previously mentioned, the value \(\sigma_u\simeq0.8^\circ\) in Section~\ref{s:origJitter} and the values \(\rho_{up}\simeq 0.2\) and \(\sigma_p\simeq 0.001\) in Section~\ref{ss:corrPhaseEnergy}.

\begin{table}
  \begin{center}
    \begin{tabular}{| c c |}
	   \hline
       Parameter & Value \\ \hline
       \(R_{56}\) & -0.2~m \\
       \(\sigma_u\) & \(0.8^\circ\) \\
       \(\rho_{up}\) & 0.2 \\
       \(\sigma_{p}\) & 0.001 \\ \hline
    \end{tabular}
    \caption{Typical beam and optics conditions at CTF3 relating to the energy and upstream phase stability.}
  	\label{t:r56Params}
  \end{center}
\end{table}




\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/corrVsR56_CTENCorr}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) vs. the \(R_{56}\) coefficient between the upstream and downstream phase monitors for different upstream phase-energy correlations: \(\rho_{up}=0.0\) (blue), \(\rho_{up}=0.2\) (black), \(\rho_{up}=0.4\) (green) and \(\rho_{up}=0.9\) (red).}
  \label{f:corrVsR56_CTENCorr}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/jitVsR56_90ctencorr}
  \caption{Initial (blue) and corrected (red) downstream phase jitter (\(\sigma_d\)) vs. the \(R_{56}\) coefficient between the upstream and downstream phase monitors with 90\% correlation between the upstream phase and the beam energy.}
  \label{f:jitVsR56_90ctencorr}
\end{figure}

With these parameter values Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDefFinal} predict that a residual \(R_{56}\) of -0.2~m between the upstream and downstream phase monitors will reduce the upstream-downstream phase correlation to below 10\%. The downstream phase jitter is amplified to above 3~degrees. Therefore, the effects of \(R_{56}\) alone can explain the low upstream-downstream phase correlation and high downstream phase jitter seen in Section~\ref{s:origJitter}. In order to increase the upstream-downstream phase correlation to 97\% and reduce the downstream jitter to 0.8~degrees (the conditions needed to achieve 0.2~degrees corrected downstream phase jitter at CTF3) the \(R_{56}\) between the upstream and downstream phase monitors must be removed.

Figures~\ref{f:jitVsR56}~and~\ref{f:corrVsR56} show the expected downstream phase jitter and upstream-downstream phase correlation for residual \(R_{56}\) values from -0.2 to +0.2~m between the upstream and downstream phase monitors, again using Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDefFinal}. The theoretical corrected downstream phase jitter using the PFF system across the range of \(R_{56}\) values is also shown. In order to obtain CLIC level phase stability at CTF3 the residual \(R_{56}\) between the upstream and downstream phase monitors must be reduced from the initial \(-0.2\)~m to \(0\pm1.3\)~cm. Also note the slight asymmetry in the phase jitter and correlation curves, which is caused by the non-zero correlation between the upstream phase and the beam energy. 


To interpret the results of \(R_{56}\) optimisation attempts (Sections~\ref{s:r56Removal}~and~\ref{s:t566}) it is useful to understand how varying the correlation between the upstream phase and the energy impacts the phase propagation. 
%In particular, in Section~\ref{ss:r56ScanWithEnergy} a machine setup that increases \(\rho_{up}\) to 90\% is used. 
Figure~\ref{f:corrVsR56_CTENCorr} shows how the upstream-downstream phase correlation varies with upstream phase-energy correlations of between 0\% and 40\% (the range typical of normal operation), as well as with a higher correlation of 90\%. With high upstream phase-energy correlations there is no longer a well defined peak in the upstream-downstream phase correlation versus the \(R_{56}\) value. Instead there is an almost constant high upstream-downstream phase correlation with positive \(R_{56}\) values, and a large anti-correlation for negative \(R_{56}\) values. %(as in this case the residual \(R_{56}\) acts to flip the sign of the phase jitter). 
In Figure~\ref{f:jitVsR56_90ctencorr} plotting the theoretical downstream jitter with \(\rho_{up} = 0.9\) gives a clear demonstration that the best conditions for the PFF correction are always with \(R_{56} = 0\), rather than with the lowest possible initial downstream jitter, as mentioned in Section~\ref{ss:r56Equations}. %In fact, as these conditions relax the requirements on the residual \(R_{56}\) needed to achieve high upstream-downstream phase correlations (as seen in the previous figure) it may be easier to achieve a large factor reduction in the downstream phase jitter with the PFF system with a high \(\rho_{up}\) machine setup. This has been attempted and is presented in Section~\ref{s:pffNovelSetups}.

\afterpage{\begin{landscape}
	\begin{figure}
  		\centering
  		\includegraphics[height=0.8\textwidth]{Figures/propagation/TL1}
  		\caption{Layout of dipoles (labels starting with BH, red), quadrupoles (labels starting with QF or QD, black), BPMs (labels starting with BPM or BPI, blue), correctors (labels starting with DH or DV, green) in the TL1 transfer line \cite{tl1Layout}.}
  		\label{f:tl1Layout}
	\end{figure}
\end{landscape}}







\newsection{r56Removal}{Mitigation of First Order Energy Dependence}

The discussion in Section~\ref{ss:r56TL2Effect} proves that with a residual \(R_{56}\) value of -0.2~m between the upstream and downstream phase monitors it is impossible to achieve the goals of the PFF prototype at CTF3. However, due to the highly constrained optics in TL2 it has already been seen in Chapter~\ref{c:tl2Optics} that it was not possible to find optics for the PFF chicane that yield zero \(R_{56}\) whilst also meeting requirements for both the PFF system and transverse matching. The only way to create a total \(R_{56}\) of zero between the upstream and downstream phase monitors is therefore to add positive \(R_{56}\) to one of the other beam lines in-between the two monitors in order to compensate for the negative \(R_{56}\) in the TL2 chicane. 

New optics for the transfer line TL1 with positive \(R_{56}\) values have been created to achieve this.
TL1 transports the beam from the CT line (where the upstream phase monitors are installed) to the combiner ring, as seen in Figure~\ref{f:ctfLayout}. 
The layout of the TL1 transfer line is shown in Figure~\ref{f:tl1Layout}. It consists of: 4 dipoles (bending the beam horizontally) of 2 different types, 13 quadrupoles of 5 different types, 7 magnetic correctors, 1 sextupole (usually not used) and 8 BPMs \cite{tl1Design} (the dispersive BPM after the first dipole in TL1, labelled CT.BPI0608, is the device that has been used to determine correlations between the phase and energy in this chapter). The total length of TL1 is approximately 30~m.

%Preliminary attempts to reduce the residual \(R_{56}\) between the upstream and downstream phase monitors using TL1 yielded correlations up to 60\% and reduced the downstream phase jitter to \(2^\circ\). Conditions similar to these were used for the first PFF tests (Chapter~\ref{c:earlyFFSim}) before the energy related effects discussed in this chapter were fully characterised, but in these tests only a modest reduction of 30\% in downstream phase jitter was possible due to the limitations of the phase propagation shown here. At this time only a few different optics for TL1 were available in \(R_{56}\) steps of 10~cm. As the total residual \(R_{56}\) must be reduced to the centimetre level to make a correction down to 0.2 degrees jitter theoretically possible with the PFF system, new sets of optics for TL1 were required.



\subsection{Matched Optics for TL1}
\label{ss:tl1Optics}

Although in theory only one set of optics with \(R_{56} = +0.2\)~m in TL1 is required to compensate for the \(R_{56} = -0.2\)~m in TL2, in practice errors in the MADX model of CTF3 in addition to the effect of higher order energy dependences (see Section~\ref{s:t566}) mean it is not possible to know precisely what the optimal \(R_{56}\) in TL1 will be, and it is also possible that this value will vary with time. To determine the optimal value it is also useful to scan the \(R_{56}\) value in TL1 across a wide range of values.% and then fit the maximum resulting upstream-downstream phase correlation.
To allow this, MADX has been used to match optics for TL1 with \(R_{56}\) values ranging from -0.3~m to +0.6~m in steps of 0.5~cm (a total of 181 sets of optics). The optimal \(R_{56}\) value should always be guaranteed to be in this range, and the step size of 0.5~cm allows the residual \(R_{56}\) to be zeroed to within one centimetre as derived to be necessary in Section~\ref{ss:r56TL2Effect}. 

\begin{table}
  \begin{center}
    \begin{tabular}{| c c c |}
	   \hline
       Parameter & TL1 Injection & CR Injection \\ \hline
       \(\beta_x\) & 8.81~m & 4.08~m \\
       \(\beta_y\) & 13.94~m & 5.41~m \\
       \(\alpha_x\) & -0.74 & -0.31 \\
       \(\alpha_y\) & -0.45 & -0.21 \\ 
       \(D_x\) & 0~m & -0.03~m \\ 
       \(D_{px}\) & 0 & 0.02 \\ \hline
    \end{tabular}
    \caption{Initial and final conditions for optics matching in TL1.}
  	\label{t:tl1MatchParams}
  \end{center}
\end{table}
\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56MatchedVsTarget}
  \caption{Matched \(R_{56}\) values in TL1 for the new sets of TL1 optics.}
  \label{f:r56MatchedVsTarget}
\end{figure}




As well as the different \(R_{56}\) values, each set of optics must maintain the same initial and final conditions, so that the injection of the beam in to the combiner ring is not affected. Values for the beta functions, alphas and dispersion at the start of TL1 and at the combiner ring injection are summarised in Table~\ref{t:tl1MatchParams}. As well as the initial and final conditions, the maximum beta functions and dispersion in TL1 are constrained to ensure a reasonable beam size throughout the line --- the horizontal and vertical beta function is limited to a maximum of 35~m, and the horizontal dispersion to a maximum absolute value of 1.25~m. Around the septum used for injection in to the combiner ring the horizontal beta function is further limited to a maximum of 10~m. The strengths of the 13 quadrupoles in TL1 are varied to meet all these constraints.


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/CTQFG0750}
  \caption{Strength (power supply current) of the CT.QFG0750 quadrupole in TL1 vs. the \(R_{56}\) value in TL1 for each set of matched optics.}
  \label{f:CTQFG0750}
\end{figure}

Figure~\ref{f:r56MatchedVsTarget} shows the matched \(R_{56}\) value in TL1 across the range of targeted values. Each matched \(R_{56}\) value is within 10 microns of the desired result. Furthermore, Figure~\ref{f:CTQFG0750}  shows an example of how the strength of one of the quadrupoles must be varied in order to achieve each \(R_{56}\) value. If the dependence of each quadrupole strength on the \(R_{56}\) value was continuous the relationship could be fitted to create a set of tuning knobs to allow \(R_{56}\) to be set to any arbitrary value in TL1. However, as seen in Figure~\ref{f:CTQFG0750} there are many discontinuities. The quadrupole strengths for each set of optics are therefore saved to a lookup table, with a MatLab function created to read the table and set the quadrupole currents in the machine appropriate for the specified \(R_{56}\) value. As already mentioned 0.5~cm precision in \(R_{56}\) should be adequate for the PFF requirements, but the discontinuities mean new optics would have to be matched if optics with an \(R_{56}\) value not included in the discrete set used here were required.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/BETX}
  \caption{Horizontal beta function in each set of optics for TL1, with the colour scale indicating the \(R_{56}\) value in TL1 for that optics.}
  \label{f:tl1BETX}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/BETY}
  \caption{Vertical beta function in each set of optics for TL1, with the colour scale indicating the \(R_{56}\) value in TL1 for that optics.}
  \label{f:tl1BETY}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/DX}
  \caption{Horizontal dispersion in each set of optics for TL1, with the colour scale indicating the \(R_{56}\) value in TL1 for that optics.}
  \label{f:tl1DX}
\end{figure}

For reference Figures~\ref{f:tl1BETX},~\ref{f:tl1BETY},~and~\ref{f:tl1DX} show how the horizontal and vertical beta functions and horizontal dispersion changes in TL1 for each set of optics. For all \(R_{56}\) values each parameter converges to the same value at the start and end of TL1, as needed to ensure that changing the optics does not impact injection in to the combiner ring. The maximum horizontal and vertical beta functions in TL1 roughly increase with the set \(R_{56}\) value, but in all cases are kept below the set limit of 35~m in the matching procedure. The dispersion pattern in TL1 also changes with the set \(R_{56}\) value, though in most cases the maximum absolute dispersion is around 1~m and only the location of the peak dispersion along the line changes. Again, for each set of optics the maximum absolute dispersion is limited within the set constraint of 1.25~m. 


Commissioning of the new TL1 optics in CTF3 was straightforward and in general they can be set with the quadrupole strengths at their nominal matched values without causing issues for the beam quality \cite{piotrPriv}. At the extremities of the range of optics (close to \(R_{56}\) = -0.1~m and \(R_{56}\) = +0.6~m) some slight beam losses do begin to occur, but this is not a problem for PFF operation where the required \(R_{56}\) is only 0.2~m. However, for each set of optics the magnetic correctors in TL1 may need to be changed to recover the nominal beam orbit, thus taking in to account slight misalignments in elements along the line.

\subsection{Scans of R56 in TL1}
\label{ss:r56Scans}

The sets of matched optics from Section~\ref{ss:tl1Optics} can be used to perform scans of the \(R_{56}\) value in TL1 and then observe the effect on the downstream phase. Scans of this type must be performed prior to all PFF data taking periods in order to optimise the beam conditions (maximise the upstream-downstream phase correlation) for the correction. More recently scans of \(R_{56}\) in TL1 have been performed whilst varying the beam energy, which produces cleaner results and highlights additional factors that must be taken in to account during the optimisation process, as will be shown in Section~\ref{s:t566}. 

As a starting point the simplest case, where only the TL1 optics is changed during the scan and all other parameters in the machine are left unchanged, is presented in this section. This also highlights some of the difficulties in maintaining beam conditions at CTF3, which is discussed further in Section~\ref{s:t566} and in the context of the PFF correction in Section~\ref{s:longPFF}. Figures~\ref{f:r56Scan_meanPhaseJit}~and~\ref{f:r56Scan_correlation} show one example of an \(R_{56}\) scan performed across a wide range -- from -0.1~m to +0.6~m in TL1. The \(R_{56}\) is incremented by 2.5~cm between datasets (29 \(R_{56}\) values in the scan), with the whole scan taking approximately an hour and a half to complete. With the knowledge gained from measurements of this type it is no longer necessary to scan the \(R_{56}\) across the full range to determine the ideal value, thus the optimisation of the phase propagation for PFF attempts can now be achieved on much shorter time scales.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan_meanPhaseJit}
  \caption{Phase jitter upstream (blue) and downstream (red) during a scan of \(R_{56}\) in TL1. The dashed line shows a simulation of the expected downstream phase jitter given the beam conditions in each dataset. Standard error bars on the measured jitters are shown.}
  \label{f:r56Scan_meanPhaseJit}

  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan_correlation}
  \caption{Upstream-downstream phase correlation (red) during a scan of \(R_{56}\) in TL1. The dashed line shows a simulation of the expected correlation given the beam conditions in each dataset. Error bars show the standard error on the correlation coefficients.}
  \label{f:r56Scan_correlation}
\end{figure}


\subsubsection{Mean Phase}

Only the mean phase jitters and correlation will be considered here, features along the pulse are discussed in Section~\ref{ss:r56ScanWithEnergy} for a different scan. Figure~\ref{f:r56Scan_meanPhaseJit} shows the upstream and downstream mean phase jitter during the scan. The downstream phase jitter is reduced from above 2.5 degrees with zero \(R_{56}\) in TL1, to below 1 degree and close to the level of the upstream phase jitter by adding positive \(R_{56}\) in TL1. The optimal \(R_{56}\) value is approximately 0.175~m, in close agreement with expectations considering the -0.2~m \(R_{56}\) in TL2. The upstream-downstream phase correlation, in Figure~\ref{f:r56Scan_correlation}, is also maximised at this point, from an initial correlation of 20\% with zero \(R_{56}\) to up to 80\%. In terms of the PFF system, increasing the upstream-downstream phase correlation from 20\% to 80\% improves the theoretical correction from a 2\% reduction in downstream phase jitter to a 40\% decrease (Equation~\ref{e:theoretJitOptGain}).


\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{Figures/propagation/r56Scan_upstreamParams}
  \caption{Upstream and downstream beam conditions during the \(R_{56}\) scan. From top to bottom: upstream phase-energy correlation (blue), relative energy jitter (red), upstream phase jitter (green) and beam current jitter (black). Error bars show standard errors.}
  \label{f:r56Scan_upstreamParams}
\end{figure}

As the upstream phase monitors are prior to TL1, changing the TL1 optics has no effect on the upstream phase jitter. All differences in the upstream phase jitter between datasets are caused by drifts in the CTF3 injector, typically changes in either klystron phases or beam current. Although the overall stability of the upstream phase jitter during this scan is good, it does vary between 0.5~degrees and 1.2~degrees. In addition to the upstream phase there are also differences in the relative energy jitter and upstream phase-energy correlation during the scan, as seen in Figure~\ref{f:r56Scan_upstreamParams}. The relative beam energy jitter varies between \(0.4\times10^{-3}\) and \(1.0\times10^{-3}\) and the upstream phase-energy correlation between -0.5 and +0.5. All these parameters influence the downstream phase, as per the equations in Section~\ref{ss:r56Equations}.

Differences in the phase jitter and phase--energy correlation between datasets partially explain the deviation of individual data points away from the pure dependence on \(R_{56}\) seen in Figures~\ref{f:jitVsR56}~and~\ref{f:corrVsR56} for stable conditions. The simulated lines in Figures~\ref{f:r56Scan_meanPhaseJit}~and~\ref{f:r56Scan_correlation} represent the expected downstream phase jitter and upstream-downstream phase correlation taking in to account the upstream phase jitter, relative energy jitter and upstream phase-energy correlation for each point in the scan (using Equations~\ref{e:r56JitEq}~and~\ref{e:r56CorrDefFinal}). The simulated upstream-downstream phase correlation in Figure~\ref{f:r56Scan_correlation} has been scaled so that the peak value is in agreement with the data, at 0.8. The majority of the data points follow the scaled simulated distribution, with several remaining outliers. For the downstream phase jitter (which uses the simulated result directly with no scaling) the agreement with the simulation is generally good for \(R_{56}\) values below 0.3~m. However, above 0.3~m the actual phase jitter seen in the scan is smaller than the simulation. One possible explanation for this is changes in the downstream beam current stability between datasets, which varies by a factor 3 during the scan (bottom plot in Figure~\ref{f:r56Scan_upstreamParams}). Small beam losses between measurements may change the phase jitter in a way that is not characterised by the \(R_{56}\). Possible other sources are discussed in Sections~\ref{s:t566}~and~\ref{s:otherJitterSources}.


\subsubsection{Results from Other Scans}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan2_meanJitter}
  \caption{Upstream (blue) and downstream (red) phase jitter during an \(R_{56}\) scan, showing an optimal set point of around \(R_{56}=0.1\)~m in TL1. Standard error bars on the measured jitter values are shown.}
  \label{f:r56Scan2_meanJitter}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan3_meanJitter}
  \caption{Upstream (blue) and downstream (red) phase jitter during an \(R_{56}\) scan, showing an optimal set point of \(R_{56}<0.05\)~m in TL1. Standard error bars on the measured jitter values are shown.}
  \label{f:r56Scan3_meanJitter}
\end{figure}


Figures~\ref{f:r56Scan2_meanJitter}~and~\ref{f:r56Scan3_meanJitter} show the results of two further scans of \(R_{56}\) in TL1, both taken a few days after the scan previously shown (Figures~\ref{f:r56Scan_meanPhaseJit}--\ref{f:r56Scan_upstreamParams}). For both scans the mean downstream phase jitter can again be decreased to the level of the upstream phase jitter by varying the \(R_{56}\) in TL1, and the upstream-downstream correlation increased to 80\%. However, the optimal optics is different for each scan --- the scan in Figure~\ref{f:r56Scan2_meanJitter} has an optimal \(R_{56}\) value of around 0.1~m, whereas for the scan in Figure~\ref{f:r56Scan3_meanJitter} it is below 0.05~m. Both values are also different to the scan previously shown, which had an optimal \(R_{56}\) setting of 0.175~m.

With \(R_{56}\) alone and the model of the phase propagation used to derive the equations in Section~\ref{ss:r56Equations} there is no mechanism for the optimal \(R_{56}\) value to vary with time. The best conditions for the phase propagation should always be provided with zero residual \(R_{56}\) between the upstream and downstream phase monitors. As the optics in all beam lines between the upstream and downstream phase monitors (apart from TL1) were unchanged between each scan, the optimal \(R_{56}\) value in TL1 should also be the same for each scan in this model, under the assumption that \(R_{56}\) explains all differences between the upstream and downstream phase. The most likely explanation is a sensitivity to higher order energy dependences, as discussed in Section~\ref{s:t566}.

\newsection{t566}{Higher Order Energy Dependences}

In the same way the first order optics dependences are described by the \(6 \times 6\) R-matrix, the second order effects are described using a three dimensional \(6 \times 6 \times 6\) T-matrix. \linebreak \(R_{56}\) is the relevant first order transfer matrix coefficient for the energy related effects on the phase propagation, as already discussed, and the relevant T-matrix coefficient for second order energy dependences is \(T_{566}\). By including the second order term the dependence of the downstream phase on the energy from Equation~\ref{e:r56PhasEq} becomes:
\begin{equation}
\phi_d = \phi_u + R_{56}\left(\frac{\Delta p}{p}\right) + T_{566}\left(\frac{\Delta p}{p}\right)^2
\label{e:t566}
\end{equation}

\(T_{566}\) introduces another source of energy dependent phase jitter which is independent from the first order \(R_{56}\) value. The ideal case for the phase propagation would be to have both zero \(R_{56}\) and zero \(T_{566}\) between the upstream and downstream phase monitors. However, constraints are not placed on the \(T_{566}\) in the optics at CTF3 and it is therefore typically non-zero. It may be possible to create optics with zero, or at least reduced, \(T_{566}\) for the TL1 and TL2 lines at CTF3 in the future by using the available sextupoles, but this has not yet been pursued, thus it will be treated as a fixed property of the optics here. Assuming constant, non-zero, \(T_{566}\) an expression for the \(R_{56}\) value that minimises the downstream phase-energy dependence can be derived:
\begin{equation}
R_{56} = -2T_{566} \left(\frac{\Delta p}{p}\right)
\label{e:r56t566dep}
\end{equation}
This is obtained by zeroing the derivative of Equation~\ref{e:t566} with respect to \(\Delta p/p\).

The above dependence of the \(R_{56}\) value on the beam energy offset has many consequences. Firstly, it provides a mechanism by which the apparent optimal \(R_{56}\) value in TL1 can appear to vary with time (and be non-zero), as was seen comparing the results of different \(R_{56}\) scans in the previous section. CTF3 does experience drifts in beam energy (see Section~\ref{ss:longFF_beamConds}, for example), creating small differences between the actual beam energy and the energy that the optics have been set for (i.e. the strength of bending and focusing elements in the accelerator). In other words, it is possible for the mean of \(\Delta p / p\) to be non-zero. The optimal \(R_{56}\) value to use in TL1 is then expected to drift with the beam energy when higher order phase-energy dependences are included.

In addition, energy variations along the beam pulse and jitter in the beam energy mean that the phase propagation cannot be perfectly optimised by varying the \(R_{56}\) alone. Due to the energy dependence in Equation~\ref{e:r56t566dep}, any energy variations along the pulse cause the optimal \(R_{56}\) value to set in TL1 to also vary along the beam pulse. There are static variations in the mean energy along the pulse (e.g. as seen in Section~\ref{ss:energyVariations}) at CTF3, so this means the phase propagation can never be completely optimised along the full pulse length when \(T_{566}\) is non-zero. 

\subsection{Simulated Effect of \(T_{566}\) on the Downstream Phase}
\label{ss:t566Sim}

When only the first order effect of \(R_{56}\) is considered, the dependence of the downstream phase on the energy is linear, with the gradient depending on the residual \(R_{56}\) value between the upstream and downstream phase monitors. The downstream phase versus beam energy offset with only the first order \(R_{56}\) term included is shown in Figure~\ref{f:phaseVsEn_r56Only} for each set of TL1 optics, demonstrating this effect. With only the first order term the optimal \(R_{56}\) optics in TL1 remove the downstream phase-energy dependence for all energy offsets.
%The optimal \(R_{56}\) value of \(+0.2\)~m in TL1 minimises the phase-energy dependence for all energy offsets.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/phaseVsEn_r56Only}
  \caption{Dependence of the downstream phase on the relative energy offset for all sets of TL1 optics when only \(R_{56}\) is considered.}
  \label{f:phaseVsEn_r56Only}  
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/phaseVsEn_t566}
  \caption{Dependence of the downstream phase on the relative energy offset for all sets of TL1 optics including higher order effects.}
  \label{f:phaseVsEn_t566}
\end{figure}

By varying the initial energy offset in MADX the expected effect of the higher order energy dependences on the downstream phase can be seen. Figure~\ref{f:phaseVsEn_t566} shows the impact of the higher orders. The optimal \(R_{56}\) to use in TL1, where the phase has the minimal dependence on the energy, now depends on the energy offset. Figure~\ref{f:optR56vsEnergy} shows that the dependence of the optimal \(R_{56}\) value on the relative energy offset is linear, as expected from Equation~\ref{e:r56t566dep}. The plotted \(R_{56}\) value does not exceed \(+0.6\)~m or go below \(-0.3\)~m as only the available sets of optics for TL1 are considered, which are restricted to this range. %This also creates small non-linearities in the central region of the plot, although there is also a contribution from effects above second order. 

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/optR56vsEnergy}
  \caption{Dependence of the optimal optics to use in TL1 on the relative energy offset.}
  \label{f:optR56vsEnergy}
\end{figure}


MADX does not output the optics \(T_{566}\) coefficient directly but it can be approximated using a quadratic fit to the downstream phase vs. energy curves seen in Figure~\ref{f:phaseVsEn_t566}. The fit coefficients then give the \(T_{566}\) and \(R_{56}\) values, as per Equation~\ref{e:t566}. An example of this is shown in Figure~\ref{f:madxT566Fit} for the nominal \(R_{56}=0\)~m optics in TL1, with fitted coefficients of \(R_{56}=-0.2\)~m and \(T_{566}=-13.7\)~m in this case. As the results from MADX also include effects above second order there is a slight discrepancy between the quadratic fit and the MADX output. However, including up to the second order energy dependence is enough to characterise the true behaviour and the slight modifications induced by higher orders are beyond the scope of the discussion here.


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/madxT566Fit}
  \caption{Quadratic fit (red) to the simulated downstream phase from MADX (blue), which includes effects above second order, for different energy offsets. The nominal \(R_{56}=0\)~m optics is used in TL1.}
  \label{f:madxT566Fit}

  \includegraphics[width=0.8\textwidth]{Figures/propagation/t566TotVsr56TL1}
  \caption{\(T_{566}\) coefficient between the upstream and downstream phase monitors for all sets of TL1 optics.}
  \label{f:t566TotVsr56TL1}
\end{figure}


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/jitVsR56_t566}
  \caption{Downstream phase jitter (\(\sigma_d\)) vs. \(R_{56}\) between the upstream and downstream phase monitors. Blue lines include the effects of both \(R_{56}\) and \(T_{566}\), whereas red lines include only the first order \(R_{56}\) term. Solid lines show the initial downstream jitter, and dashed lines the achievable corrected downstream phase jitter. Beam conditions of \(\sigma_u = 0.8^\circ\), \(\rho_{up}=0.2\) and \(\sigma_p = 1 \times 10^{-3}\) are used for the simulation.}
  \label{f:jitVsR56_t566}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/corrVsR56_t566}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) vs. \(R_{56}\) between the upstream and downstream phase monitors. The blue line includes the effects of both \(R_{56}\) and \(T_{566}\), whereas the red line includes only the first order \(R_{56}\) term.  Beam conditions of \(\sigma_u = 0.8^\circ\), \(\rho_{up}=0.2\) and \(\sigma_p = 1 \times 10^{-3}\) are used for the simulation.}
  \label{f:corrVsR56_t566}
\end{figure}


Figure~\ref{f:t566TotVsr56TL1} shows the fitted \(T_{566}\) coefficient for all the sets of matched optics in TL1. The changes in \(T_{566}\) across the range of TL1 optics are much smaller than the (intentional) differences in \(R_{56}\), varying between -13.1~m and -15.4~m. Optics around the usually optimal \(R_{56}\) value of 0.2~m in TL1  are close to where the second order effects are minimal, with \(T_{566}\) values around -13.4~m. The \(T_{566}\) coefficients are approximately two orders of magnitude larger than the \(R_{56}\) but as \(\left(\Delta p / p\right)^2 << \left(\Delta p / p\right) << 1\) the effect on the phase is smaller than for non-optimised \(R_{56}\). For example, for a typical relative energy offset of \(1 \times 10^{-3}\) a residual \(R_{56}\) of 0.2~m between the upstream and downstream phase monitors leads to a phase shift of more than one degree. For the same energy offset the phase shift resulting from the second order \(T_{566}\) term is approximately 0.1 degrees. However, the key point for the phase propagation is that the first order dependence can be removed by zeroing \(R_{56}\) between the upstream and downstream phase monitors, whereas for all the available sets of optics the second order contribution will remain at roughly the same magnitude.


To determine the consequences of the \(T_{566}\) for the PFF system, the effect it has on the upstream-downstream phase correlation and downstream phase jitter must be calculated. This was done analytically using the equations in Section~\ref{ss:r56Equations} for the first order \(R_{56}\), but for the second order terms a simple Monte Carlo simulation approach has been used. Correlated random distributions are created in MatLab to match the typical CTF3 upstream phase and energy conditions --- namely \(\sigma_p = 0.001\), \(\sigma_u = 0.8^\circ\) and \(\rho_{up} = 0.2\). The simulated downstream phase for each set of TL1 optics is then calculated using Equation~\ref{e:t566} and the known \(R_{56}\) and \(T_{566}\) values. The jitter of this simulated downstream phase and its correlation with the initial upstream phase distribution give the values shown in the following figures.

Figure~\ref{f:jitVsR56_t566} shows the downstream phase jitter versus the residual \(R_{56}\) between the upstream and downstream phase monitors in the case where only the first order \(R_{56}\) term is included and when both the \(R_{56}\) and the second order \(T_{566}\) are included. The effect of including \(T_{566}\) is very small, with the downstream phase jitter only increasing from \(0.80^\circ\) to \(0.85^\circ\) degrees at the optimal residual \(R_{56}\) of zero. The effect of including \(T_{566}\) on the upstream-downstream phase correlation is much more significant for the PFF correction. The maximum achievable correlation (excluding the effects of the phase monitor resolution) is reduced from \(\rho_{ud} = 1\) with only the first order term to \(\rho_{ud} = 0.95\) when \(T_{566}\) is included. This is shown in Figure~\ref{f:corrVsR56_t566}.  The achievable corrected downstream phase jitter with the PFF system is increased from zero to \(0.27^\circ\) (again excluding the phase monitor resolution). 


With the initial conditions and optics used here it would therefore be impossible to achieve \(0.2^\circ\) phase stability at CTF3. However, the relative energy jitter of \(1\times10^{-3}\) is in fact somewhat pessimistic for the conditions that can be achieved at CTF3, at least on short time scales. Figure~\ref{f:maxCorrWithT566} shows how the maximum achievable upstream-downstream phase correlation varies with the relative energy jitter when the effect of \(T_{566}\) is included. An upstream-downstream phase correlation of 97\% is required to make achieving \(0.2^\circ\) downstream phase jitter at CTF3 possible. This can be achieved with a relative energy jitter of \(0.85\times10^{-3}\) if the \(R_{56}\) is perfectly optimised. In good conditions, especially with recent developments (Section~\ref{ss:t566Mitigation}), the CTF3 energy jitter can be reduced to around \(0.5\times10^{-3}\) on short timescales, in which case correlations up to \(99.6\%\) are theoretically achievable. With further improvements to the energy stability of CTF3 it should therefore still be possible to achieve the necessary conditions for the PFF system even after taking in to account \(T_{566}\).

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/maxCorrWithT566}
  \caption{Simulated upstream-downstream phase correlation (\(\rho_{ud}\)) vs. relative beam energy jitter (\(\sigma_p\)) including the second order \(T_{566}\) term.}
  \label{f:maxCorrWithT566}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/corrVsEnergyOffset}
  \caption{Simulated upstream-downstream phase correlation (\(\rho_{ud}\)) vs. relative beam energy offset (\(\Delta p/p\)) including the second order effects of \(T_{566}\).}
  \label{f:corrVsEnergyOffset}
\end{figure}

One final consequence of the non-zero \(T_{566}\) between the upstream and downstream phase monitors is the effect of energy variations along the pulse, or equivalently cases where the mean value of \(\Delta p/p\) is non-zero. All previous calculations have assumed the energy jitter to be about a mean \(\Delta p / p\) of zero, but this can not be true for all points along the CTF3 pulse due to the variations in mean beam energy along the pulse seen in Section~\ref{ss:energyVariations}. The effect of mean energy offsets on the upstream-downstream phase correlation is shown in Figure~\ref{f:corrVsEnergyOffset}, in this case assuming a relative energy jitter of \(0.5\times10^{-3}\) about the offset mean value and zero \(R_{56}\). Typically the energy variation along the CTF3 pulse is at the \(\pm2\times10^{-3}\) level, and this by itself can cause the correlation to drop below 90\%. As a result the achievable corrected downstream phase jitter with the PFF system will also vary along the pulse. Without reducing either the energy variations along the pulse, or changing the optics to decrease the magnitude of \(T_{566}\), it is unlikely that \(0.2^\circ\) sample-by-sample jitter along the pulse can be achieved for more than very short portions of the pulse where the energy is optimal. Reducing energy variations along the pulse to below \(\pm1 \times10^{-3}\) would allow correlations above 96\% to be achieved across the full pulse length, increasing the feasibility of achieving the \(0.2^\circ\) target. New feedbacks have been developed at CTF3 to try to achieve this (Section~\ref{ss:t566Mitigation}).



\subsection{R56 Scans whilst Varying Beam Energy}
\label{ss:r56ScanWithEnergy}


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_PhaseVsEnergy}
  \caption{Measured downstream phase vs. beam energy (\(\Delta p/p\)) for three different sets of \(R_{56}\) optics in TL1: \(R_{56}=-0.100\)~m (red), \(R_{56}=0.075\)~m (blue), and \(R_{56}=0.300\)~m (green). Lines show quadratic fits to the data for each set of optics.}
  \label{f:R56ScanGunWiggle_PhaseVsEnergy}
\end{figure}


By intentionally varying the CTF3 beam energy to artificially increase the energy jitter during an \(R_{56}\) scan the energy dependent effects in both the upstream and the downstream phase are amplified. This has the benefit of increasing the visibility of the higher order effects, but it also improves the results of the scan in general by reducing the sensitivity to other small drifts in beam conditions. In this section the results of an \(R_{56}\) scan in which the \(R_{56}\) value in TL1 was varied between -0.1~m and +0.3~m whilst the beam energy was varied by approximately 1\% peak-to-peak are discussed. The resulting relative energy jitter is \(3\times10^{-3}\), or 3--6 times larger than the relative energy jitter in nominal conditions. Direct observations of the effect of higher order energy dependences during the scan will be presented first, before discussing the overall results of the scan to expand upon the conclusions from the \(R_{56}\) scans shown in Section~\ref{ss:r56Scans}.

\subsubsection{Energy Dependence}


Figure~\ref{f:R56ScanGunWiggle_PhaseVsEnergy} shows the dependence of the mean downstream phase on the beam energy for three of the \(R_{56}\) values set in TL1 during the scan -- the lowest value of \(-0.1\)~m, the maximum value of \(0.3\)~m and a mid-range value of \(0.075\)~m, which gives the lowest downstream phase jitter during the scan as seen later in this section. This plot shows similar features to the simulated result from MADX in Figure~\ref{f:phaseVsEn_t566}. With the increased energy jitter the non-linear dependence of the downstream phase on the energy is clear. The first order effect means that changing the \(R_{56}\) value changes the gradient of the phase-energy dependence about the central energy. The effect of \(T_{566}\) means that there is an energy dependent \(R_{56}\) value that minimises the phase-energy dependence. For example, for an \(R_{56}\) of -0.1~m in TL1, the minimum energy dependence will be observed for an energy offset of around \(-7\times10^{-3}\) in Figure~\ref{f:R56ScanGunWiggle_PhaseVsEnergy}.


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_R56Fit}
  \caption{Fitted total \(R_{56}\) value between the upstream and downstream phase monitors for each \(R_{56}\) value applied in TL1 during the scan. Error bars show the standard error in the fitted \(R_{56}\) values, but are mostly smaller than the markers.}
  \label{f:R56ScanGunWiggle_R56Fit}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_T566Fit}
  \caption{Fitted \(T_{566}\) value between the upstream and downstream phase monitors for each set of \(R_{56}\) optics applied in TL1 during the scan. Error bars show the standard error in the fitted \(T_{566}\) values.}
  \label{f:R56ScanGunWiggle_T566Fit}
\end{figure}

The coefficients of a quadratic fit to the curves in Figure~\ref{f:R56ScanGunWiggle_PhaseVsEnergy} (plus their equivalents for other points in the scan) give estimates for the residual \(R_{56}\) and \(T_{566}\) values between the upstream and downstream phase monitors. The results of doing this are shown in Figure~\ref{f:R56ScanGunWiggle_R56Fit} for the fitted \(R_{56}\) values, and Figure~\ref{f:R56ScanGunWiggle_T566Fit} for the fitted \(T_{566}\) values. 

The fitted \(R_{56}\) values roughly follow a linear dependence on the set \(R_{56}\) optics in TL1, as expected. With an \(R_{56}\) value of -0.2~m in TL2, varying the \(R_{56}\) between -0.1 and +0.3~m in TL1 would be expected to give a total residual \(R_{56}\) of between -0.3~m and +0.1~m. The fitted range is between -0.20~m and +0.25~m, so is +0.1~m offset compared to expectations. The fitted \(R_{56}\) values depend on the absolute mean energy offset, which is not easily verifiable from the BPM measurement alone. Figure~\ref{f:R56ScanGunWiggle_R56Fit} assumes a mean energy offset of zero. Using a mean relative energy offset of \(2\times10^{-3}\) instead would bring the fitted \(R_{56}\) values close to the expected range.

For \(R_{56}\) values in TL1 up to 0.2~m the fitted \(T_{566}\) values in Figure~\ref{f:R56ScanGunWiggle_T566Fit} are close to the simulated values (typically around -13.5~m in Figure~\ref{f:madxT566Fit}). For \(R_{56}\) values larger than 0.2~m in TL1 the fitted \(T_{566}\) value is smaller than expected. However, the measured first and second order energy dependent effects are overall in good agreement with expectations given the measurement constraints and accuracy of the MADX model.


\subsubsection{Mean Phase}

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/propagation/R56ScanGunWiggle_PhaseJitter}
  \caption{Phase jitter downstream (red markers and standard error bars) and upstream (blue markers) for each set of \(R_{56}\) optics used in TL1 during the scan whilst varying the beam energy. The dashed green line shows a simulation of the expected downstream jitter including only the first order \(R_{56}\) effects. The solid black line shows a simulation of the expected downstream phase jitter including the effects of both \(R_{56}\) and \(T_{566}\).}
  \label{f:R56ScanGunWiggle_PhaseJitter}
  \includegraphics[width=0.75\textwidth]{Figures/propagation/R56ScanGunWiggle_Correl}
  \caption{Upstream-downstream phase correlation (red markers and standard error bars) for each set of \(R_{56}\) optics used in TL1 during the scan whilst varying the beam energy. The dashed green line shows a simulation of the expected correlation including only the first order \(R_{56}\) effects. The solid black line shows a simulation of the expected correlation including the effects of both \(R_{56}\) and \(T_{566}\).}
  \label{f:R56ScanGunWiggle_Correl}
\end{figure}

Figure~\ref{f:R56ScanGunWiggle_PhaseJitter} shows the mean phase jitter during this \(R_{56}\) scan both upstream and downstream. Simulations of the expected phase jitter given the beam conditions and optics are also shown, both for the case where only \(R_{56}\) is considered and when both \(R_{56}\) and \(T_{566}\) are taken in to account. Varying the beam energy during the scan has the effect of increasing the upstream phase jitter from its typical level of 0.8 degrees to 2.0 degrees. The correlation between the upstream phase and the beam energy is also increased from 20\% in normal conditions to above 90\% whilst varying the beam energy. An example of this is shown in Figure~\ref{f:R56ScanGunWiggle_UpEnCorr} for the dataset at \(R_{56}=-0.1\)~m in TL1. %The likely source of the upstream phase-energy dependence is the energy variation leading to differences in beam orbit through the compressor chicane in the CTF3 linac (see Figure~\ref{f:ctfLayout}).

The downstream phase jitter is reduced to close to the level of the upstream phase jitter for \(R_{56}\) values between 0.05~m and 0.1~m in TL1.  With knowledge that the \(T_{566}\) can cause a dependence between the optimal \(R_{56}\) value in TL1 and the beam energy it is not completely unexpected that the lowest downstream phase jitter is not at the 0.2~m expected due to the optics in TL2. A mean relative energy offset of \(-2\times10^{-3}\) can lead to the minimum jitter being shifted to 0.075~m as seen in the scan. This offset has been used to create the simulated lines  in Figures~\ref{f:R56ScanGunWiggle_PhaseJitter}~and~\ref{f:R56ScanGunWiggle_Correl}. The simulation including this energy offset and the effects of \(T_{566}\) follows the actual downstream phase jitter during the scan more closely than the simulations including only \(R_{56}\), which are also shown. There are still differences between the data and the \(T_{566}\) simulation, in particular in the range between \(R_{56} = 0.125\)~m and 0.175~m in TL1. Some potential sources of additional downstream phase jitter are investigated in Section~\ref{s:otherJitterSources}, but these can not explain the differences seen in this scan so there are remaining effects that have not yet been identified.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_UpEnCorr}
  \caption{Upstream phase vs. the beam energy, with the \(R_{56}=-0.1\)~m optics in TL1 and whilst intentionally varying the beam energy.}
  \label{f:R56ScanGunWiggle_UpEnCorr}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_MeanEnergyAlong}
  \caption{Typical example of variations in the mean energy (\(\Delta p/p\)) along the pulse during the \(R_{56}\) scan. Sampled at 192~MHz (5.2~ns per sample).}
  \label{f:R56ScanGunWiggle_MeanEnergyAlong}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_EnergyJitterAlong}
  \caption{Typical energy jitter (\(\sigma_p\)) along the pulse during the \(R_{56}\) scan, amplified by varying the mean beam energy during the scan. Sampled at 192~MHz (5.2~ns per sample).}
  \label{f:R56ScanGunWiggle_EnergyJitterAlong}
\end{figure}

The upstream-downstream phase correlation during the scan is shown in Figure~\ref{f:R56ScanGunWiggle_Correl}. As the correlation between the upstream phase and the beam energy is greatly increased by varying the beam energy during the scan as previously discussed, there is no longer a clear singular peak in the upstream-downstream phase correlation. Instead, the correlation quickly flips between a highly correlated state and a highly anti-correlated state. This effect was previously seen in Figure~\ref{f:corrVsR56_CTENCorr} as a consequence of the \(R_{56}\) equations derived in Section~\ref{ss:r56Equations}. The actual upstream-downstream phase correlation during the scan is in good agreement with the simulation including the effects of \(T_{566}\) (again with an assumed mean energy offset of \(-2\times10^{-3}\)). 
%The optimal \(R_{56}\) for the phase propagation in terms of the upstream-downstream phase correlation is in the region around \(R_{56}=0.175\)~m in TL1. 
The highest upstream-downstream phase correlations are obtained for \(R_{56}\) values above 0.175~m in TL1.
However, for these values the downstream phase jitter is much larger than the upstream phase jitter (see Figure~\ref{f:R56ScanGunWiggle_PhaseJitter}) due to the effects of the upstream phase-energy correlation and \(T_{566}\) in the high energy jitter conditions during the scan. This makes it more difficult to precisely define the best \(R_{56}\) optics to use based on the results of a scan of this type alone.



\subsubsection{Phase Along the Pulse}

As well as the mean phase it is interesting to look at the effect of varying \(R_{56}\) on the phase along the pulse. To understand differences in the downstream phase along the pulse it is important to know the properties of the beam energy along the pulse during the \(R_{56}\) scan. Figures~\ref{f:R56ScanGunWiggle_MeanEnergyAlong}~and~\ref{f:R56ScanGunWiggle_EnergyJitterAlong} show typical examples of the mean energy and the energy jitter along the pulse. During this scan the mean beam energy was systematically varied about its initial value, as noted previously. This has no effect on the shape of energy variations along the pulse, but does increase the point-by-point energy jitter. The relative beam energy offset along the pulse (Figure~\ref{f:R56ScanGunWiggle_MeanEnergyAlong}) varies by \(3.5\times10^{-3}\) peak-to-peak. The energy jitter along the pulse varies between \(4\times10^{-3}\) and \(3\times10^{-3}\), with better stability towards the end of the pulse.



Figure~\ref{f:r56Scan_meanPhaseAlong} shows the mean phase along the pulse for each \(R_{56}\) setting in TL1 during the scan. Any difference in the mean (rather than the jitter) along the pulse with the \(R_{56}\) value should originate from variations in the mean energy along the pulse. If there were no variations in the energy along the pulse, changing the \(R_{56}\) would only affect the phase jitter and would not change the mean pulse shape. The clear change in certain features along the pulse in the downstream phase is therefore an indication of energy variations in these regions. Perhaps the best example of this is the effect around a time of 800~ns, where the phase swings upwards when a negative \(R_{56}\) in TL1 is used or downwards for \(R_{56}\) values above 0.15~m.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan_meanPhaseAlong}
  \caption{Mean downstream phase along the pulse for all sets of \(R_{56}\) optics used in TL1 during the scan whilst varying beam energy.}
  \label{f:r56Scan_meanPhaseAlong}
\end{figure}

The difference between the phase along the pulse for two different settings of \(R_{56}\) in TL1 should be proportional to the beam energy along the pulse. Figure~\ref{f:r56Scan_comparisonPhaseEnergy} plots the difference between the \(R_{56}\)~=~+0.3~m optics and the roughly optimal \(R_{56}\)~=~+0.075~m optics, and compares this to the beam energy along the pulse. Both lines are mean subtracted and normalised to give equivalent amplitudes in arbitrary units. Overall, the differences in phase along the pulse resulting from using non-optimal \(R_{56}\) in TL1 are very well matched with the energy variation along the pulse, as expected. 

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/r56Scan_comparisonPhaseEnergy}
  \caption{Difference between the mean downstream phase along the pulse with \(R_{56} = 0.3\)~m and 0.075~m in TL1 (blue) compared to the mean beam energy along the pulse (red). Sampled at 192~MHz (5.2~ns per sample).}
  \label{f:r56Scan_comparisonPhaseEnergy}
\end{figure}

Figure~\ref{f:R56ScanGunWiggle_JitterAlong} shows the downstream phase jitter along the pulse for each \(R_{56}\) optics in TL1 used during the scan. Like the mean phase jitter, the jitter along the pulse is lowest for \(R_{56}\) values between 0.05~m and 0.1~m in TL1 (blue). Lower \(R_{56}\) values (green) and higher \(R_{56}\) values (purple, red and black) give higher jitter. Close to the optimal \(R_{56}\) value many of the variations in jitter along the pulse are reduced, although in all cases some features remain.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/R56ScanGunWiggle_JitterAlong}
  \caption{Downstream phase jitter along the pulse for each set of optics used in TL1 during the \(R_{56}\) scan whilst varying beam energy.}
  \label{f:R56ScanGunWiggle_JitterAlong}
\end{figure}

Differences in the phase jitter along the pulse between two different \(R_{56}\) optics in TL1 should also be related to the beam energy. One might expect the features in the downstream phase jitter along the pulse to match the shape of the variations in energy jitter along the pulse shown previously. Figure~\ref{f:stdPhaseVsStdEnergyAlong} compares the difference in phase jitter along the pulse for the \(R_{56} = 0.075\)~m and \(R_{56} = -0.1\)~m optics to the energy jitter along the pulse. There is no clear similarity between the two. In Figure~\ref{f:stdPhaseVsMeanEnergyAlong} the phase jitter along the pulse is compared to the mean energy along the pulse instead. In this case most of the features in the downstream phase jitter are also present in the energy along the pulse. Static variations in the mean energy along the pulse therefore appear to be more critical for the phase propagation than differences in energy jitter along the pulse. %This is true even in the conditions used in this scan,  in which the energy jitter was artificially increased.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/stdPhaseVsStdEnergyAlong}
  \caption{Difference between the downstream phase jitter along the pulse with \(R_{56} = 0.3\)~m and 0.175~m in TL1 (blue) compared to the energy jitter along the pulse (red). Sampled at 192~MHz (5.2~ns per sample).}
  \label{f:stdPhaseVsStdEnergyAlong}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/stdPhaseVsMeanEnergyAlong}
  \caption{Difference between the downstream phase jitter along the pulse with \(R_{56} = 0.3\)~m and 0.175~m in TL1 compared to the mean beam energy along the pulse (red). Sampled at 192~MHz (5.2~ns per sample).}
  \label{f:stdPhaseVsMeanEnergyAlong}
\end{figure}

\subsection{Mitigation of Higher Order Dependences}
\label{ss:t566Mitigation}

The first order energy dependent effects on the downstream phase due to the \(R_{56}\) in TL2 have largely been successfully removed by adding positive \(R_{56}\) to the TL1 line. If necessary, further improvements could be made by creating further sets of TL1 optics in smaller \(R_{56}\) steps. 
Although the higher order energy dependent effects due to \(T_{566}\) have been identified it has not yet been attempted to remove, or at least reduce, them in the optics. Optics including sextupole magnets (usually left off at CTF3) in TL1, the combiner ring and TL2 could be created to achieve this. However, to be completely successful this depends on the accuracy of the MADX model of CTF3 to second order, which is not guaranteed although the result in Figure~\ref{f:R56ScanGunWiggle_T566Fit} is promising in this regard.
%To remove the effect completely, new optics would have to be matched with constraints included to zero the \(T_{566}\) value between the usptream and downstream phase monitors. This would likely require the use of sextupoles, which are typically left unpowered at CTF3 due to difficulties in commissioning optics that include them \cite{piotrPriv}. It also depends on the accuracy of the MADX model of CTF3 to second order, although the result in Figure~\ref{f:R56ScanGunWiggle_T566Fit} is promising in this regard, at least in the \(R_{56}\) range of interest.

Alternatively, the second order effects can be reduced by decreasing the energy jitter and variations along the pulse at CTF3. Many improvements have recently been made at CTF3 to achieve this via the implementation of several new feedbacks \cite{lukasIPAC16}. New feedbacks on the phases of each klystron in the CTF3 injector as well as on the beam energy are now routinely in operation, and these have already improved the mean energy jitter to \(0.5\times10^{-3}\) on short time scales of several minutes, or \(0.8\times10^{-3}\) on longer time scales. Hardware changes and further improvements to the implementation of these feedbacks should allow the mean energy stability to be improved further.

In addition, although they are not yet run online in normal operation, new feedback systems have also been implemented and commissioned that can smooth energy variations along the pulse, or directly smooth the upstream phase along the pulse itself. The energy flattening feedback \cite{tobiasPriv} varies the waveform of the last klystron in the CTF3 linac based on the measurement of the same dispersive BPM used to measure the beam energy in this chapter --- CT.0608 in TL1. This flattens the energy along the pulse by varying the energy gain along the pulse in the last accelerating structure. In addition, prior to the best phase propagation conditions currently achieved (presented in Section~\ref{s:bestPhaseProp}) a similar feedback was used to smooth features in the upstream phase along the pulse by varying the waveform of the first klystron in the CTF3 linac \cite{davideThesis}.
%, as seen in Figure~\ref{f:beforeAfterDavideFlatten}.
 Feedbacks of this type will be critical to be able to improve the PFF performance for future tests.

%\begin{figure}
%  \centering
%  \includegraphics[width=0.8\textwidth]{Figures/propagation/beforeAfterDavideFlatten}
%  \caption{Effect of feedback used to smooth variations along the upstream phase (initial upstream phase in blue, and after applying the feedback in red).}
%  \label{f:beforeAfterDavideFlatten}
%\end{figure}

\newsection{otherJitterSources}{Possible Other Sources of Phase Jitter}

The energy related effects on the downstream phase have been the main focus of attempts to improve the phase propagation for the PFF system. As shown in Section~\ref{s:bestPhaseProp} this by itself has allowed upstream-downstream correlations in excess of 90\% to be achieved at CTF3. Further optimisations will be needed to achieve the CLIC target of 0.2 degrees phase jitter with the PFF prototype, however. This can partly come from further improvements of the CTF3 injector setup and stability, which will help to reduce any remaining effects from \(T_{566}\) by reducing beam energy jitter, drifts and variations along the pulse. At correlations above \(90\%\) any remaining small differences in the performance of the upstream and downstream phase monitors may also become significant, but this has been addressed in Chapter~\ref{c:phaseMons} so will not be discussed again here.

Preliminary measurements have been performed to investigate whether there may be any other effects at CTF3, apart from energy jitter, that can change the downstream phase and reduce the upstream-downstream phase correlation. The most likely culprits are magnetic elements between the upstream and downstream phase monitors that have a strong effect on the beam orbit. Any change in beam orbit can change the path length between the upstream and downstream phase monitors, and thus shift the downstream phase with respect to the upstream phase. The main elements for which this could be significant include the dipoles in TL1 and the combiner ring, as well as the two septum magnets used  at the combiner ring injection and extraction. Fluctuations in the power supplies for one of these devices could be an additional source of uncorrelated downstream phase jitter.

The current applied from the power supplies for each of these devices has been varied to determine their effect on the downstream phase. In some cases one power supply drives multiple devices, meaning these devices can not be changed independently from each other and any jitter in their strengths should be correlated (assuming the jitter source is the power supply, rather than a separate issue with the device itself). There are four power supplies that control the strength of the devices of interest in the following groups:
\begin{itemize}
\item \textbf{Power supply 1:} The first (CT.0540) and second (CT.0630) dipole in TL1.
\item \textbf{Power supply 2:} The third (CT.0670) and fourth (CT.0710) dipole in TL1.
\item \textbf{Power supply 3:} The combiner ring injection and extraction septa.
\item \textbf{Power supply 4:} All combiner ring dipoles.
\end{itemize}

Figure~\ref{f:tl1670} shows the effect of changing the last two dipoles in TL1 (power supply 2 above) on the downstream phase, which is the strongest observed dependence. The fitted downstream phase shift per ampere change on this power supply is \(10\pm2^\circ\). Table~\ref{t:otherJitSources} summarises the phase shift per ampere for the other three power supplies. 
%A linear fit to the response is also shown. For the combiner ring dipoles the response is non-linear and the fit is only applied in the central region around the nominal device setting, giving an approximate gradient that is relevant for small offsets. %In some cases, particularly for the 540/710 dipoles in TL1, the phase dependence is not clear. In all cases the goal is to determine whether there is an effect that may be significant for the PFF system, which can then be investigated further later, rather than quoting precise numbers.

%\begin{figure}
%  \centering
%  \includegraphics[width=0.8\textwidth]{Figures/propagation/tl1540}
%  \caption{Phase vs. strength of first and last dipole in TL1 (CT.0540 and CT.0710).}
%  \label{f:tl1540}
%\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/tl1670}
  \caption{Downstream phase vs. strength (power supply current) of the last two dipoles in TL1 (CT.0670 and CT.0710). Error bars show the standard error on the measured phase (errors on the applied current are smaller than the markers).}
  \label{f:tl1670}
\end{figure}

%\begin{figure}
%  \centering
%  \includegraphics[width=0.8\textwidth]{Figures/propagation/crSeptum}
%  \caption{Phase vs. strength of the combiner ring injection and extraction septum magnets.}
%  \label{f:crSeptum}
%\end{figure}

%\begin{figure}
%  \centering
%  \includegraphics[width=0.8\textwidth]{Figures/propagation/crBends}
%  \caption{Downstream phase vs. strength (power supply current) of the combiner ring dipoles).}
%  \label{f:crBends}
%\end{figure}

The power supplies at CTF3 give a relative stability in the supplied current of approximately \(10^{-4}\). Assuming this stability the effect of each device on the downstream phase jitter can be estimated by using the fitted phase shifts per ampere and the known power supply current setting for each device. These approximate phase jitters are also summarised in Table~\ref{t:otherJitSources}. By far the strongest potential source of phase jitter appears to be the last two dipoles in TL1 (CT.0670 and CT.0710), which by themselves could contribute \(0.17\pm0.03\) degrees phase jitter. 
The combiner ring devices contribute roughly 5 times less phase jitter than the CT.0670 and CT.0710 dipoles. 
Combining the estimated phase jitters resulting from all the devices in quadrature gives an overall contribution of \(0.18\pm0.03^\circ\) additional downstream phase jitter.
%The explanation for these two dipoles having a much larger effect on the phase than the first two dipoles in TL1 is not known and will need to be verified by repeated measurements and checks of the expected response in the CTF3 MADX model. 
%Introducing field errors to these devices in the CTF3 MADX model also predicts the phase to be most sensitive to the stability of the CT.0670 and CT.0710 dipoles (shown in Table~\ref{t:otherJitSources}).

\begin{table}
  \begin{center}
    \begin{tabular}{| c | c c c | c|}
	   \hline
       Device & Current & Fit Gradient & Estimated Jitter \\ \hline
       TL1 540/630 Dipoles & 133~A & \(-0.4\pm0.3^\circ\)/A & \(0.005\pm0.004^\circ\) \\
       TL1 670/710 Dipoles & 164~A & \(10\pm2^\circ\)/A & \(0.17\pm0.03^\circ\) \\
       CR Septa & 890~A &  \(-0.5\pm0.1^\circ\)/A & \(0.05\pm0.01^\circ\) \\
       CR Dipoles & 156~A & \(1.8\pm0.7^\circ\)/A & \(0.03\pm0.01^\circ\) \\ \hline 
    \end{tabular}
    \caption{Power supply current setting, measured dependence of the downstream phase on the current and estimated contribution to downstream phase jitter for the dipoles and septa in TL1 and the combiner ring.}
  	\label{t:otherJitSources}
  \end{center}
\end{table}

Modelling the downstream phase as \(\phi_d = \phi_u + x\), where \(x\) is a generic additional source of uncorrelated jitter, the downstream jitter and upstream-downstream phase correlation are given by:
\begin{equation}
\sigma_d = \sqrt{\sigma_u^2 + \sigma_x^2}
\qquad\mathrm{;}\qquad
\rho_{ud} = \frac{\sigma_u^2}{\sigma_u^2 + \sigma_x^2}
\end{equation}
These are equivalent to the equations derived for the phase monitor resolution in Section~\ref{s:resolutionEqs}. Assuming an initial upstream phase jitter of \(0.8^\circ\) plus a \(\sigma_x = 0.18^\circ\) source of jitter resulting from the power supply stabilities previously discussed, the downstream phase jitter is increased slightly to \(0.82^\circ\) and the upstream-downstream phase correlation reduced to \(95\%\).

The effect on the predicted upstream-downstream phase correlation is significant for the PFF system, which requires correlations above \(97\%\) to achieve CLIC level phase stability at CTF3. Therefore, jitter on the power supplies may become a limiting factor for the PFF system performance and this will be verified with repeated measurements of the power supply dependences and stabilities in the future.

%This by itself does not prevent the PFF system from theoretically achieving \(0.2^\circ\) phase jitter, for which \(\rho_{ud} = 0.97\) is required. However, in combination with the effects of \(R_{56}\), \(T_{566}\) and the phase monitor resolution, each of which can individually reduce the correlation to 0.97 or below depending on the conditions, this highlights that the \(0.2^\circ\) target will be very difficult to achieve with the PFF prototype at CTF3.

\newsection{bestPhaseProp}{Optimised Phase Propagation}

This section summarises the phase propagation conditions that have been achieved after the extensive work to identify and reduce the energy dependence of the downstream phase. The results shown here are taken from the same dataset with which the PFF results presented in Section~\ref{s:jitterRecord} were achieved. At this time the \(R_{56} = +0.1\)~m optics was used in TL1. The achieved conditions are a remarkable improvement compared to the original status presented in Section~\ref{s:origJitter}. The reproducibility of these conditions is discussed in the context of the PFF results in Section~\ref{s:longPFF}.

\subsubsection{Mean Phase}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_enCorr}
  \caption{Upstream (blue) and downstream (red) phase vs. energy with optimised phase propagation.}
  \label{f:bestProp_enCorr}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_meanPhase}
  \caption{Mean phase vs. time upstream (blue) and downstream (red) with optimised phase propagation. Shown across 75 pulses.}
  \label{f:bestProp_meanPhase}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_meanCorr}
  \caption{Downstream vs. upstream phase with optimised phase propagation. The black line shows a linear fit to the data (blue markers).}
  \label{f:bestProp_meanCorr}
\end{figure}

The optimal phase propagation conditions are achieved when the upstream phase-energy correlation and the downstream phase-energy correlation is the same. Figure~\ref{f:bestProp_enCorr} shows the dependence of the upstream and downstream phase on the beam energy. With the optimised conditions almost all correlation between the downstream phase and the beam energy is removed, with a correlation of \(0.2\pm0.1\). This agrees with the upstream phase-energy correlation of \(0.1\pm0.1\) within error bars.

Figure~\ref{f:bestProp_meanPhase} shows that all drifts in the upstream phase are also present downstream, and that the upstream and downstream mean phase jitters also agree within errors bars --- \(0.69\pm0.06^\circ\) upstream and \(0.74\pm0.06^\circ\) downstream. The standard deviation of the residuals between the upstream and downstream phase is \(0.27\pm0.02^\circ\).%, which corresponds to below 0.2 degrees actual beam jitter between the two phases when the phase monitor resolution is taken in to account.  
Figure~\ref{f:bestProp_meanCorr} shows the downstream phase plotted against the upstream phase. The correlation between the mean upstream and downstream phase is \(93\pm4\%\), and this is very close to the targeted \(97\%\) that would make a reduction in downstream jitter to \(0.2^\circ\) possible with the PFF system.


\subsubsection{Phase Along Pulse}

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_meanAlong}
  \caption{Phase along the pulse upstream (blue) and downstream (red) with optimised phase propagation.}
  \label{f:bestProp_meanAlong}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_jitAlong}
  \caption{Phase jitter along the pulse upstream (blue) and downstream (red) with optimised phase propagation.}
  \label{f:bestProp_jitAlong}
\end{figure}

Figure~\ref{f:bestProp_meanAlong} compares the phase along the pulse upstream and downstream in the optimal conditions. For reference, the mean phases presented above were calculated in the region between 530~ns and 950~ns. This is the flattest central part of the pulse where the PFF system can provide the maximum reduction in phase jitter, as seen in Section~\ref{s:jitterRecord}. The overall agreement in shape between the upstream and downstream phase is much better than the original conditions seen in Figure~\ref{f:origPhaseAlong}, with almost all energy dependent features removed from the mean downstream phase along the pulse. There are still some remaining differences in shape, particularly at the start and end of the pulse before and after the 530--950~ns range.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_corrAlong}
  \caption{Upstream-downstream phase correlation along the pulse with optimised phase propagation.}
  \label{f:bestProp_corrAlong}
  \includegraphics[width=0.8\textwidth]{Figures/propagation/bestProp_enCorrAlong}
  \caption{Upstream (blue) and downstream (red) phase-energy correlation along the pulse with optimised phase propagation.}
  \label{f:bestProp_enCorrAlong}
\end{figure}

By viewing the phase jitters and correlations along the pulse the remaining areas for improvement start to become apparent. In Figure~\ref{f:bestProp_jitAlong}, showing the phase jitter along the pulse, it is clear that the start of the pulse is less stable. For times between 100~ns and 600~ns the downstream phase jitter is as much as 60\% larger than the upstream phase jitter.  However, there is a 400~ns portion of the pulse where the downstream phase jitter has been successfully reduced to the level of the upstream phase jitter. The best PFF results can be expected in this region.

The upstream-downstream phase correlation along the pulse (the point by point correlation between the upstream and downstream phase calculated for each individual sample along the pulse), in Figure~\ref{f:bestProp_corrAlong}, is at the same level as the mean phase correlation in the region between 450~ns and 650~ns. However, there are also parts of the pulse where the upstream-downstream phase correlation is greatly reduced -- to 55\% at 300~ns and 70\% at 700~ns, for example. Differences earlier in the pulse are not critical for the PFF system, but the feature at 700~ns is in the area where the correction is attempted.

By comparing the upstream-downstream correlation along the pulse to the correlations with energy along the pulse, in Figure~\ref{f:bestProp_enCorrAlong}, the problem becomes clear. Due to energy variations along the pulse and the effect of higher order energy dependences, as previously discussed, the phase propagation can not be optimised across the full pulse length. As a result there are parts of the pulse where the downstream phase-energy correlation is still high, up to 75\%. Areas where there is a large difference between the upstream phase-energy correlation and the downstream phase-energy correlation correspond to regions of degraded upstream-downstream phase correlation in Figure~\ref{f:bestProp_corrAlong}. This is the key area where improvements are needed to further improve the PFF performance.



\newsection{propSumm}{Summary}

The PFF system requires at least \(97\%\) correlation between the upstream and downstream phase to reduce an initial downstream phase jitter of \(0.8^\circ\) to the CLIC target of \(0.2^\circ\). However, preliminary measurements at CTF3 measured only \(0.34\pm0.06\) upstream--downstream phase correlation, and a downstream phase jitter of \(1.86\pm0.09^\circ\).

The TL2 optics created in Chapter~\ref{c:tl2Optics} have a non-zero \(R_{56}\) transfer matrix coefficient of around \(-0.2\)~m, which creates additional energy dependent phase jitter downstream that is not present in the upstream phase. To achieve the necessary initial downstream phase jitter and upstream-downstream phase correlation, an absolute \(R_{56}\) value below 1.3~cm is required between the upstream and downstream phase monitors. To compensate for the negative \(R_{56}\) value in TL2, new optics with positive \(R_{56}\) values in the transfer line TL1 have therefore been created, to create a total \(R_{56}\) of zero between the monitors. By adjusting the \(R_{56}\) value in TL1 it has been possible to achieve an upstream-downstream mean phase correlation of \(93\pm4\%\) with a downstream phase jitter of \(0.74\pm0.06^\circ\), close to the requirements to enable a \(0.2^\circ\) correction.

However, the optimal \(R_{56}\) value to use in TL1 was found to vary over time. This is caused by a large second order phase-energy dependence in the optics at CTF3, described by the coefficient \(T_{566}\). With non-zero \(T_{566}\) the apparent optimal \(R_{56}\) value depends on the beam energy. In particular, the effect of energy variations along the pulse, combined with \(T_{566}\), means the phase propagation cannot be optimal across the full pulse length. With recent improvements to the energy stability at CTF3, it has been shown that it should still be possible to achieve \(97\%\) upstream-downstream phase correlation despite the effects of \(T_{566}\). Alternatively, new optics using sextupoles could be created to reduce the \(T_{566}\) term.

Preliminary measurements have identified that the downstream phase is sensitive to the stability of dipole power supplies, which may be an energy independent limitation on the achievable upstream-downstream phase correlation.
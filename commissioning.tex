\newchapter{commissioning}{Setup and Commissioning of the PFF System}

This is the introductory text.

\newsection{fontSetup}{Feedforward Controller (FONT5a Board)}

\subsection{Installation}
\label{ss:fontInstall}


Trigger

ADC1

ADC2

Serial

Amp trigger out

DAC1

DAC2


\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/FONT5aPanelPic}
  \caption{Front panel of the FONT5a board.}
  \label{f:FONT5aPanelPic}
\end{figure}


\subsection{Setup Parameters and DAQ}
\label{ss:fontDAQ}

The FONT5a board is controlled using a LabVIEW data acquisition system (DAQ) documented in [REF]. An example screenshot from the DAQ is shown in Figure~\ref{f:DAQScreenshot} [TODO: get a better picture]. It provides functionality to change all the setup parameters in the FONT5a firmware for the PFF system setup, view the current ADC inputs and DAC outputs in real time and to save data directly from the FONT5a board. However, as the FONT5a board and DAQ currently run as a standalone system at CTF3, rather than directly saving data from the FONT5a board PFF data is usually saved via the CERN control system and SiS digitisers where data from other devices, such as BPMs, can be saved in sync with the phase monitor signals as discussed in Section~\ref{s:daqSigProc}. The DAQ runs on a Windows PC next to the racks used for the phase monitor electronics, FONT5a board and amplifier. The PC can be connected to via remote desktop to allow the FONT5a board to be controlled in the CTF3 control room.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/DAQScreenshot}
  \caption{Diode output along the pulse with the IIR filter off and on.}
  \label{f:DAQScreenshot}
\end{figure}

All the parameters and controls that must be adjusted during the PFF system setup, and their respective values where relevant, are listed below for reference. These are only introduced in brief here, but parameters that are either non-trivial to derive or are critical for the PFF performance are described in more detail in later sections and chapters as indicated. The values given are in FONT units as they are set in the DAQ with each parameter expressed by up to a 14~bit number, and the size of each control chosen to give a reasonable degree of flexibility around the expected set point. 

[TODO: Order a bit strange. Maybe some not needed. Table of values? Units for some of them - like trig in delay?]

\textbf{Trig in delay:} The Trig in delay allows the start of the ADC sampling window to be delayed with respect to the arrival of the external trigger. Timing of the trigger and correction outputs to the amplifier (Trig out delay and K1/K2 delay) are relative to this delay, therefore changing the Trig in delay value does not effect the synchronisation of the correction output with the beam. The only requirement is to ensure that the full acquired upstream phase monitor signals arrive within the sampling window. A value of 2500 is typically used to achieve this. [TODO: Check value is correct.]

\textbf{Trim DACs:} The FONT5a board contains DACs, referred to as Trim DACs, prior to each ADC [REF]. By varying the input sent to the Trim DACs the baseline of each ADC channel can be adjusted in order to remove any intrinsic voltage offset in their output. For ADC1 (Diode) and ADC2 (Mixer) the Trim DAC values are 1650 and 1400 counts, respectively.

\textbf{Filter Weights:} IIR filters are implemented in the FONT5a firmware in order to remove droop in the ADC response, see Section~\ref{ss:droopCorr}. The filter weights for each ADC can be adjusted in the DAQ. The correct values are 50 for ADC1 (Diode) and 56 for ADC2 (Mixer).

\textbf{Trig out enable:} The trigger sent to the amplifier can be enabled or disabled as required. Clearly the trigger must be enabled for any correction output to have an effect on the beam (the PFF correction output can be turned on with the amplifier trigger disabled for testing purposes).

\textbf{Trig out delay:} The timing of the trigger sent to the amplifier can be delayed with respect to the start of the ADC sampling window. This must be adjusted so that the arrival of the \(1.1~\mathrm{\mu}\)s beam pulse at the kickers is aligned with the \(1.4~\mathrm{\mu}\)s time during which the amplifier is powered and the correction output can be applied. [TODO: Section/plot showing how?]. A value of 110 is typically used. The precise correction timing is set by the K1 and K2 delays below.

\textbf{Gate enable:} The correction output can be restricted to a certain sample range by applying a ``gate''. The gate can be defined either as a custom sample range picked by the user or the diode signal (ADC1) can be used. Diode gating is typically used so that no output is sent to the amplifier outside the time of the beam pulse. Using a custom sample range has been useful for early PFF tests and to apply a constant kick along only part of the beam pulse (this is used in Section~\ref{ss:relativeTiming}, for example).

\textbf{Feedforward enable:} The DAC output can be enabled or disabled, as required.

\textbf{Interleaved mode:} With interleaved mode enabled the DAC outputs from the FONT5a board are only sent for half of the triggers, for example being applied to all the odd pulses but not sent for all the even pulses. This is incredibly useful for interpreting the PFF results, as well as being used for many of the other tests presented in this thesis, as it allows a comparison between beam conditions with and without an applied kick at the same time. In this case the effects of any slow drifts should be equivalent in both the kicked and non-kicked data, thus any differences between the two should be a real effect of the PFF system. Data with the DAC output disabled can also be used to simulate the expected effect of the PFF system in those conditions. All the PFF results in Chapters~\ref{c:earlyFFSim}~and~\ref{c:feedforward} use interleaved data.

\textbf{K1, K2 delay}: The K1 and K2 delay are used to fine tune the timing of the two correction outputs (DAC1/K1 for the first kicker and DAC2/K2 for the second kicker), and can be varied by up to 32 ADC clock cycles (2.8~ns per clock cycle at 357~MHz). The optimal delays are 7~clock~cycles for K1 and 7--8~clock~cycles for K2. The importance of the correction timing and derivation of these values is presented in Section~\ref{s:timing}.

\textbf{DAC Output Mode:} The DAC output to the amplifier can be sent in two modes --- Sample-by-sample or Constant DAC. In Sample-by-sample mode the DAC output is as needed for the PFF system, being shaped along the pulse by the reconstructed phase (the mixer on ADC2 and, if used, the diode on ADC1) multiplied by the set gain. More details are given in Section~\ref{ss:pffFirmware}. In Constant DAC output mode a constant output voltage can be sent to the amplifier across the full length of the ADC sampling window (or for a shorter time with an applied gate). The majority of the results presented in the remainder of this chapter use constant DAC outputs for verification of the amplifier, optics, correction range and correction timing.

\textbf{K1, K2 const DAC}: Constant DAC values can range between \(\pm4096\)~counts, or \(\pm2\)~V sent to the amplifier, and can be varied independently for each output.

\textbf{Gain}: The PFF gain can also be set independently for each correction output, with each being a 14-bit value (\(\pm8192\)~units). The conversion between the gain in FONT units and the real applied gain is derived in Section~\ref{ss:pffFirmware}. An applied gain of 711~units corresponds to a real gain of approximately 1 (with a gain of 711 an upstream phase offset of 1~degree corresponds to a downstream phase correction of approximately -1~degrees).

\textbf{Channel Offset:} To maximise the effect of the PFF system it is necessary to zero the mean upstream mixer (ADC2) output in the central region of the pulse where the correction is being attempted (the start and end of the pulse can not be fully corrected due to the large phase sag, so the central portion is usually used). Ideally this should be adjusted by varying the Mon1 phase shifter, but this can not be done remotely so the channel offset on the FONT5a board can be used instead to make small adjustments from the control room. For large phase offsets giving close to maximum mixer output the phase monitor resolution is degraded (Section~\ref{s:resolution}) and the small angle approximation used in the FONT5a phase reconstruction (Section~\ref{ss:pffFirmware}) becomes invalid, in which case the phase shifter should still be used to zero the phase. The channel offset adds a static offset in counts to the ADC2 output, allowing the mixer output to be zeroed at any point along the pulse. The consequences of using a non-optimal Channel Offset are discussed in Section~\ref{ss:longFF_upDrifts}.

\textbf{Diode Mode:} The FONT5a firmware provides three modes for the treatment of the diode signal on ADC1 --- normalisation, gating and unused. With diode normalisation enabled the PFF system reconstructs the phase as originally envisaged using Mixer/sqrt(Diode). Due to the issues with the phase monitor diodes as discussed in Chapter~\ref{c:phaseMons} the option to not include the diode in the PFF calculation and only include the mixer was later added. Rather than leaving the diode completely unused, it is usually used to gate the correction output as mentioned above.

\textbf{Overflow Mode:} The PFF correction output can behave in three ways in the case where the calculated output is outside the maximum range of \(\pm4096\)~DAC counts. In the first iteration of the PFF firmware the calculated correction output would overflow, causing sign flips in the output in the regions where the correction range was exceeded. This behaviour can still be applied in the current firmware if desired. However, in normal operation the output is set to Saturate, so that any calculated values outside \(\pm4096\)~DAC counts are sent as the maximum \(\pm4096\)~DAC~counts or \(\pm2\)V to the amplifier. A final option to provide no output at samples where the calculated output is outside \(\pm4096\)~DAC~counts, is also provided.

\textbf{Enabled channels:} The FONT5a board has 9~ADCs but only two are usually needed for the PFF system (for the mixer and diode of Mon1 connected to ADC1 and ADC2, with the other two monitors normally connected to the SiS digitisers). To avoid hitting the limits of the baud rate  [TODO: value?] of the RS232 port on the PC the remaining ADC channels can be disabled so their data is not transmitted.

\textbf{No. samples:} The length of the ADC sampling window, in number of samples, can also be varied. Typically 900~samples are used, covering a time window of \(2.5~\mathrm{\mu}\)s with the 357~MHz clock. If the signal from more than two ADCs is needed the number of samples can be reduced to avoid hitting the baud rate limit of the RS232 port on the PC, the only requirement is that the time window is long enough to encompass the full \(1.1~\mathrm{\mu}\)s beam pulse length.


\subsection{ADC Droop Correction}
\label{ss:droopCorr}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/iirDiodeFiltOffOn}
  \caption{Diode output along the pulse with the IIR filter off and on.}
  \label{f:iirDiodefiltOffOn}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/iirDiodeFiltOffOn_zoom}
  \caption{Diode output along the pulse with the IIR filter off and on. Zoomed in.}
  \label{f:iirDiodefiltOffOn_zoom}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/iirDiodeFit}
  \caption{Exponential fit to diode droop.}
  \label{f:iirDiodeFit}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/iirDiodeFitResid}
  \caption{Residuals between diode exponential fit and actual diode output.}
  \label{f:iirDiodeFitResid}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/iirPhaseFiltOffOn}
  \caption{Phase along the pulse with the IIR filter off and on.}
  \label{f:iirPhasefiltOffOn}
\end{figure}

The droop in the response of the FONT5 ADCs, as most clearly seen in the output of the diode channel in Figure \ref{f:diodeDroop} (although it also effects the mixer channel), is not an issue for the work the FONT group does at ATF2 where the signals are well approximated by delta functions separated by \(\sim\)100~ns. Although the droop has been seen previously, its significance for the continuous microsecond length pulse at CTF3 had not been considered because of this.

The droop emerges as a result of the use of AC coupling on the ADC input transformers for electrical isolation. This involves using a capacitor, the current across which is dependent on \({dV}/{dt}\) (\(V\) being voltage and \(t\) time), to remove the DC component from a signal. In particular for the diode channel, which should be a square wave, the output is increasingly well described by a DC signal on the flat top as you move away from the leading edge of the pulse, with the capacitor causing droop in the response as a result.

In the simplest case the droop should be well described by an exponential decay of the form \(A\exp\left(-t/T\right)\). The droop makes it difficult to perform calibrations and measurements on the data and one way in which it could be removed in offline analysis is by determining the decay constants, \(T\), for each of the ADCs on the FONT5 board. To avoid the influence of beam effects tests were done in Oxford using a generated 10~\(\mu\)s DC pulse.

Unfortunately, as can be seen in Figure \ref{f:droopFit} which shows an example of an exponential fit for one ADC, although the fits return good \(R^{2}\) values it is clear that the slope of the exponential curve is not a good match for the slope of the data. This is perhaps not unexpected as the ferrite cores used in the transformers have many non-linear properties. In fact, by using a fit with two exponential terms it is possible to obtain a perfect match to the data but at this point the complexity of the fit would make any attempt to remove the droop in real beam data in this way spurious.

Instead, changes will be made to the currently in development FONT5a board hardware and firmware to greatly reduce the scale of the droop. Different transformers will be used to reduce the droop rate by up to a factor of fifty and in addition digital filtering will be implemented in firmware to smooth out and reduce the remaining droop component even further. It is expected that after these changes the droop will be small enough to not have a detrimental effect on the performance of the phase feedforward system. 

\subsection{Implementation of PFF Algorithm in Firmware}
\label{ss:pffFirmware}

Not using arcsin in phase reconstruction - effect

Gain conversion factor

\newsection{amplifierSetup}{Amplifier}

Make point that all effects here much smaller than phase monitors/phase propagation and although important to highlight them no attempts yet made to correct them or take them in to account in simulations.

Amplifier versions:

First version (nov 2014) 350 V (check)

2nd version  (jul 2015) 650 V - double FETs

3rd version: 1200 V with combiner module (?) not pursued

\subsection{Installation}
\label{ss:ampInstallation}


Amplifier inputs:

Trigger from FONT5a board (TRIG OUT DELAY)

DAC1 and DAC2 from FONT5a board


Amplifier outputs:

4 drive signals - one for each strip. Sent to downstream end of kicker (why?)

4 terminators

Amplifier on time monitoring

Monitoring of each amplifier output

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmplifierPanelPic}
  \caption{Front panel of the amplifier.}
  \label{f:AmplifierPanelPic}
\end{figure}


\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/kickerCables}
  \caption{Cabling setup for cables between the amplifier and kickers.}
  \label{f:kickerCables}
\end{figure}


\subsection{Linearity}
\label{ss:ampLin}

Figure \ref{f:AmpOutvsDAC} shows the amplifier output, as measured by the monitoring signals, at different constant input voltages sent from the FONT5a board between the minimum of -2V (-4096 DAC counts) and maximum of 2V (+4096 DAC counts). The output voltage from the monitoring signals is converted in to the real amplifier output Voltage using the approximate conversion factor of 115. All four amplifier outputs are shown (one for each strip of the two kickers). The plotted values are means taken across a 480~ns central part of the whole 1400~ns output pulse.

The relative polarity of the four outputs is equivalent to what would be sent to the kickers during PFF operation, with opposite polarity of the L and R amplifier outputs sent to each kicker, so that the beam is kicked in opposite directions by each kicker with the second kicker then closing the orbit bump created by the first. Within each side of the amplifier the A and B outputs (sent to each side of the kicker) also have opposite polarity, necessary to create the potential difference across the strips within each kicker that creates the deflecting field for the beam. The relative polarity of the A and B outputs is fixed in the amplifier design and cannot be controlled via the FONT5a board.

The response of the amplifier is highly linear in the region between \(\pm1.2\)~V sent to the amplifier. Outside this range the amplifier clearly begins to enter saturation, in particular above input voltages of \(\pm1.7\)~V. The linear fits shown include only the points between \(\pm1.2\)~V, excluding the first and last three points in the scan of input voltages, in order to not be biased by the effects of saturation.

Figure \ref{f:AmpOutvsDAC_residual} shows the residuals between the linear fit and the real amplifier output across the full range of input voltages. By looking at the residuals a slight deviation from linearity in the \(\pm1.2\)~V range is also visible, although the maximum difference is only 10~V or a 3\% relative error. At the maximum input voltage of \(\pm2\)~V the difference between the real output and the amplitude expected if the response was linear across the full range rises above 150~V, or a relative error of more than 25\%. For example, the RB output at an input voltage of \(+2\)~V is 605~V but the fitted response gives 769~V, a difference of 164~V or 27\%.

The effects of amplifier saturation are not taken in to account in the PFF algorithm on the FONT5a board, in which the DAC output is linearly dependent on the input phase (voltage from the phase monitor mixer signal) across the full range. The applied correction to the downstream phase will therefore be non-optimal when the DAC output calculated by the PFF algorithm is above an absolute value of 2500 counts (1.2~V sent to the amplifier). To date the non-linearity of the amplifier as it begins to enter saturation has also not been included in the PFF simulations presented in the following chapters. This may partially explain the small discrepancies seen between the simulated and real results in some datasets, so including the effect will be pursued in the future. In addition, it could be foreseen to incorporate the saturation characteristics in to the PFF algorithm on the FONT5a board, so that calculated outputs above 2500 counts are boosted slightly to compensate for the lower than expected amplifier output.

Discrepancies between the four amplifier outputs are also visible in Figure~\ref{f:AmpOutvsDAC_residual} and Table~\ref{t:AmpOutVsDAC}, both in terms of gradient and peak output. This can be partially but not completely explained by errors of up to a few percent in the precise calibration of the four monitoring outputs, which do not output exactly 1/115 of the real input voltage [TODO: Ask Colin about errors]. Differences between the A and B outputs sent to each kicker are not an issue for the PFF performance as both are linear (in the \(\pm1.2\)~V range) and the kick experienced by the beam in each kicker is proportional to the difference of the two. Therefore, only the calibration between the output from the FONT5a board sent to the amplifier and the resulting phase shift in the TL2 chicane is affected. However, disparity between the potential difference across each kicker (LA-LB and RA-RB), so that the deflection of the beam in each kicker is different, leads to the orbit bump created by the PFF system not being closed in the chicane, degrading the horizontal beam stability downstream. The fitted potential difference at 1~V input is 869~V for the left amplifier (LA-LB, sent to the first kicker) and 835~V for the right amplifier (RA-RB, sent to the second kicker), a difference of 4\%. This can be compensated in the PFF setup on the FONT5a board by using a different gain for each correction output, so that the voltage sent to the right amplifier is higher but the resulting output voltage sent to both kickers is the same. Orbit closure is discussed further in Section~\ref{ss:orbitClosure}.


\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmpOutvsDAC}
  \caption{Amplifier output vs. input.}
  \label{f:AmpOutvsDAC}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmpOutvsDAC_residual}
  \caption{Residual between amplifier output and linear fit.}
  \label{f:AmpOutvsDAC_residual}
\end{figure}

\begin{table}
  \begin{center}
    \begin{tabular}{| c | c |}
	   \hline
       Amplifier Port & Output at +1~V Input \\ \hline
       LA & \(+416\pm3\)~V \\
	   LB & \(-453\pm3\)~V \\
	   RA & \(-426\pm3\)~V \\
	   RB & \(+409\pm3\)~V \\
 	   \hline
    \end{tabular}
    \caption{Feedforward results using combined data from 20th November 2015.}
  	\label{t:AmpOutVsDAC}
  \end{center}
\end{table}

\subsection{Shape}
\label{ss:ampShape}

In the previous section the linearity of the mean output was considered but the performance of the PFF correction is clearly also sensitive to any variations in output voltage along the amplifier output pulse. Figures~\ref{f:ampLTraces} and \ref{f:ampRTraces} show the full 1.4~\(\mathrm{\mu}\)s amplifier output pulse at a constant \(+1\)~V input sent to the left amplifier and a constant \(-1\)~V input sent to the right amplifier respectively. Spikes in the signal just prior to 2000~ns and after 3000~ns on the time axis as seen in the plots are beam pickup induced by the beam passing through the kickers. These are therefore not a property of the amplifier performance and are excluded from the analysis in this section. However, the beam pickup is used later in Section~\ref{ss:absTiming} for the purposes of optimising the correction timing.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmpL_Traces}
  \caption{Amp L along pulse at 1 V input}
  \label{f:ampLTraces}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmpR_Traces}
  \caption{Amp R along pulse at 1 V input}
  \label{f:ampRTraces}
\end{figure}

For each side of the amplifier both the A and B outputs are plotted as well as the difference of the two, which is the relevant quantity in terms of the kick received by the beam as it traverses the kickers. In the ideal case the potential difference should be flat along the full pulse length. However, for both the left and right side variations in the difference are visible, with an initial increase in output across the first 500~ns of the pulse followed by a droop in response across the second half of the pulse. Although not shown here, the shape of the variations along the pulse is consistent across the full range of output voltages, and scale in magnitude with the output voltage. Figure~\ref{f:ampFlatness} shows the peak-to-peak and mean deviation of the output voltage along the pulse across the full range of input voltages. The peak-to-peak deviation refers to the difference between the minimum and maximum output along the pulse, whilst the mean deviation is the average absolute difference between the mean output and the output at each sample point. For a constant input voltage the output voltage along the pulse varies by up to 88~V peak-to-peak (mean 12~V) for the left amplifier or 93~V peak-to-peak (mean 14~V) for the right amplifier. As a relative difference, this corresponds to approximately a 6~\% peak-to-peak, or 1~\% mean, variation along the pulse.

The PFF algorithm on the FONT5a board uses a single gain value across the whole pulse length for each correction output, thus making the approximation that the amplifier response is flat along the pulse. The variations along the amplifier pulse therefore directly translate in to discrepancies between the intended phase shift as calculated and the real phase shift experienced by the beam. As the region of interest for the correction is a few hundred nanoseconds about the central part of the pulse, as opposed to the full pulse length, the 1~\% mean variation is more indicative of the resulting error than the 6~\% peak-to-peak variation. With a correction range (Section \ref{ss:corrRange}) of \(\pm6^\circ\), the effects of the non-flat amplifier output should be below \(0.06^\circ\) and not measurable considering the phase monitor resolution of \(0.14^\circ\). Nevertheless, it could be foreseen to implement a droop correction in the PFF algorithm on the FONT5a board, taking the variations in the amplifier output along the pulse in to account.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/AmpFlatness}
  \caption{Flatness of potential difference sent to kickers.}
  \label{f:ampFlatness}
\end{figure}

As for the mean output voltage, the second way variations in the amplifier output along the pulse can impact the PFF performance is via the orbit closure in the chicane. For this the relevant quantity is the sum of the potential difference sent to each kicker, or \((LA-LB)+(RA-RB)\). To ensure orbit closure this quantity, named the residual kick here, should be zero across the whole pulse length for all input voltages. Figure \ref{f:ampClosure} shows the residual kick along the pulse for all the input voltages in the scan. Clearly they are not all centred around zero, but this is expected due to the differences in the mean output voltage of the four amplifier outputs seen in the previous section. As already stated, the overall mean offset can be removed by using a different gain for the two correction outputs. However, any variations along the pulse cannot be compensated for in the PFF algorithm. The magnitude of the effect is summarised in Figure \ref{f:ampClosureFlatness}, showing the peak-to-peak and average deviation of the residual kick from flat. The overall residual kick is very flat and effect is smaller than any of those previously shown --- only up to 2~V on the mean or 21~V peak-to-peak. Whether this has any measurable effect on the orbit closure is discussed in Section \ref{ss:orbitClosure}.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/residualKick_Traces}
  \caption{Residual kick along pulse.}
  \label{f:ampClosure}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/residualKick_Flatness}
  \caption{Residual kick along pulse: deviation from flat.}
  \label{f:ampClosureFlatness}
\end{figure}

\subsection{Bandwidth}
\label{ss:ampBand}

[TODO: ask Colin if he has any plots?]

\newsection{daqSigProc}{Data Acquisition and Signal Processing}

\subsection{SiS Digitiser Setup}
\label{ss:sisSetup}

(already discussed in ph mon chapter)

\subsection{Acquisition Tools}
\label{ss:acqTools}

\subsection{Monitoring Tools}
\label{ss:monTools}

Online display

\subsection{Time Alignment of Signals}
\label{ss:timeAlignment}

\subsection{Definition of Zero Phase}
\label{ss:zeroPhase}



\newsection{constKicks}{Kicker and Optics Performance Verification}

\subsection{Correction Range}
\label{ss:corrRange}

Knowledge of the correction range of the PFF system, or more specifically the relationship between the voltage sent to the amplifier and the phase shift in the chicane, is critical for the PFF setup. The first checks of the ability to shift the phase in the TL2 chicane using the new phase feedforward optics were performed with magnetic correctors prior to the PFF amplifier being available (these correctors can be used to implement a secondary ``Slow Correction'' to complement the PFF system, as discussed in Section~\ref{s:slowCorr}). Aside from their use for the PFF correction, these tests and the clear variation with beam phase versus voltage sent to the PFF kickers shown in this section are already a significant achievement and a verification of the extensive work to improve the MADX model of TL2 presented in Chapter~\ref{c:tl2Optics}. 

Figure \ref{f:phaseVsAmpVoltage} shows the mean phase shift after the chicane (in the downstream phase monitor) across the full \(\pm2\)~V input range of the amplifier. Constant DAC outputs from the FONT5a board were sent to the amplifier in 17 steps between -4096 counts (-2~V) and +4096 counts (+2~V). In order to reduce the sensitivity to any drifts in the beam phase between data points the scan was taken in interleaved mode, alternating between pulses with no drive sent to the amplifier and a constant non-zero DAC output. The phase plotted in Figure \ref{f:phaseVsAmpVoltage} is therefore the difference between 50 kicked beam pulses and 50 ``nominal'' pulses taken at the same time for each amplifier input voltage. 

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/phaseVsAmpVoltage}
  \caption{Phase shift versus amplifier input voltage.}
  \label{f:phaseVsAmpVoltage}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/phaseVsAmpVoltage_residuals}
  \caption{Phase shift versus amplifier input voltage.}
  \label{f:phaseVsAmp_resid}
\end{figure}

\begin{table}
  \begin{center}
    \begin{tabular}{| c | c | c |}
	   \hline
        & Phase Shift at +1~V Input & Max Phase Shift \\ \hline
       Data & \(3.5\pm0.1^\circ\) & \(5.5\pm0.3^\circ\) \\
	   Model & \(3.6^\circ\) & \(5.6^\circ\) \\
 	   \hline
    \end{tabular}
    \caption{Phase shift at +1 volt input to the amplifier.}
  	\label{t:PhaseVsDAC}
  \end{center}
\end{table}

At the maximum amplifier input voltage of \(2\)~V the phase after the chicane is shifted by \(5.5\pm0.3^\circ\). The fitted phase shift per Volt sent to the amplifier is \(3.5\pm0.1^\circ\) in the \(\pm1.2\)~V linear range of the amplifier (excluding the first and last three points, blue ``FIT'' line in Figure~\ref{f:phaseVsAmpVoltage}). This fitted gradient is required and was previously introduced for the conversion between the PFF gain in the units on the FONT5a board and the real applied gain in Section~\ref{ss:pffFirmware}. In Section~\ref{ss:pffFirmware} it was quoted in terms of the phase shift in radians per DAC count output from the FONT5a board, rather than degrees per Volt as shown here. The value of \(30\mathrm{\mu rad/count}\) is easily derived using the conversion factors between degrees and radians and knowing that a DAC output of 4096 counts corresponds to 2~V sent to the amplifier.
[TODO: Calculated factor is 29.827 microradians/count here. One I actually used for gain conversion, simulations etc. was 26.18 (used full range rather than linear range)]

Given knowledge of the amplifier output characteristics (Section~\ref{ss:ampLin}), the kicker specifications (Section~\ref{ss:kickers}) and the chicane optics (Section~\ref{ss:pffMatched}) the real phase shift seen in the scan can be compared to the expected phase shift based on the system parameters. The predicted phase shift, \(\Delta\phi\), in degrees is given by:
\begin{equation}
 	\Delta\phi = V_{amp}[V_{font}].K.R_{52}.\frac{360}{\lambda_{12\mathrm{GHz}}}
\end{equation} 
\label{e:ampVoltToPhase}
Where \(V_{amp}[V_{font}]\) is the amplifier output Voltage at an input voltage of \(V_{font}\) sent from the FONT5a board, \(K\) is the angular deflection of the beam per Volt applied to each kicker strip, \(R_{52}\) is the \(R_{52}\) value between the kickers in the PFF optics and \(\frac{360}{\lambda_{12\mathrm{GHz}}}\) converts the calculated orbit length difference in to an equivalent 12~GHz phase using the 12~GHz wavelength \(\lambda_{12\mathrm{GHz}}\). The value of most of these parameters has already been derived in the sections previously mentioned. They are:
\begin{eqnarray*}
V_{amp}[1~\mathrm{V}] = 435~\mathrm{V} \\
K = 0.8~\mathrm{\mu rad/V}\\
R_{52} = -0.7~\mathrm{m}\\
\lambda_{12\mathrm{GHz}} = 2.5~\mathrm{cm} 
\end{eqnarray*}
The value of \(V_{amp}[1~\mathrm{V}]\) is given as a representative value in the linear range of the amplifier but the real amplifier output at all input voltages is used in the predictions to include the effects of saturation in the calculated phase shift values. Also, the output sent to the first kicker (from the left side of the amplifier) is used as this is most relevant for the phase shift in the chicane (the orbit should be closed after the second kicker with no further phase shift in the chicane after that point). The value of \(K\) is derived from the kicker design, in which 1.4~kV applied to each strip gives a 1~mrad kick for a 150~MeV beam [TODO: REF].  The actual CTF3 beam energy at this time was approximately 135~MeV (calculated based on the dipole currents used in the machine setup), so the value of \(K\) above is scaled by a factor 150/135.

In Figure~\ref{f:phaseVsAmpVoltage} the red line ``MODEL'' shows the predicted phase shifts using Equation~\ref{e:ampVoltToPhase}. Table~\ref{t:PhaseVsDAC} compares the fitted gradients and maximum phase shift for the model and real data. The overall agreement between the two is good, with the residuals between both the model and the data, as well as the linear fit to the data and the data, generally consistent with zero within error bars in the \(\pm1.2\)~V linear range of the amplifier as shown in Figure~\ref{f:phaseVsAmp_resid}. 

Outside the linear range some discrepancies appear, although at the maximum \(\pm2\)~V output the agreement is good so the effect is largest where the amplifier is entering saturation but before hard saturation is reached. However, most amplifier effects can be excluded as the analysis in this section uses the same dataset that was used to characterise the amplifier performance in Section~\ref{s:amplifierSetup}. This could hint at possible remaining higher order errors in the TL2 chicane optics, or unexpected behaviour from the kickers or amplifier. Although subtracting alternating, interleaved pulses should remove the sensitivity to drifts in the machine it is possible that some residual effect remains. To determine whether the discrepancies are reproducible further scans of this type will need to be completed in the future. The residuals between between the data and the linear fit between \(\pm1.2\)~V would also be of significance for the PFF correction should they not converge to zero with additional measurements, as they are of similar magnitude to the \(0.2^\circ\) downstream jitter target. 

However, the overall conclusion is as expected --- the phase shift in the chicane linearly depends on the amplifier input in the \(\pm1.2\)~V (\(\pm2500\) DAC counts) region thus a close to optimal correction can be applied in this range, corresponding to a \(\pm4.2\pm0.1^\circ\) phase shift. However, when the calculated optimal correction is between an absolute input voltage of 1.2~V and 2.0~V, 2500 to 4096 DAC counts, or \(\pm4.2\pm0.1^\circ\) to \(\pm7.0\pm0.2^\circ\), the actual phase shift in the chicane is lower, only up to \(\pm5.5\pm0.3^\circ\), due to the amplifier entering saturation (and possibly other effects to be determined ). Any calculated correction outside \(\pm5.5\pm0.3^\circ\) receives a static phase shift of \(\pm5.5\pm0.3^\circ\) in the chicane. In the limit where all pulses are outside this range the PFF system can only induce a static shift in the mean phase and makes no improvement to the phase jitter. Understanding the impact of the limited correction range on the PFF results was particularly critical for interpreting the early correction attempts with the first version of the amplifier, giving approximately half the ranges shown in this section. This is discussed using simulations of the PFF system in Chapters~\ref{c:earlyFFSim} and \ref{c:feedforward}.

http://accelconf.web.cern.ch/accelconf/ipac2011/papers/tupc007.pdf
1.4 kV to each strip = 1 mrad kick at 150 MeV
1.26 kV to each strip = 1 mrad kick at 135 MeV

\subsection{Variations Along Pulse}
\label{ss:kickPulseVar}

[TODO: In this section I intended to check the stability of the constant kick along the pulse, as I did for the "Shape" section with the amplifier above. The results from the constant kick data do not look good, though - the errors are quite large and there are some nasty oscillations along the pulse, such as in the example Figure~\ref{f:phaseShiftAlongConstKick}. With the phase stability downstream a much longer scan would probably be needed to draw conclusions here, though even on longer time scales I think it needs to be checked that the difference between odd and even pulses converges to zero. As it is I would probably choose to skip this section, or possibly just show one of the better plots.]

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/phaseShiftAlong}
  \caption{Traces relative timing scan.}
  \label{f:phaseShiftAlongConstKick}
\end{figure}

\subsection{Shape}
\label{ss:kickShape}

[TODO: The purpose of this section is to compare the shape of the given kick to the upstream phase - i.e. compare the upstream phase to the amplifier monitoring output and the difference in the downstream phase with PFF off and on. Again here my first attempts produced results that were not as I'd like, without particularly good agreement between the difference in the downstream phase and the upstream phase shape. Looks kind of like the two are rotated with respect to each other. More analysis needed here to check more thoroughly. I think this section should definitely be included, but I need either an explanation for the differences or to find datasets where the agreement is much better.]

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/pffKickShape}
  \caption{Traces relative timing scan.}
  \label{f:pffKickShape}
\end{figure}

\subsection{Orbit Closure}
\label{ss:orbitClosure}

At CLIC the PFF system must not degrade the transverse beam stability. This means for any voltage sent to the kickers the horizontal beam orbit after the PFF chicane must be unchanged, or closed, despite the different orbits inside the chicane. As such, the PFF optics for the TL2 chicane at CTF3 is also designed to give a closed kick, as presented in Section~\ref{ss:pffMatched}. However, up until now the main focus during PFF operation has been the primary goal of reducing the downstream phase jitter and ensuring good beam transmission to the downstream phase monitor. As a result orbit closure after the TL2 chicane has not yet been strictly enforced during PFF operation as will be seen in this section, but the current status is shown here as an additional cross-check of the PFF optics and to highlight where improvements are needed for future tests.

Using the same constant kick data as Section~\ref{ss:corrRange} Figure~\ref{f:HOrbitVsInput} shows mean the horizontal orbit before, inside and after the TL2 chicane across the full \(\pm2\)~V range of inputs sent to the amplifier. The vertical black lines on the plot mark the approximate location of the entry to the chicane (index CC.500) and the exit of the chicane (index CC.800), with the two kickers being located at CC.480 and CC.780. Two BPMs before and after the chicane, as well as the four inside the chicane, are included. The plotted positions are the difference between the kicked and nominal (non-kicked) orbit at each BPM, thus removing any misalignment in the BPM centres. Before the chicane and the first kickers there is no significant effect on the orbit as expected. Inside the chicane the PFF system induces an orbit offset of up to \(1.4\pm0.1\)~mm. After the chicane, in BPMs CC.845 and CC.930, the orbit should return to zero in the ideal case. However, a clear residual offset can be seen, up to \(0.5\pm0.1\)~mm in CC.930.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/HOrbitVsInput}
  \caption{Horizontal orbit offset in and around the TL2 chicane at different input voltages sent to the amplifier.}
  \label{f:HOrbitVsInput}
\end{figure}

During this scan the input sent to both sides of the amplifier was the same magnitude. However, in Section~\ref{ss:ampLin} it was seen that the right side of the amplifier, sent to the second kicker, gave 4\% lower output than the left side. This could explain why the orbit after the chicane was not closed during this scan, and during PFF operation which has typically used equal gain for both correction outputs to date. Figure~\ref{f:orbClosureVsAmpModel} shows the expected orbit in the TL2 chicane in the case where both kickers are driven with the same voltage (``nominal optics'') and with the 2nd driven with a 4\% lower voltage (``real amplifier ratio'').
\footnote{The term ``nominal optics" is used in this section to refer to the nominal PFF optics, not the nominal optics created in Chapter~\ref{c:tl2Optics} to use when the PFF system is not under operation.}
The full MADX orbit propagated through all elements is shown, with the eight real measured BPM offsets also included at their respective positions. Each BPM point represents the gradient of a linear fit using the variation with input voltage seen previously in Figure~\ref{f:HOrbitVsInput}. Before and inside the chicane the agreement between the BPM data and the model is excellent. As seen before, the BPM orbit is not closed after the chicane, unlike the nominal optics. If the actual kicker voltage ratio is taken in to account the MADX orbit after the chicane is not closed either, but the offset has opposite polarity to the real data in the last BPM.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/orbClosureVsAmpModel}
  \caption{Orbit in the TL2 chicane at 1~V amplifier input for the BPM data, nominal model and model taking in to account the difference in amplifier output voltage to each kicker.}
  \label{f:orbClosureVsAmpModel}
\end{figure}

The true explanation for the non-closed orbit is that the quadrupole strengths used in the machine setup are not exactly nominal. Although every effort has been made to keep the TL2 optics as close to nominal as possible, particularly inside the chicane, it is an extremely sensitive area for the setup of CTF3 and beam transport in to the CLEX area downstream of TL2 (including the location of the downstream phase monitor in the TBL line) is always difficult. Minor modifications have therefore been necessary in order to achieve full beam transmission to the downstream area, both for PFF and other experiments at CTF3. The largest changes have been made to the four quadrupoles following the chicane but one quadrupole inside the chicane, CC.IQFL0730 (just prior to the 2nd kicker) has a set value \(10\%\) lower than the nominal optics, as well as differences up to \(2\%\) in the other quadrupoles. Using the real quadrupole strengths used in the machine gives the result shown in Figure \ref{f:orbClosureVsQuadModel}. In this case the agreement between the model and the data is also extremely good after the chicane. It may still be possible to compensate for these differences by outputting different voltages to each kicker and this will be investigated. Alternatively, a completely nominal optics can be set in the chicane purely for the purposes of verifying orbit closure, reverting back to non-nominal optics and closure if needed to achieve good beam transmission for normal PFF operation.

[TODO: Not enough detail r.e. why beam transport there is difficult etc.?]

[TODO: Do have data with different ratios of kicker strengths. Can analyse to see effect on closure. Considering quad currents don't think it adds anything to discussion here, though.]

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/orbClosureVsQuadModel}
  \caption{Orbit in the TL2 chicane at 1~V amplifier input for the BPM data, nominal model and model taking in to account the quadrupole currents in the real machine setup.}
  \label{f:orbClosureVsQuadModel}
\end{figure}

[Comment for Piotr: With these quad currents also expect to see some dispersion leaking  out of the chicane. Up to 0.3 m in girder 9.]

\newsection{timing}{Correction Output Timing}

All the results based on the amplifier outputs and kicked beam presented so far have used a constant output voltage sent from the FONT5a board across the full \(1.4~\mathrm{\mu s}\) time window that the amplifier is powered for. As the \(1.4~\mathrm{\mu s}\) amplifier output sent to the kickers is much longer than the \(1.1~\mathrm{\mu s}\) CTF3 beam pulse it is easy to ensure that the full length of the pulse experiences the constant kick with this setup. However, for operation of the PFF system precise control of the correction output timing becomes critical. In order to remove phase variations along the pulse with the PFF system the output correction signal, shaped by the upstream phase, must arrive at the kickers exactly in sync with the beam. Any timing misalignment between the beam and correction signal arrival will result in residual oscillations along the pulse in the downstream phase, even in the case where the upstream-downstream phase propagation is perfect. Approximating the phase sag along the pulse to be quadratic, \(\phi_{u}(t) \sim \phi_{d}(t) \sim t^2\), a misaligned correction would yield a corrected downstream phase with a linear increase in phase along the pulse with time, \(\phi_{PFF}(t)~\sim~\phi_d(t)-\phi_u(t+\delta)~\sim -2\delta t - \delta^2\), for example, where \(\phi_{PFF}\) is the corrected phase, \(\phi_{d}\) the uncorrected downstream phase, \(\phi_{u}\) the upstream phase, \(t\) the time and \(\delta\) the time misalignment in the applied correction. Also, the effect is particularly significant for any higher frequency variations in phase along the pulse. If a 40~ns oscillation is present in the upstream phase but the correction is applied with a 50~ns delay, for example, a second 40~ns oscillation with opposite sign would be introduced to the ``corrected'' downstream phase at a later time with no change to the initial oscillation. Although the effects are most visible along the pulse, any timing delay will also degrade the achievable mean phase jitter. This section gives an overview of the main methods that have been used to ensure that the correction output to the two kickers arrives in time with the beam. 

\subsection{Kicker Cable Lengths}
\label{ss:kickerCables}

The cables carrying the correction signal between the PFF amplifier and the kickers in the TL2 chicane are the single largest contributor to the overall system latency. They must be routed from the PFF electronics racks (in the klystron gallery, one floor and directly above the location of the upstream phase monitors), down in to the machine hall and across the width of the CTF3 facility to the TL2 chicane. The initial kicker cables installation used pre-existing cable trays and gave a signal transit time of 260~ns, with a signal speed of 0.66~c and approximate lengths of 50~m. This is more than two thirds the overall PFF latency budget, which must be lower than the 380~ns beam time of flight between the upstream phase monitor and the first kicker. Considering the latencies of the various pieces of hardware in the PFF system chain as well as the cables between the upstream phase monitors and the PFF electronics (Section~\ref{ss:availLatency}), the overall PFF system latency would have been in excess of the \(380\)~ns beam time of flight with this setup. By re-routing the cables on to a dedicated pathway and trimming any remaining slack it was possible to reduce the cable lengths by up to 90~ns, bringing the system within the latency budget as will be seen in the following sections. Precise measurements of the cable lengths with this setup are presented in this section, as well as their significance beyond ensuring the system is within the latency requirements.

With two kickers, two strips per kicker and two ends of each strip a total of eight cables are needed. The drive from the amplifier is sent to the downstream end of each kicker strip, traverses the kicker, and is then terminated back at the amplifier after leaving the upstream end. Drive is sent to the downstream end of each kicker (meaning it propagates through the kicker in the opposite direction to the beam) so that the electric and magnetic fields between the strips are in the same direction, as discussed in Section~\ref{ss:kickers}. Rather than being connected directly to the amplifier, the eight kicker cables are connected to a patch panel below the amplifier in the PFF electronics racks. Eight additional cables, around 70~cm in length, are used to connect the amplifier outputs to the patch panel. This is in order to create a tidier cabling setup in the rack as well as making changes to the amplifier cabling easier, when necessary. [TODO: Picture]. The kicker cables are of type [TODO: REF] with HN-type connectors and the patch panel cables of type [TODO: REF] with N-type connectors to match the amplifier.

The length of the eight kicker cables and eight patch panel cables has been measured using time domain reflectometry (TDR) on a network analyser [TODO: REF?]. The network analyser is used to send a short pulse down the cable,  with one end of the cable connected to the network analyser and the other end disconnected so it is not correctly terminated. As the signal reaches the (non-terminated) end of the cable the discontinuity in impedance creates a reflected signal that propagates back to the network analyser. The time difference between when the signal was output and when the reflected signal arrives back at the network analyser therefore corresponds to double the one-way signal transit time in the cable. [TODO: Example TDR plot?] 

Table~\ref{t:shortCabLengths} shows the patch panel cable lengths and Table~\ref{t:kickCabLengths} the kicker cable lengths that were determined with this method. Quoted errors of \(\pm0.05\)~ns are estimated based on the sampling rate of the measurement. The amplifier port, patch panel port and kicker strip that the cables are connected to are also shown in the table, as well as their corresponding CTF3 identifying number for reference. For the amplifier port labels the three letters correspond to:
\begin{itemize}
\item Whether the cable is connected to the \textbf{L}eft or \textbf{R}ight side of the amplifier.
\item  Whether the cable is connected to the amplifier \textbf{A} or \textbf{B} outputs on that side.
\item Whether the cable is connected to the amplifier \textbf{D}rive or \textbf{T}erminator.
\end{itemize}
And for the kicker strip labels the three letters correspond to:
\begin{itemize}
\item Whether the cable is connected to the first (\textbf{1}) or second (\textbf{2}) kicker.
\item  Whether the cable is connected to the \textbf{U}pstream or \textbf{D}ownstream end of the kicker strip.
\item Whether the cable is connected to the \textbf{L}eft or \textbf{R}ight kicker strip, as viewed looking at the upstream end of the kicker.
\end{itemize}
Finally, the patch panel connectors are simply labelled from 1 to 8 from left to right, as viewed from the front of the rack. All of the cable connections between the amplifier, patch panel and kickers are shown in Figure~\ref{f:kickerCables}.

\begin{table}
  \begin{center}
    \begin{tabular}{| c | c | c | c | c |}
	   \hline
       Label & Length & Amplifier Port & Patch Panel Port \\ \hline
       2907701B & \(2.99\pm0.05\)~ns & LAT & 1 \\
       2907703B & \(3.03\pm0.05\)~ns & LBT & 2 \\
       2907700B & \(3.03\pm0.05\)~ns & LAD & 3 \\
       2907702B & \(3.01\pm0.05\)~ns & LBD & 4 \\
       2907838B & \(3.03\pm0.05\)~ns & RAD & 5 \\
       2907740B & \(3.05\pm0.05\)~ns & RBD & 6 \\
       2907739B & \(3.03\pm0.05\)~ns & RAT & 7 \\
       2907741B & \(3.03\pm0.05\)~ns & RBT & 8 \\
 	   \hline
    \end{tabular}
    \caption{Lengths of cables between the amplifier and the patch panel.}
  	\label{t:shortCabLengths}
  \end{center}
\end{table}

\begin{table}
  \begin{center}
    \begin{tabular}{| c | c | c | c | c |}
	   \hline
       Label & Length & Patch Panel Port & Kicker Strip \\ \hline
       2907701A & \(171.28\pm0.05\)~ns & 1 & 1UL \\
       2907703A & \(171.30\pm0.05\)~ns & 2 & 1UR \\
       2907700A & \(171.29\pm0.05\)~ns & 3 & 1DL \\
       2907702A & \(171.30\pm0.05\)~ns & 4 & 1DR \\
       2907838A & \(205.45\pm0.05\)~ns & 5 & 2DL \\
       2907740A & \(205.62\pm0.05\)~ns & 6 & 2DR \\
       2907739A & \(205.15\pm0.05\)~ns & 7 & 2UL \\
       2907741A & \(204.49\pm0.05\)~ns & 8 & 2UR \\
 	   \hline
    \end{tabular}
    \caption{Lengths of cables between the patch panel and the kickers.}
  	\label{t:kickCabLengths}
  \end{center}
\end{table}

The patch panel cables all have lengths of around 3~ns, with the lengths of each matched to within the measurement error. After the re-routing and shortening of the kicker cables the cables connected to the first kicker have a length of around \(170\)~ns, whilst the cables for the downstream kicker are longer at around \(205\)~ns. For the downstream kicker the latency requirements are slightly relaxed due to the additional 36~ns beam time of flight between the kickers. Rather than also shortening the downstream kicker cables as much as possible some additional slack was left so that the difference in lengths is similar to the difference in the beam time of flight between the two. This means the two correction outputs (one for each kicker) can be sent from the FONT5a board at, or close to, the same time as discussed in Section~\ref{ss:relativeTiming}.

Although all the upstream kicker cables are matched within the measurement error there are some differences in the downstream kicker cable lengths, with cable 2907741A more than 1~ns shorter than cable 2907740A, for example. If there is a difference between the lengths of the cables connected to the downstream left and downstream right strips of a kicker (the driven end) there will be a time offset in the voltage applied to each side of the kicker, which would degrade the quality of the PFF correction. However, there is no need for the cables connected to the upstream ends of the kickers to be of matched lengths, the only requirement is that they are terminated correctly at the amplifier. The shorter 2907741A cable is therefore connected to the upstream end of the second kicker, and the cables 2907838A and 2907740A, with lengths matched to within 200~ps, are used to carry the amplifier output to the downstream end of the strips.

[TODO: Tolerances for cable length matching?]






\subsection{Absolute Timing}
\label{ss:absTiming}



\subsubsection{Using Beam Pickup}
\label{sss:beamPickup}

[TODO: Kicker pick-up theory. In particular, is time between pickup exactly the beam pulse length or is it longer by double the kicker length?]

Figure~\ref{f:beamPickup_noKick} shows the beam pickup at the start and end of the pulse from the PFF kickers at CTF3, as seen on one of the amplifier monitoring outputs (each of the four amplifier monitoring outputs, one for the upstream end of each strip prior to the signal being terminated at the amplifier, gives a similar response). The separation of the peaks in the beam pickup is \(1.1~\mathrm{\mu s}\), thus the same as the CTF3 pulse length as expected. By comparing the timing of these peaks with respect to the start and end of the amplifier output pulse, using the same amplifier monitoring signal, it is possible to ensure that the correction output arrives in sync with the beam.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/beamPickup_noKick}
  \caption{Beam pickup on kicker strips as seen on amplifier monitoring signals.}
  \label{f:beamPickup_noKick}
\end{figure}

An example of this is shown in Figure~\ref{f:absDelay0_all}. A constant DAC output is sent from the FONT5a board to the amplifier and both this output pulse and the beam pickup, at samples 275 and 493, are visible in the figure. Importantly, the DAC output is gated using the upstream phase monitor diode signal (in other words, the constant DAC output is only sent during the time when the diode is non-zero) and this has two consequences. Firstly, the amplifier output pulse has the same length as the beam pulse in the upstream phase monitor. Secondly, the timing of the output is identical to what it would be in normal PFF operation. In the case of Figure~\ref{f:absDelay0_all} the drive to the amplifier is sent as quickly as possible after the arrival of the upstream diode signal at the FONT5a board. It can be seen that the amplifier pulse arrives before the beam pickup, thus with the PFF system setup this way the correction would be applied slightly early. This result therefore proves that the PFF system just meets the latency requirements, with the overall time needed to transport and process all the relevant signals a few tens of nanoseconds less than the 380~ns time of flight of the beam between the upstream phase monitor and the first kicker. However, what is also clear in the figure is that the time offset between the start of the amplifier pulse and the first beam pickup spike is much larger than the time difference between the end of the amplifier pulse and the second beam pickup spike. This is due to the energy transient across the first 100~ns of the CTF3 beam pulse which is present in the upstream phase monitor but is then lost prior to the TL2 chicane, predominantly in TL1. As a result the downstream beam pulse is shorter than the upstream beam pulse which defines the length of the correction output. Therefore, in order to align the correction output with the beam the signals from the end of the amplifier and beam pulses must be used, not the start.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absDelay0_all}
  \caption{Output delay of 0 clock cycles. Full pulse.}
  \label{f:absDelay0_all}
\end{figure}

The firmware for the FONT5a board includes an output delay parameter that can be used to fine-tune the timing of the correction output sent to the amplifier. This can be done independently for each of the two correction outputs so that it can be ensured the correction arrives in sync with the beam in each kicker individually (the relative timing of the two kickers is discussed in the next section). The delay can be varied between 0~and~31~clock~cycles in integer steps, with one clock cycle corresponding to one period of the 357~MHz ADC clock frequency, or 2.8~ns. A delay of up to 86.8~ns can therefore be added to the correction outputs. Figure~\ref{f:absDelayAll_endPulse} shows the effect of varying the output delay across the full range of possible values, zoomed in on the end of the pulse. For all output delays the beam pickup remains at sample 493, as expected. Meanwhile, the end of the amplifier pulse is moved from before the beam pickup (output too early) to after the beam pickup (output too late). To achieve the optimal correction timing the end of the amplifier pulse must be aligned with the beam pickup and this is achieved with a delay of 7~clock~cycles, or 19.6~ns, as shown in Figures~\ref{f:absDelay7_all}~and~\ref{f:absDelay7_end}. This delay has been used for the latest PFF runs presented in Chapter~\ref{c:feedforward}. Due to ambiguity in which point along the falling edge of the amplifier pulse the beam pickup should be aligned to there may be a remaining error of up 3 clock cycles in the exact alignment, and this can only be verified by beam based measurements (not using the amplifier monitoring outputs). 

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absDelayAll_endPulse}
  \caption{Output delay scan, end of pulse.}
  \label{f:absDelayAll_endPulse}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absDelay7_all}
  \caption{Output delay of 7 clock cycles. Full pulse.}
  \label{f:absDelay7_all}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absDelay7_end}
  \caption{Output delay of 7 clock cycles. End of pulse.}
  \label{f:absDelay7_end}
\end{figure}


\subsubsection{Using BPMs}
\label{sss:relativeBPM}

This section presents one way in which the correction output timing can be determined using a combination of the phase monitor measurements and a BPM signal downstream of the TL2 chicane. The results shown here were performed with the first, lower power version of the amplifier and the FONT5 rather than the later FONT5a board, and because of this the optimal output delay calculated here does not agree with the value of 7~clock~cycles from the beam pickup based measurement above. The newer hardware has the same latency as the previous versions, thus the difference does not come from hardware changes but rather associated changes to cabling between the phase monitor electronics, FONT5a board and amplifier. The measurement will be repeated in the future to verify that both methods give consistent results when the same hardware and cabling setup is used.

The FONT5 (and FONT5a) board firmware provides the functionality to be able to change the gain of each PFF correction output independently. This means it is possible to apply the correction to only one kicker, or to kick the beam in the same direction in each kicker (i.e. to use the same sign for the gain in each kicker, rather than gains with equal magnitude but opposite sign). In both of these cases the kicked PFF orbit in the chicane is not closed, thus the horizontal position along the beam pulse in a BPM after the chicane depends on the shape and timing of the applied correction.\footnote{In Section~\ref{ss:orbitClosure} it was shown that the corrected orbit is not perfectly closed in normal PFF operation either. However, in this case no attempt at orbit closure is made so the measured effect seen in the BPMs is much larger.}

Figure~\ref{f:absTimBeam_d0} compares the upstream phase, downstream phase and horizontal position (in a BPM after the TL2 chicane) along the pulse in the case where the PFF correction is applied with gains set to kick the beam in the same direction in each kicker, and with no output delay applied in the FONT5 board. The data is taken in interleaved mode, with the plotted phases shown using the PFF off data and the BPM trace being the difference between the PFF on and PFF off data. Each signal is scaled and sign flipped where necessary to give variations along the pulse with the same magnitude and sign, in arbitrary units. The BPM and phase monitor signals are acquired with the same sampling frequency of 192~MHz, with each aligned so that the end of the pulse is at the same sample number. 

By taking the difference of the PFF off and PFF on data in the BPM any residual orbit variations along the pulse not related to the PFF system are removed, thus the remaining shape should match that of the PFF correction output, which in turn is linked to the upstream phase. The downstream phase should also have the same shape as the upstream phase with the PFF system off, within the limits of the upstream-downstream phase correlation achieved at this time. During this measurement many oscillations along the upstream phase were present, which usually are not desired but for this measurement are perfect points of reference to check the time alignment of the signals. As expected the overall shape of the residual horizontal position in the BPM along the pulse and the two phase signals is very similar. The largest feature in the upstream phase that is present in all three signals occurs at sample 671 in the upstream phase, with the location of the peak of this oscillation in the phase signals and the BPM marked by vertical black lines in the figure. The peak as seen in the BPM signal is clearly before the peak in the phase monitor signals thus in this case the correction was applied early, with a measured offest of -36~ns between the peaks.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absTimBeam_d0}
  \caption{Kick output with no delay as seen on BPM and phase signals.}
  \label{f:absTimBeam_d0}
\end{figure}

This measurement was repeated with four different correction output delays applied in the FONT5 board, at delays of 0, 10, 20 and 30~clock~cycles (0 to 84~ns), which includes points where the correction is applied both early and late. Fitting the measured time offset between the peaks in the BPM and the phase in the same way as before yields an optimal correction output delay to apply of \(39\pm7\)~ns (Figure \ref{f:absTimBeam_fit}), or \(14\pm3\)~clock~cycles. Applying this delay in data analysis gives the result shown in Figure~\ref{f:absTimBeam_opt}, in which the similarity of the three signals becomes clear.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absTimBeam_fit}
  \caption{Fit time offset between kick and beam at different output delays.}
  \label{f:absTimBeam_fit}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/absTimBeam_opt}
  \caption{Alignment between BPMs and phase signals with optimal delay applied in analysis.}
  \label{f:absTimBeam_opt}
\end{figure}


\subsection{Relative Kicker Timing}
\label{ss:relativeTiming}

For the phase correction the absolute output timing sent to the first kicker, as derived above, is the most critical as this defines the alignment of the applied phase shift in the chicane with the beam. The second kicker's main purpose is then to close the kick created by the first, ensuring the orbit after the chicane is closed (with the caveats already mentioned in Section~\ref{ss:orbitClosure}). For the purposes of orbit closure it is also important to ensure that the correction arrives at the second kicker in time with the beam. As discussed in Section~\ref{ss:kickerCables} the beam time of flight between the kickers is about 36~ns, thus the correction must arrive at the second kicker 36~ns later than the first kicker. Most of this difference should be accounted for by the longer cable lengths for the second kicker, but the precise relative timing is checked here. In this context the relative timing means the additional output delay that must be applied to the FONT5a correction output for the second kicker with respect to the first in order to ensure the correction is aligned in time with the beam in both kickers.

Figure~\ref{f:relDelay_sim} shows a simulated example of the expected effect of kicking the beam with a relative time offset in each kicker, in this case with the output to the second kicker arriving later than the first kicker (with respect to the beam pulse). The kickers are driven with opposite polarity in the same way as the PFF system, and the first kicker is shown with a larger output than the second. The total kick received in the chicane is given by the sum of the two, shown in black. In the ideal case the total/residual kick in the chicane should be zero so that the orbit is closed after the chicane. However, with a timing offset between the two kickers there are large peaks in the residual kick at the start and end of the pulse, where only one of the two kickers receives its full drive. Due to the different amplitude of the two kickers the residual kick is also non-zero in the central part of the pulse. With well-aligned timing the residual kick would be constant along the full pulse length, or zero across the full pulse length if the kicks had matched amplitudes.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/relDelay_sim}
  \caption{Simulated response to offset kicks.}
  \label{f:relDelay_sim}
\end{figure}

By varying the relative timing of the two correction outputs on the FONT5a board (K1 and K2 delay) and using a BPM after the TL2 chicane to measure the size of the peaks at the start and end of the pulse resulting from the offset kicks (in the same way as Figure~\ref{f:relDelay_sim}) the optimal relative delay can be determined. The optimal relative delay is the point that minimises the size of the peaks on the rising/falling edge of the pulse, with the peak magnitude  approximately linearly dependent on the delay. Figure~\ref{f:relDelay_traces} shows the result of doing this, using a constant DAC output from the FONT5a board applied across a 168~ns portion of the pulse. The horizontal position in a BPM after the TL2 chicane is plotted for relative K2 delays ranging between -10 (K1 output delayed with respect to K2) to +10 (K2 output delayed with respect to K1) clock~cycles. Aside from the asymmetry between the size of the peaks at the start and end of the pulse the result is as expected from the example previously discussed. [TODO: Why asymmetry? Differences in output along pulse?]. Note the non-zero position offset in the central part of the pulse. Based on the orbit closure results in Section~\ref{ss:orbitClosure} this is predominantly due to optics differences leading to a non-closed orbit, rather than the small difference in amplifier output voltage to each kicker.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/relDelay_traces}
  \caption{Measured BPM offset for different relative kick delays.}
  \label{f:relDelay_traces}
\end{figure}

Figure~\ref{f:relDelay_fit} then shows the peak beam offset in the BPM versus the relative K2 delay using the falling edge of the pulse. The peak beam offset is defined as the difference between the maximum and minimum beam position after the chicane between sample 458 and 477 (as seen in Figure~\ref{f:relDelay_traces} [TODO: Add vertical lines to show ranges?]). As the K2 delay approaches the optimal value the difference in beam position in this range converges to the 0.3~mm offset in the flat central part of the kicked pulse. The point of intersection between the two linear fits shown (one for the points with a positive peak position and the other for points with a negative peak) gives the optimal relative K2 offset to be \(0.1\pm0.5\)~clock~cycles. Repeating the procedure for the peaks at the rising edge of the pulse gives a result of \(1.9\pm2.0\)~clock~cycles, and the two results combine to give an optimal value of \(0.5\pm0.6\)~clock~cycles.

\begin{figure}
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/commissioning/relDelay_fit}
  \caption{Fitted peak BPM offset vs. relative kick delay.}
  \label{f:relDelay_fit}
\end{figure}

Relative K2 delays of both 0 and 1 clock~cycles have been used during PFF operation, with no measurable difference in the PFF results between the two to date although this will have to be verified with further orbit closure tests. Adding the absolute delay of 7~clock~cycles derived in Section~\ref{ss:absTiming}, the final delays to apply in the FONT5a board are:
\begin{itemize}
\item \textbf{K1 delay}: 7 clock~cycles.
\item \textbf{K2 delay}: 7 or 8 clock~cycles.
\end{itemize}

%\newsection{corrBandwidth}{Correction Bandwidth}





 \newchapter{feedforward}{PFF System Performance}

Over the course of 2014 and 2015 much experience has been gained with the PFF system and vast improvements have been made to the system setup, hardware performance and beam conditions as discussed in previous chapters. In all cases a reduction in downstream phase jitter has been achieved. This chapter presents and discusses the performance of the PFF system in the context of the results achieved under the best overall conditions achieved to date at CTF3 \footnote{The datasets shown in this chapter were taken on 20th November 2015. Recently, in 2016, it has been possible to reproduce the lowest phase jitter result presented here, but this is beyond the scope of the this thesis.}.

%Many datasets have been taken, in particular in December~2014, July~2015 and November~2015, and

%The purpose of this chapter is to present and discuss the downstream phase stability that was accomplished on the 20th November 2015, the day during which the best overall conditions to date for the PFF correction were obtained.

\newsection{jitterRecord}{Stabilisation of Phase Jitter}

The results presented here show the best corrected downstream phase jitter obtained to date at CTF3 with the PFF system. Naturally, this was only possible after the vast improvements and optimisations presented throughout the rest of the thesis. The data was taken during the best beam conditions currently achieved at CTF3 in terms of phase propagation, following a series of R56 and beam energy optimisations using the same methods discussed in Chapter~\ref{c:phasePropagation}. %In particular, the first attempt to smooth the upstream phase along the pulse by adjusting the waveform of the first klystron in the CTF3 injector (MKS02) as described in Section~\ref{ss:t566Mitigation} yielded the highest upstream-downstream phase correlation achieved to date in normal conditions.
%(higher correlations can be achieved by adding an additional jitter source upstream, as seen in Section~\ref{s:pffNovelSetups}).
At the same time the phase monitor resolution was improved to below \(0.2^\circ\) after switching to mechanical phase shifters (Section~\ref{s:shifters}). Finally, updates to the kicker amplifiers (Section~\ref{s:amplifierSetup}), which doubled the correction range compared to earlier tests, were an important improvement.

The data was taken as one of a sequence of short measurements, with small changes to the gain made between datasets in an attempt to empirically determine the optimal gain. Results from the other datasets in this sequence are discussed in the following section to demonstrate the phase stability achieved on longer time scales and to discuss the current limitations of the correction. The individual dataset shown here comprises 150 pulses taken in interleaved mode, with the correction applied to alternating pulses as described in Section~\ref{ss:pffFirmware}. The gain was set to 800 units, corresponding to an actual applied correction of 1.3 times the upstream phase using the conversion factor calculated in Section~\ref{ss:fontGain}.

\subsection{Correction of Pulse Shape}
\label{ss:bestPulseShape}

Figure~\ref{f:BestFF_MeanPhaseAlong} shows the phase point by point along the pulse upstream, downstream with the PFF system off and downstream with the PFF system on. The value at each point is its mean taken across the 75 PFF on or 75 PFF off pulses in the dataset. The region of the pulse that is used to calculate the mean and other statistics throughout this chapter is also indicated, and will be referred to as the sample range. This range is chosen to cover the maximal proportion of the pulse within which the the correction is not being saturated as a result of the phase sag (plus jitter) exceeding the \(\pm5.5^\circ\) correction range. It covers a total of 81 samples at 5.2 ns per sample, giving a total time span of 422~ns. %The demonstration of \(0.28\pm0.01^\circ\) mean phase stability is therefore already on a much longer pulse than is needed for CLIC, where the combined pulse length is only 240~ns.

Following the optimisation of the phase propagation, described in Chapter~\ref{c:phasePropagation}, the overall shape of the upstream and (uncorrected) downstream phase along the pulse are very similar, although small uncorrelated variations are still visible. These uncorrelated differences are then visible in the corrected downstream phase, although the overall ability of the PFF system to flatten the CTF phase sag within the sample range is strikingly clear. The original peak-to-peak variation in the mean downstream phase along the pulse within the indicated range is \(5.76\pm0.14^\circ\) with the correction off. With the correction applied this is reduced to \(0.65\pm0.07^\circ\). Outside the central region of the pulse, the amplifier is saturated and the PFF system can no longer correct the shape of the phase along the pulse. The only effect is to shift the phase by the maximum possible correction of \(5.5^\circ\).

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/BestFF_MeanPhaseAlong}
  \caption{Phase along the pulse upstream (green) and downstream with the PFF system off (blue) and on (red). Vertical black lines mark the region within which the correction is not saturated.}
  \label{f:BestFF_MeanPhaseAlong}
\end{figure}

Figure~\ref{f:BestFF_Flatness} expresses the effect of the PFF system on the phase along the pulse within the central region in terms of the distribution of `flatness' values for each pulse in the data set with PFF system off and on. For each pulse the flatness value is defined as the standard deviation in the point-by-point phase across the sample range. In this case the flatness value of each pulse therefore corresponds to the standard deviation of 81 values (the length of the sample range). A pulse with a flatness value of zero would have constant phase across the whole sample range, with no small variations such as those seen in Figure~\ref{f:BestFF_MeanPhaseAlong}. The value is also insensitive to the jitter on the overall mean pulse phase seen later in Section~\ref{ss:bestMeanJitter}. In Figure~\ref{f:BestFF_Flatness}, the initial uncorrected downstream pulse flatness of \(1.68\pm0.02^\circ\), dominated by the phase sag at CTF3, is reduced to \(0.26\pm0.01^\circ\) with the correction applied. On average, the corrected pulses are \(6.5\pm0.3\) times `flatter' than the uncorrected pulses.

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/BestFF_Flatness}
  %\includestandalone[width=0.75\textwidth]{Figures/feedforward/BestFF_Flatness}
  \caption{Flatness of the initial (blue) and corrected (red) downstream phase along the pulse.}
  \label{f:BestFF_Flatness}
\end{figure}

\subsection{Correction of Mean Phase}
\label{ss:bestMeanJitter}

This section considers the mean phase, which is calculated as the average phase of each pulse across the sample range shown in Figure~\ref{f:BestFF_MeanPhaseAlong}. The initial correlation between the upstream and downstream phase in this dataset, as shown by the  distribution in Figure~\ref{f:BestFF_Real}, is \(0.93\pm0.04\). This gives a theoretical limit of a factor \(2.7\pm0.4\) reduction in the downstream jitter using Equation~\ref{e:theoretJitOptGain}. The uncorrected downstream jitter of \(0.74\pm0.06^\circ\), and consequently the downstream-upstream jitter ratio of \(1.1\pm0.1\) are the lowest achievable at CTF3. With this initial jitter and the theoretical reduction factor of \(2.7\pm0.4\) the lowest corrected downstream jitter that could be achieved is then \(0.27\pm0.05^\circ\). The aforementioned correlation and jitter ratio combine to give an optimal gain of \(1.0\pm0.1\) (Equation~\ref{e:theoretOptGain}). The actual system gain of 1.3 is therefore slightly larger than the optimal value.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/feedforward/BestFF_Real}
  \caption{Mean downstream phase plotted versus the upstream phase with the PFF system off (blue) and on (red).}
  \label{f:BestFF_Real}

  \includegraphics[width=0.8\textwidth]{Figures/feedforward/BestFF_Simulated}
  \caption{Simulated corrected downstream phase using optimal gain and unlimited correction range plotted against the upstream phase (green). The initial downstream phase (blue) is also shown. }
  \label{f:BestFF_Simulated}
\end{figure}


The second distribution of points in Figure~\ref{f:BestFF_Real} shows the effect of the PFF correction on the phase distribution. The downstream phase jitter is reduced from \(0.74\pm0.06^\circ\) to \(0.28\pm0.02^\circ\), a reduction of a factor \(2.6\pm0.3\). Within the errors this agrees with the theoretical limit derived previously given the beam conditions in this dataset. The correction acts to remove almost all correlation between the upstream and downstream phase, rotating the distribution as seen in the plot. The correlation is reduced from \(0.93\pm0.04\) to \(0.19\pm0.12\).

In terms of the achieved downstream phase jitter it should be noted, however, that the measured upstream jitter of \(0.57\pm0.05^\circ\) across the pulses with the PFF correction on in this dataset is lower than the \(0.69\pm0.06^\circ\) measured without the PFF system (Table~\ref{t:BestFF}). This is assumed to be a statistical fluctuation rather than being a systematic difference between the odd and even pulses at CTF3 or an effect of the correction (which can only influence the downstream phase). 
%Assuming the upstream jitter propagated downstream with the same ratio in each case, the true `natural' downstream jitter for the pulses without the correction applied would have been \(0.61\pm0.09^\circ\) and the true factor reduction in the corrected jitter achieved with the PFF system would be decreased to \(2.2\pm0.4\). Assuming the upstream-downstream phase correlation was also not affected by this statistical fluctuation (so that the theoretical jitter reduction of a factor \(2.7\pm0.4\) still holds), a corrected jitter of \(0.23\pm0.05^\circ\) would have been theoretically possible in this dataset.
Across the PFF off pulses the ratio between the downstream and upstream phase jitter is \(1.1\pm0.1\). If this same ratio applied to the PFF on data, the lower initial upstream phase jitter of \(0.57\pm0.05^\circ\) would have corresponded to an initial uncorrected downstream phase jitter of \(0.61\pm0.09^\circ\) across the PFF on pulses (instead of the assumed \(0.74\pm0.06^\circ\)). In this case the true factor reduction in the corrected downstream jitter achieved with the PFF system may be closer to \(2.2\pm0.4\), and a corrected downstream jitter of \(0.23\pm0.05^\circ\) may have been theoretically possible. 

With interleaved data it is also possible to simulate the expected effect of the correction empirically, as an additional point of comparison between the achieved and expected results, as well as verifying that the complete behaviour of the system is understood. The distribution of simulated corrected phases is shown in green on Figure~\ref{f:BestFF_Simulated}. It is derived by taking the initial distribution with the PFF system off and subtracting the upstream phase, multiplied by the gain factor, from the downstream phase. This exactly mimics what the feedforward system would have done if it had been applied to the even pulses in this dataset, and can be directly compared to the odd pulses taken at the same time with the actual correction applied. In this example the simulation shown is the ideal case, considering a correction with infinite range and bandwidth applied with the optimal gain. The simulated corrected downstream jitter of \(0.27\pm0.02^\circ\) agrees with the theoretical limit of \(0.27\pm0.05^\circ\) previously derived. The achieved jitter of \(0.28\pm0.02^\circ\) matches both the theoretical and simulated jitter predictions within the error, giving confidence that the overall PFF setup in this dataset (after all the commissioning steps discussed in Chapter~\ref{c:commissioning}) was close to optimal. There is perhaps some room for improvement due to the difference between the upstream jitter in the PFF on and off data as well as the larger than ideal gain, as mentioned previously, and this will be elaborated on in Section~\ref{s:longPFF}. Nevertheless, this result clearly demonstrates stability on the mean phase approaching the CLIC target of 0.2 degrees at 12~GHz and demonstrates that achieving this stability with a PFF system is feasible.




\begin{table}
  \begin{center}
    \begin{tabular}{| c c c c |}
	   \hline
       Correction Status & \(\sigma_u\) & \(\sigma_d\) & Correlation \\ \hline
       FF Off & \(0.69\pm0.06^\circ\) & \(0.74\pm0.06^\circ\) & \(0.93\pm0.04\) \\
	   FF On & \(0.57\pm0.05^\circ\) & \(0.28\pm0.02^\circ\) & \(0.19\pm0.12\) \\
	   FF Simulated & \(0.69\pm0.06^\circ\) & \(0.27\pm0.02^\circ\) & \(0.06\pm0.12\) \\ \hline
    \end{tabular}
    \caption{Summary of results for the dataset in which the lowest downstream phase jitter has been achieved. Statistics are calculated using the mean phase.}
  	\label{t:BestFF}
  \end{center}
\end{table}


\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{Figures/feedforward/BestFF_StdPhaseAlong}
  \caption{Phase jitter along the pulse upstream (green) and with the PFF system off (blue) and on (red).}
  \label{f:BestFF_StdPhaseAlong}

  \includegraphics[width=0.8\textwidth]{Figures/feedforward/BestFF_SimStdAlongPulse}
  \caption{Comparison between the achieved downstream phase jitter along the pulse (red) and a simulation of the corrected jitter using optimal gain and unlimited correction range (black).}
  \label{f:BestFF_SimStdPhaseAlong}
\end{figure}



\subsection{Phase Jitter Along the Pulse}
\label{ss:bestJitterAlong}

Figure~\ref{f:BestFF_StdPhaseAlong} shows the overall phase jitter at each sample along the pulse upstream and downstream with the PFF system off and on. These jitter values contain components coming from both the jitter on the overall mean pulse phase discussed initially and from the variations along the pulse (the non-zero flatness of each pulse). These jitter values are therefore larger and taking the mean sample jitter within the sample range an initial downstream jitter of \(0.79\pm0.02^\circ\) is reduced to \(0.36\pm0.01^\circ\) by the correction in this case, a reduction by more than a factor two. There are also variations of up to a factor two in the jitter that was measured at each sample point, the lowest jitter being \(0.27\pm0.02^\circ\) at time 802~ns and the worst \(0.52\pm0.04^\circ\) at time 552~ns. The corrected jitter along the pulse within the central sample range also agrees with the simulated result of \(0.38\pm0.01^\circ\) using the interleaved pulses without the correction applied, as shown in Figure~\ref{f:BestFF_SimStdPhaseAlong}. Outside the sample range the PFF performance is degraded as the phase sag along the pulse exceeds the \(\pm5.5^\circ\) correction range. The simulation assumes infinite correction range in this case, and therefore yields lower phase jitters than the actual system at the start and end of the pulse.


Although the largest component of phase jitter at CTF3 is on the pulse mean, effects such as energy variations along the pulse cause differences in the jitter and upstream-downstream phase correlation at each sample point (as seen in Section~\ref{s:bestPhaseProp}, for example). This leads to the variations in the achievable corrected downstream jitter along the pulse seen here, which can only be improved by further fine-tuning of the CTF3 injector stability and optics.

\subsection{CLIC Pulse Length}
\label{ss:jitterCLICPulse}

The phase stability requirements as needed for CLIC lie somewhere in-between the results presented
on the mean phase and the phase point by point along the pulse so far. This section aims to express the achieved phase jitter in a way that is more relevant to CLIC.

At CLIC high frequency
variations are well filtered by the drive beam recombination scheme and the filling time
of the accelerating structures \cite{alexThesis}. The scheme is therefore insensitive to 
features faster than around 30~ns. As the signals at CTF3 are acquired at 192~MHz (on the
SiS digitisers, Section~\ref{s:monDigitisers}), or 5.2~ns per sample, five samples can be
averaged to remove any high frequency components to which CLIC would not be sensitive. The effect of doing this on the downstream phase jitter is shown in Figure~\ref{f:BestFF_CLICPulse}. Although there is a consistent reduction in jitter along the pulse the overall effect is small, up to a maximum of \(0.06^\circ\). 
Some small peaks in jitter are removed by the averaging, although in most cases the reduction is predominantly due to reducing digitiser noise in the measurement, as opposed to actual high frequency features in the beam phase.

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/BestFF_CLICPulse}
  \caption{Original downstream phase jitter along the pulse sampled at 192~MHz (blue) compared to
  the phase jitter along the pulse using the average of 5 samples (red). Dashed vertical
  blue lines mark the sample range used for Sections~\ref{ss:bestMeanJitter}--\ref{ss:bestJitterAlong}. Vertical red lines
  show a 240~ns sample range relevant for CLIC.}
  \label{f:BestFF_CLICPulse}
\end{figure}

Also, the results up until this point have been calculated across the longest possible
portion of the CTF3 pulse within which the correction is not saturated -- a time span of 422~ns. At CLIC the combined pulse length is only 240~ns, and thus a further small improvement in the quoted achieved phase jitter can be achieved by using a sample range of this length. A 240~ns sample range is shown and compared to the original 422~ns range in Figure~\ref{f:BestFF_CLICPulse}.

The final achieved downstream phase jitter at CTF3, across the CLIC pulse length and with high frequency features removed, is \(0.33\pm0.01^\circ\). This is the figure of merit which must be reduced to \(0.2^\circ\) at CLIC. 

\newsection{longPFF}{Limitations of the PFF System Performance}

The remainder of this chapter discusses remaining operational issues for the PFF system largely resulting from drifts in the CTF3 beam conditions. This section therefore discusses the status of the correction across longer time scales, presenting both the level of corrected phase jitter that can currently be achieved routinely and to highlight areas where improvements are still needed both in the PFF setup itself and the beam conditions. Being able to regularly demonstrate and maintain corrected downstream phase jitters at the level achieved in the best dataset shown previously on the mean phase (below \(0.3^\circ\)), is one of the key remaining goals for the PFF prototype. To be concise this section focuses on the mean phase jitter, though exactly the same arguments can be applied to the correction of the jitter along the pulse and the pulse shape.

\subsection{Phase Monitor Resolution}
\label{ss:longFF_phMonRes}

The quoted initial and corrected phase jitters throughout this chapter and the thesis as a whole are the measured phase jitters including the contribution of the phase monitor resolution. The true achieved corrected downstream beam phase jitter is therefore slightly less than these measured values. The actual beam jitter can be given by (using Equation~\ref{e:measJitWithRes}):
\begin{equation}
\sigma_b^2 = \sqrt{\sigma_m^2 - \sigma_n^2}
\end{equation}
where \(\sigma_b\) is the actual phase jitter of the beam, \(\sigma_m\) is the usually quoted measured phase jitter, and \(\sigma_n\) is the phase monitor resolution. The precise phase monitor resolution in each dataset is not known as it can vary depending on sensitivities of the electronics to sources of noise in the klystron gallery, for example (Section~\ref{s:resolutionMeas}). There is also ambiguity on the resolution of the downstream phase monitor in particular, as this cannot be measured in situ. For the purposes of this section a typical measured resolution of \(0.20^\circ\) (point-by-point phase) or \(0.17^\circ\) (mean phase) will be assumed.

With these resolution values, the measured mean downstream phase jitter of \(0.28^\circ\) achieved in Section~\ref{s:jitterRecord} would correspond to an actual downstream beam phase jitter of \(0.22^\circ\). Similarly, the measured point-by-point jitter along the pulse of \(0.36^\circ\) would correspond to an actual point-by-point beam phase jitter of \(0.30^\circ\). Finally, for the results across a CLIC pulse length in Section~\ref{ss:jitterCLICPulse}, the measured jitter of \(0.33\pm0.01^\circ\) would correspond to \(0.28\pm0.01^\circ\) beam jitter. The effect could be larger or smaller depending on the precise phase monitor reoslution in this dataset. To avoid ambiguity between the measured and beam phase jitter the CLIC PFF system should ideally plan to use pairs of upstream and downstream phase monitors, thereby allowing in situ resolution measurements both upstream and downstream, as well as aiming for a phase monitor resolution much better than \(0.2^\circ\).

The effect of the phase monitor resolution is indirectly included in the theoretical predictions and simulations of the achievable corrected phase jitter presented in this chapter via the measured upstream-downstream phase correlation, which depends on the phase monitor resolution (Equation~\ref{e:corrVsResolution}). However, in general this is a small effect compared to the limitations of the phase propagation and non-optimal PFF setup (Sections~\ref{ss:longFF_beamConds}--\ref{ss:longFF_gain}).


\subsection{Beam Conditions}
\label{ss:longFF_beamConds}

\afterpage{\begin{landscape}

\begin{figure}
  \centering
  \includegraphics[width=\hsize]{Figures/feedforward/longFF_noMeanSubHistory}
  \caption{History of the mean phase upstream (green) and downstream with the PFF system off (blue) and on (red) across several hours. Vertical black lines mark the start time and span of each individual dataset. The start time of each dataset is also indicated at the top of the plot.}
  \label{f:longFF_noMeanSubHistory}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\hsize]{Figures/feedforward/longFF_history}
  \caption{Mean phase history from Figure~\ref{f:longFF_noMeanSubHistory} with the mean phase offsets of each individual dataset subtracted.}
  \label{f:longFF_history}
\end{figure}

\end{landscape}}



Figure~\ref{f:longFF_noMeanSubHistory} shows the history of the mean phases upstream and downstream with the correction on and off during one afternoon of data taking. The PFF system was not operated continuously throughout this two and a half hour period but 15 individual datasets of a few hundred pulses each were taken and these results have been combined to create a large sample of 3083 interleaved pulses (1541 with the correction on and 1542 with the correction off). The time span of each individual dataset during the overall data taking period is indicated on the figure. The data presented in Section~\ref{s:jitterRecord}, showing the lowest downstream phase jitter achieved to date, was taken from the 15:38 dataset on this afternoon. Note that the large jump in the downstream phase between the 16:00 and 16:04 datasets was caused by changes made to magnetic correctors in the TL2 chicane in order to re-optimise the beam orbit and transmission to the downstream phase monitors at this time. In Figure~\ref{f:longFF_history} the mean phase is subtracted (separately for the upstream, downstream PFF off and downstream PFF on phase) from each dataset to remove this effect, making a comparison between datasets easier. It is important to emphasise that, apart from this jump in the downstream phase, the overall picture is a fair reflection of the (uncorrected) phase stability at CTF3 in optimal conditions.


\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/enOffsetJitter}
  \caption{Mean relative energy offset (top) and energy jitter (bottom) in each dataset during the data taking period.}
  \label{f:longFF_enDrifts}
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/enCorrVsPhasCorr}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) plotted against the difference between the upstream phase-energy and downstream phase-energy correlation (\(\rho_{dp} - \rho_{up}\)).}
  \label{f:enCorrVsPhasCorr}
\end{figure}


Figure~\ref{f:longFF_enDrifts} shows how the mean beam energy and the beam energy jitter varied during the afternoon. The mean relative beam energy offset varies between \(1.8\pm0.1\times10^{-3}\) and \(-1.9\pm0.1\times10^{-3}\), with an overall trend of decreasing energy with time. Meanwhile the relative energy jitter varies by up to a factor 3 between datasets, between \(0.56\pm0.05\times10^{-3}\) (in the record 15:38 dataset) and \(1.6\pm0.1\times10^{-3}\) (in the 16:44 dataset). In Section~\ref{ss:t566Sim} it is shown that mean energy offsets and energy jitters at this level are by themselves expected to reduce the upstream-downstream phase correlation to below 90\% due to the effects of \(T_{566}\) (second order phase-energy dependences). The remainder of this section and Section~\ref{s:longFF_singleResults} focuses on how various drifts and changes during the afternoon affected the performance of the PFF system, largely in terms of the system setup. However, like the phase monitor resolution it will be seen that deviations from the optimal PFF system setup have only a small effect compared to the limitations placed by the phase propagation (initial upstream-downstream phase correlation and jitters). The phase propagation has been discussed extensively in Chapter~\ref{c:phasePropagation}, thus is only mentioned in brief here.

Figure~\ref{f:enCorrVsPhasCorr} shows one example of how energy related effects influence the phase propagation during the afternoon.
The horizontal axis shows the difference between the phase-energy correlation upstream and downstream, which should be zero in the ideal case. For large differences between \(\rho_{dp}\) (downstream phase-energy correlation) and \(\rho_{up}\) (upstream phase-energy correlation) the upstream-downstream phase correlation (\(\rho_{ud}\)) is degraded. Section~\ref{ss:t566Mitigation} discussed new feedbacks being implemented at CTF3 in order to improve the energy stability, which is likely to be the most significant area of improvement for future PFF tests.

\subsection{Upstream Phase Drifts}
\label{ss:longFF_upDrifts}

Over the course of the data taking period the mean upstream phase, in green, varies by ten degrees peak-to-peak or \(1.75 \pm 0.02^\circ\) in terms of root-mean-square variation (Figure~\ref{f:longFF_noMeanSubHistory}). The main sources of drifts are temperature related effects and instabilities of the klystrons at CTF3 \cite{lukasIPAC16}. Small drifts of up to a few degrees in the upstream phase are not an issue for the performance of the PFF correction providing the correlation between the upstream and downstream phase is not degraded. However, larger drifts may lead to a loss in correlation, for example if the source of the drift is a variation in beam energy due to the issues discussed in Chapter~\ref{c:phasePropagation}. The variation of the correlation between datasets is discussed in Section~\ref{ss:longFF_gain}.

Larger changes in the upstream phase such as the ten degree drift seen here may also impact the PFF performance purely via the limited correction range of \(\pm5.5^\circ\) combined with the phase sag along the CTF pulse. Indeed the PFF prototype's main purpose is not to remove any large, slow phase drifts but rather the faster pulse-to-pulse jitter and high frequency variations along the pulse. The phase shift applied by the PFF correction at each sample along the downstream phase, \(\Delta\phi_d(t)\), is given by:
\begin{eqnarray}
	\Delta\phi_d(t) = \begin{cases}
	-5.5^\circ, &  \text{if $g\phi_u(t) \geq+5.5^\circ$.}\\
	+5.5^\circ, &  \text{if $g\phi_u(t)\leq-5.5^\circ$}.\\
	-g\phi_u(t), &  \text{otherwise.}
	\end{cases}
	\label{e:limCorrection}
\end{eqnarray}
where \(\phi_u(t)\) is the upstream phase at each sample point and \(g\) is the gain factor used. As the optimal gain (Section~\ref{s:pffEquations}) for the correction is typically larger than unity due to the slight amplification in the downstream phase jitter with respect to the upstream jitter, the range of the PFF system in terms of the upstream phase is less than \(\pm5.5^\circ\) (for example \(\pm4.6^\circ\) for the 15:38 jitter record dataset with a gain of 1.3). Any point along the upstream phase with \(|g\phi_u(t)| > 5.5^\circ\) receives the maximum \(5.5^\circ\) phase shift downstream but can not be corrected to zero, with this remaining residual degrading the corrected phase jitter that can be achieved. Samples with  \(|g\phi_u(t)| > 5^\circ\) will also receive a slightly non-optimal correction due to the effects of the amplifier entering saturation, shown in Section~\ref{ss:ampLin}, although this effect is not yet considered in the discussion here.


\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_fractInRange}
  \caption{Fraction of pulses within the correction range of \(\pm 5.5^\circ\) at each sample point. The blue line shows the ideal case with a mean phase of zero across the central part of the pulse. The red line shows the effect of a operating the PFF system with a static 2 degree offset in this region.}
  \label{f:longFF_fractInRange}
\end{figure}


Figure~\ref{f:longFF_fractInRange} shows the fraction of pulses for which the optimal correction is within the correction range in the combined dataset. During the setup of the PFF system it is necessary to choose the zero point for the correction, i.e. the incoming upstream phase at which the correction output to the kickers is 0~V. This is done in the PFF firmware on the FONT5a board by varying the channel offset (Section~\ref{ss:channelOffset}). 
%In terms of equation~\ref{e:limCorrection} this is equivalent to adding a constant offset to \(\phi_u\) across the full pulse length. 
The optimal channel offset zeroes the mean phase taken across the part of the pulse where the best correction is desired (usually the flatter central part of the pulse at CTF3). In this case the effects of limited correction range are minimised, as the full \(\pm5.5^\circ\) range can be used to remove variations about the mean phase, rather than also having to remove a static phase offset in the overall mean. 
When the channel offset is optimal the ideal correction across a 310~ns portion of the pulse is within the \(\pm5.5^\circ\) range 96\% of the time.

However, as to date the channel offset has been set manually small deviations from the ideal case are possible. Figure~\ref{f:longFF_fractInRange} also shows the fraction of pulses within the correction range if there is a static two degree offset in the upstream phase. In this case as many as 39\% of pulses are outside the correction range within the normally correctable central region of the pulse. To mitigate these effects and to get the largest reduction in jitter possible within each individual dataset the channel offset is normally adjusted on the FONT5a board between datasets. As a consequence of this, differences in the upstream phase between datasets are not removed in the corrected downstream phase, as the zero point for the PFF correction is effectively moving with the phase drifts during the data taking period. %These remaining slow drifts could be removed at CTF3 using a secondary ``slow phase feedback", also utilising the TL2 chicane \cite{jackLCWS14}.

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_phaseOffset}
  \caption{Mean offset between the initial and corrected downstream phase in each dataset.}
  \label{f:longFF_phaseOffset}
\end{figure}

The accuracy to which the channel offset for the upstream phase has been set can be inferred by comparing the mean downstream phase in each dataset with the correction on  and off in Figure~\ref{f:longFF_noMeanSubHistory}. In the ideal case the mean phase should be identical with the PFF system on and off, so that the full correction range is being used to correct jitter about the mean as mentioned previously. Although this is the case for some datasets, such as the 15:38 dataset, a clear difference between the two is often present, most visible in the datasets between 16:39 and 16:50 in which the corrected phase is clearly shifted several degrees with respect to the uncorrected phase. The absolute offset in each dataset is plotted in Figure~\ref{f:longFF_phaseOffset}. In the region between 16:22 and 16:50 the offset rises above \(2^\circ\). The mean offset across the combined dataset is \(1.5\pm0.2^\circ\). 


In the following sections it will be shown that the effect of the non-optimal set point for the offset is small overall, although there is a noticeable degradation in the jitter that can be achieved in the datasets with the largest offsets. In any case, implementing an automatic procedure to set the zero point for the correction optimally in the FONT5a DAQ would be a useful improvement to the PFF setup procedure. This would involve adding a new module to the LabVIEW DAQ that keeps a history of the mean upstream phase (ADC2 output), and then slowly updates the ADC2 channel offset at regular intervals in order to zero the measured phase. For example, if the mean ADC2 output across the previous time period was +300 counts, the new LabVIEW module would change the ADC2 channel offset by -300 counts so that the mean is brought to zero. The full range of the PFF system can then be used to correct jitter about the mean, rather than removing static phase offsets. However, if the zero point for the correction was regularly updated in this way slow drifts in the phase would not be removed by the PFF system. To remove these drifts a complimentary slow phase feedback, utilising magnetic correctors in the TL2 chicane, would have to be run in parallel with the PFF system \cite{jackLCWS14}.



\subsection{Gain Stability}
\label{ss:longFF_gain}


Another PFF parameter that has been mostly set up empirically to date is the feedforward gain. Historically, the gain set point for the PFF prototype has been determined by a combination of viewing the results of gain scans %(Section~\ref{s:gainScans}) 
and by observing the flatness of the corrected downstream phase in online displays of the phase monitor signals. If, for example, the applied gain is too large this can be quickly seen in the online monitors as the PFF system will act to invert the original phase sag along the pulse. In this way it is relatively simple to find the approximate gain set point and to further fine-tune it by varying the gain in small steps between datasets. In later PFF attempts this approach was complimented by implementing an online display of the optimal gain, given the latest values for the upstream and downstream phase jitters and correlation. However, in this section it will be shown that due to drifts in the beam conditions at CTF3 there are large variations in the optimal gain between datasets, and these variations are rarely accurately followed in the PFF setup when using this empirical approach.


\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_jitDatSetFFOff}
  \caption{Upstream (pink) and downstream (blue) phase jitter in each dataset, as well as the ratio between the two (dashed black).}
  \label{f:longFF_jitFFOff}

  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_corrFFOff}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) in each dataset with PFF off. The shaded region shows the approximate error on the correlation measurement.}
  \label{f:longFF_corrFFOff}
\end{figure}

The optimal gain depends on the downstream-upstream phase jitter ratio and the correlation (Section~\ref{s:pffEquations}). In Figures~\ref{f:longFF_noMeanSubHistory} and~\ref{f:longFF_history} large differences in the phase stability in each dataset are clearly visible, comparing for example the large phase jumps in the 15:26 and 16:50 datasets to the comparatively calm periods at 15:38 and 16:17. This is summarised in Figure~\ref{f:longFF_jitFFOff}, which shows the upstream and downstream (PFF off) phase jitter across the 5--10 minute time period of each dataset. Over the course of the data taking period the mean upstream and downstream phase jitter both vary by around a factor two --- the upstream jitter between \(0.61\pm0.04^\circ\) in the 16:17 dataset and \(1.08\pm0.08^\circ\) at 16:22, and the downstream jitter between \(0.74\pm0.06^\circ\) at 15:38 and \(1.89\pm0.13^\circ\) at 16:50. Given the same correlation, a factor two increase in the uncorrected downstream jitter also doubles the corrected downstream phase jitter that can be achieved with the PFF system (Equation~\ref{e:theoretJitOptGain}).

Also of key importance for the PFF correction is that not only are there large variations in jitter between datasets but additionally in the downstream-upstream jitter ratio (dashed line in Figure~\ref{f:longFF_jitFFOff}). In fact, the only dataset in which the upstream and downstream jitter are comparable is the record 15:38 dataset (with a ratio of \(1.1\pm0.1\)). In all other datasets the downstream jitter is more than 1.3 times larger than the upstream jitter, reaching a maximum amplification of \(2.2\pm0.2\) in the 16:50 dataset. The mean ratio across the 15 datasets is \(1.48\pm0.04\).



\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_corrVsJitRat}
  \caption{Upstream-downstream phase correlation (\(\rho_{ud}\)) vs. jitter ratio (\(\sigma_d/\sigma_u\)). The marker size and colour indicate the theoretical limit on the corrected downstream jitter in each dataset (small, black markers represent the lowest jitters).}
  \label{f:longFF_corrVsJitRat}

  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_gain}
  \caption{Actual gain used in each dataset (blue) compared to the optimal gain (red) and the ratio between the two (dashed black).}
  \label{f:longFF_gain}
\end{figure}

As well as the jitter ratio, the upstream-downstream phase correlation also varies between datasets, as shown in Figure~\ref{f:longFF_corrFFOff}. The worst correlation is \(0.80\pm0.04\) in the 15:26 dataset and the best \(0.96\pm0.03\) in the 16:54 dataset. Although this has a much smaller (20\%) effect on the optimal gain than the factor 2 variation in jitter ratio, it has a large effect on the theoretical jitter improvement that can be achieved with the PFF system due to the dependence on the correlation in Equation~\ref{e:theoretJitOptGain}. With 80\% phase correlation only a theoretical factor 1.7 reduction in the downstream phase jitter can be achieved, whereas with 96\% correlation this is increased to a factor 3.6.



There is no observed dependence of the phase jitter ratio on the phase correlation, as shown in Figure~\ref{f:longFF_corrVsJitRat}, so the effects of varying correlation and jitter ratio on the optimal gain are independent. They combine to give the optimal gain plotted in Figure~\ref{f:longFF_gain}. As it is dominated by the differences in jitter ratio, the gain also varies by close to a factor two, varying from \(1.0\pm0.1\) in the 15:38 dataset to \(2.0\pm0.3\) in the 16:00 dataset. The actual gain factor used in the dataset is also shown.
The PFF system was designed under the assumption that the correct system gain would be approximately constant with time.
As a result, although in places the empirically derived gain that was used follows the trend of the optimal gain, the changes are much smaller and it is clear that the real gain was systematically non-optimal. 
The smallest gain actually used was 1.2 (at 15:51) and the largest 1.5 (15:26 and 16:00). However, the overall mean of the used gain across the data taking period of \(1.3\pm0.1\) agrees with the mean of the optimal values (\(1.4\pm0.3\)). 

The impact of the real system using non-optimal gain is discussed in Section~\ref{s:longFF_singleResults}. Of course, in the ideal case the stability of beam conditions at CTF3 would be improved so that the variations in optimal gain over the course of a few hours are much smaller than those shown here. Nevertheless, an automatic gain optimisation procedure could be another area of interest for future PFF attempts. Particularly if the gain were automatically updated in real time during long datasets a significant reduction in jitter could be achieved. Like the offset this could be achieved by adding a new module to the LabVIEW DAQ. In this case the module would measure the current beam conditions (upstream-downstream phase correlation, upstream jitter and downstream jitter) and then use Equation~\ref{e:fontOptGain} to calculate, and set, the optimal gain. This process would only work for interleaved data, in which the initial correlations and jitters can be calculated using the alternating pulses for which the PFF correction is not applied. With the PFF system turned on permanently a different gain optimisation technique would be required, such as an iterative procedure aiming to zero the correlation between the upstream and corrected downstream phase.

\newsection{longFF_singleResults}{Achieved and Simulated Corrected Phase Jitter}

It has been shown that the frequent drifts in both phase and downstream-upstream phase jitter ratio have not been optimally taken in to account in the PFF setup in terms of the actual offset and used gain. Nevertheless, even with a sub-optimal setup a large reduction in the downstream phase jitter can be achieved in all datasets. In the remainder of this section it will be shown that considering these constraints the PFF system is achieving close to peak performance, as well as highlighting the benefit that more accurate gain and offset control would have.

Firstly referring back to Figure~\ref{f:longFF_corrVsJitRat}, the size (area) and colour of the markers in the plot depend on the corrected downstream jitter that could be achieved in that dataset using the optimal gain. This is to emphasise again that it is a compromise between high correlation and low initial downstream jitter (and by extension low downstream-upstream jitter ratio) that gives the best conditions for the PFF correction. For example, there are seven datasets showing correlations above 93\% in Figure~\ref{f:longFF_corrFFOff}, which is the correlation in the record 15:38 record dataset. However, these datasets yield worse theoretical corrections than at 15:38, as 15:38 is the only dataset in which a high correlation and low upstream-downstream jitter ratio was achieved at the same time.

\afterpage{
\noindent\begin{minipage}{\linewidth}
\centering
%\begin{figure}
%  \centering
  \includegraphics[width=0.85\textwidth]{Figures/feedforward/longFF_datSetJitSim}
  \captionof{figure}{Simulated downstream jitter in each simulation setup: Unlimited (pink), Range (blue), Gain (red), Offset (green) and All Effects (black).}
  \label{f:longFF_datSetJitSim}
%\end{figure}

\vspace{2cm}

%\begin{table}
%  \begin{center}
    \begin{tabular}{| c  c  c  c  c  c |}
	   \hline
       Time & Unlimited &  Range &  Gain &  Offset &  All Effects \\ \hline
15:26 & \(1.01\pm0.05^\circ\) & \(1.04\pm0.05^\circ\) & \(1.04\pm0.05\) & \(1.03\pm0.05^\circ\) & \(1.03\pm0.05^\circ\) \\
15:38 & \(0.27\pm0.02^\circ\) & \(0.27\pm0.02^\circ\) & \(0.31\pm0.03\) & \(0.27\pm0.02^\circ\) & \(0.31\pm0.03^\circ\) \\
15:51 & \(0.41\pm0.03^\circ\) & \(0.41\pm0.03^\circ\) & \(0.41\pm0.03\) & \(0.42\pm0.03^\circ\) & \(0.42\pm0.03^\circ\) \\
16:00 & \(0.60\pm0.06^\circ\) & \(0.65\pm0.07^\circ\) & \(0.76\pm0.08\) & \(0.65\pm0.07^\circ\) & \(0.78\pm0.08^\circ\) \\
16:04 & \(0.36\pm0.03^\circ\) & \(0.36\pm0.03^\circ\) & \(0.37\pm0.03\) & \(0.39\pm0.03^\circ\) & \(0.41\pm0.03^\circ\) \\
16:11 & \(0.44\pm0.03^\circ\) & \(0.44\pm0.03^\circ\) & \(0.45\pm0.03\) & \(0.45\pm0.03^\circ\) & \(0.45\pm0.03^\circ\) \\
16:17 & \(0.44\pm0.03^\circ\) & \(0.44\pm0.03^\circ\) & \(0.46\pm0.03\) & \(0.45\pm0.03^\circ\) & \(0.45\pm0.03^\circ\) \\
16:22 & \(0.57\pm0.04^\circ\) & \(0.58\pm0.04^\circ\) & \(0.58\pm0.04\) & \(0.62\pm0.04^\circ\) & \(0.62\pm0.04^\circ\) \\
16:39 & \(0.46\pm0.03^\circ\) & \(0.47\pm0.03^\circ\) & \(0.48\pm0.03\) & \(0.58\pm0.04^\circ\) & \(0.59\pm0.04^\circ\) \\
16:44 & \(0.76\pm0.05^\circ\) & \(0.77\pm0.05^\circ\) & \(0.82\pm0.06\) & \(0.90\pm0.06^\circ\) & \(0.94\pm0.07^\circ\) \\
16:50 & \(0.91\pm0.07^\circ\) & \(0.93\pm0.07^\circ\) & \(1.07\pm0.08\) & \(1.07\pm0.08^\circ\) & \(1.16\pm0.08^\circ\) \\
16:54 & \(0.42\pm0.03^\circ\) & \(0.42\pm0.03^\circ\) & \(0.48\pm0.03\) & \(0.45\pm0.03^\circ\) & \(0.51\pm0.04^\circ\) \\
17:00 & \(0.42\pm0.03^\circ\) & \(0.43\pm0.03^\circ\) & \(0.44\pm0.03\) & \(0.46\pm0.03^\circ\) & \(0.47\pm0.03^\circ\) \\
17:21 & \(0.43\pm0.04^\circ\) & \(0.42\pm0.04^\circ\) & \(0.42\pm0.04\) & \(0.44\pm0.04^\circ\) & \(0.44\pm0.04^\circ\) \\
18:00 & \(0.47\pm0.04^\circ\) & \(0.48\pm0.04^\circ\) & \(0.49\pm0.04\) & \(0.52\pm0.04^\circ\) & \(0.54\pm0.04^\circ\) \\ \hline
    \end{tabular}
    \captionof{table}{Downstream phase jitter for each simulation setup and dataset.}
  	\label{t:LongFFIndivSim}
%  \end{center}
%\end{table}
\end{minipage}
\pagebreak
}

\afterpage{
\noindent\begin{minipage}{\linewidth}
\centering
%\begin{figure}
%  \centering
  \includegraphics[width=0.85\textwidth]{Figures/feedforward/longFF_jitDatSet}
  \captionof{figure}{Downstream phase jitter with the PFF system off (blue) and on (red) in each dataset compared to the expected corrected jitter using the All Effects simulation (green). The upstream phase jitter is also shown for reference (dashed black).}
  \label{f:longFF_jitDatSet}
%\end{figure}

\vspace{1cm}

%\begin{table}
%  \begin{center}
    \begin{tabular}{| c  c  c  c  c  c  |}
	   \hline
	           &   & \(\sigma_d\) & \(\rho_{ud}\)  & \(\sigma_d\)  & \(\sigma_d\)  \\
       Time & \(\sigma_u\) &  PFF Off &  PFF Off &  PFF On &  Sim \\ \hline
15:26 & \(0.99\pm0.05^\circ\) & \(1.72\pm0.09^\circ\) & \(0.80\pm0.04\) & \(0.92\pm0.05^\circ\) & \(1.03\pm0.05^\circ\) \\
15:38 & \(0.57\pm0.05^\circ\) & \(0.74\pm0.06^\circ\) & \(0.93\pm0.04\) & \(0.28\pm0.02^\circ\) & \(0.31\pm0.03^\circ\) \\
15:51 & \(0.74\pm0.05^\circ\) & \(0.98\pm0.07^\circ\) & \(0.90\pm0.04\) & \(0.42\pm0.03^\circ\) & \(0.42\pm0.03^\circ\) \\
16:00 & \(0.69\pm0.07^\circ\) & \(1.82\pm0.19^\circ\) & \(0.94\pm0.05\) & \(0.88\pm0.09^\circ\) & \(0.78\pm0.08^\circ\) \\
16:04 & \(0.79\pm0.06^\circ\) & \(1.24\pm0.09^\circ\) & \(0.96\pm0.03\) & \(0.39\pm0.03^\circ\) & \(0.41\pm0.03^\circ\) \\
16:11 & \(0.70\pm0.05^\circ\) & \(0.95\pm0.07^\circ\) & \(0.89\pm0.05\) & \(0.44\pm0.03^\circ\) & \(0.45\pm0.03^\circ\) \\
16:17 & \(0.61\pm0.04^\circ\) & \(0.80\pm0.06^\circ\) & \(0.83\pm0.06\) & \(0.58\pm0.04^\circ\) & \(0.45\pm0.03^\circ\) \\
16:22 & \(0.99\pm0.07^\circ\) & \(1.50\pm0.11^\circ\) & \(0.93\pm0.04\) & \(0.82\pm0.06^\circ\) & \(0.62\pm0.04^\circ\) \\
16:39 & \(0.96\pm0.07^\circ\) & \(1.36\pm0.10^\circ\) & \(0.94\pm0.04\) & \(0.52\pm0.04^\circ\) & \(0.59\pm0.04^\circ\) \\
16:44 & \(0.84\pm0.06^\circ\) & \(1.67\pm0.12^\circ\) & \(0.89\pm0.05\) & \(1.11\pm0.08^\circ\) & \(0.94\pm0.07^\circ\) \\
16:50 & \(0.88\pm0.06^\circ\) & \(1.89\pm0.13^\circ\) & \(0.88\pm0.05\) & \(1.24\pm0.09^\circ\) & \(1.16\pm0.08^\circ\) \\
16:54 & \(1.08\pm0.08^\circ\) & \(1.58\pm0.11^\circ\) & \(0.96\pm0.03\) & \(0.61\pm0.04^\circ\) & \(0.51\pm0.04^\circ\) \\
17:00 & \(0.85\pm0.06^\circ\) & \(1.35\pm0.10^\circ\) & \(0.95\pm0.03\) & \(0.51\pm0.04^\circ\) & \(0.47\pm0.03^\circ\) \\
17:21 & \(0.84\pm0.07^\circ\) & \(1.18\pm0.10^\circ\) & \(0.93\pm0.05\) & \(0.44\pm0.04^\circ\) & \(0.44\pm0.04^\circ\) \\
18:00 & \(0.95\pm0.08^\circ\) & \(1.40\pm0.11^\circ\) & \(0.94\pm0.04\) & \(0.57\pm0.05^\circ\) & \(0.54\pm0.04^\circ\) \\ \hline
    \end{tabular}
    \captionof{table}{Summary of PFF system results for each individual dataset. The simulated results are from the ``All Effects'' simulation in Table~\ref{t:LongFFIndivSim}}
  	\label{t:LongFFIndiv}
%  \end{center}
%\end{table}
\end{minipage}
\pagebreak
}


Figure~\ref{f:longFF_datSetJitSim} and Table~\ref{t:LongFFIndivSim} show the simulated corrected downstream jitter chronologically for each dataset with five different simulation setups:
\begin{itemize}
\item \textbf{Unlimited:} With unlimited correction range and the optimal gain (theoretical limit).
\item \textbf{Range:} With \(\pm5.5^\circ\) correction range, the optimal gain and zero offset.
\item \textbf{Gain:} With \(\pm5.5^\circ\) correction range, the actual gain used in the PFF system setup, and zero offset.
\item \textbf{Offset:} With \(\pm5.5^\circ\) correction range, the optimal gain, and the actual offset in the PFF setup.
\item \textbf{All effects:} With \(\pm5.5^\circ\) correction range, and the actual gain and offset used in the PFF setup.
\end{itemize}

By comparing the results of these five simulations it is possible to identify which PFF parameters are most critical for the correction performance. Later, by comparing the most restricted simulation, including the real offset and gain, to the phase jitter actually achieved it can be determined whether the PFF system is behaving as expected or whether there are remaining effects that need to be understood.

With the ideal PFF setup the \(\pm5.5^\circ\) range set by the amplifier power is sufficient to be able to optimally correct almost all the natural phase jitter, thus the difference between the ``Unlimited'' and ``Range'' simulation is small. Depending on the dataset, the effects of using non-optimal gain and non-optimal offset are much larger.

%The only visible effect is in datasets with the largest incoming phase jitter, with a maximal \(0.05^o\) degradation in the achievable phase jitter in the 16:00 dataset with an incoming uncorrected phase jitter of 1.8 degrees, for example.
%
%The correction range is therefore not a limiting factor for the PFF performance in normal conditions, although it may become significant if the PFF system were operated on longer time scales without updating the offset or when trying to demonstrate a factor 10 reduction in jitter (Section~\ref{s:pffNovelSetups}).

In the 15:26, 15:51, 16:11 and 16:17 datasets the gain and offset are close enough to optimal so that all five simulations give close to the same result, with no further reduction in jitter possible by improving the PFF setup. 
For the other datasets a noticeable degradation in phase jitter can be seen either as a result of the non-optimal gain or offset.
For the gain the largest effect on the achievable corrected jitter is seen at 16:00, with an increase of \(0.16\pm0.10^\circ\) due to the gain being around 20\% smaller than optimal in this dataset. 
Alternatively, in the period between 16:22 and 16:50 the offset in the PFF setup was above \(2^\circ\) and this gives an effect on the correction of the same magnitude as using non-optimal gain. The maximal degradation in the achievable downstream jitter as a result of the offset is \(0.16\pm0.10^\circ\) in the 16:50 dataset. 
With the effects of limited correction range, non-optimal offset and non-optimal gain combined the achieved corrected jitter is expected to be up to \(0.25\pm0.11^\circ\) worse than the theoretical limit (16:50).%, although in most datasets the effect is much smaller than this, with no significant difference between the unlimited and all effects simulations in the previously mentioned 15:26, 15:38, 15:51 and 16:17 datasets, for example.



The achieved downstream jitters with the actual PFF system are presented in Figure~\ref{f:longFF_jitDatSet} and Table~\ref{t:LongFFIndiv}, along with the uncorrected downstream and upstream jitter and the most realistic "All Effects" simulation of the expected performance. Overall the agreement between the downstream jitter achieved with the actual PFF system and the simulation is very good. This gives confidence that the PFF system is behaving as expected and all the effects limiting the current performance are understood and in principle can be improved to yield lower jitter in future PFF attempts. However, there is a region between 16:17 and 16:44 where differences between the simulation and actual system can be seen. In particular, the \(0.58\pm0.04^\circ\) and \(0.82\pm0.06^\circ\) downstream jitter in the 16:17 and 16:22 datasets, respectively, are noticeably worse than the simulated results of \(0.45\pm0.03\) and \(0.62\pm0.04\). The source of this is not yet understood and possibly hints at additional areas for improvement in the PFF setup.

Only the 15:38 dataset has a theoretical (and in all simulation scenarios) corrected downstream jitter of below \(0.3^\circ\) but in 10 out of 15 datasets a jitter of below \(0.5^\circ\) could have been achieved with an optimal PFF setup (or in 6 out of 15 with the actual setup). Nevertheless, 
%despite highlighting where the PFF setup and beam conditions are non-optimal during this discussion
the overall benefit of the PFF system is clear - the downstream phase jitter is reduced in every dataset, with a maximum reduction factor of 3.2 in the 16:05 dataset (in which the highest correlation of 96\% was achieved).

%Attempts to demonstrate a larger reduction factor, closer to the CLIC specification of an order of magnitude, are presented in Section~\ref{s:pffNovelSetups}.


\begin{table}
  \begin{center}
    \begin{tabular}{| c c c c |}
	   \hline
       Correction Status & \(\sigma_u\) & \(\sigma_d\) & \(\rho_{ud}\) \\ \hline
       FF Off & \(0.88\pm0.02^\circ\) & \(1.40\pm0.03^\circ\) & \(0.89\pm0.01\) \\
	   FF On & \(0.86\pm0.02^\circ\) & \(0.72\pm0.01^\circ\) & \(0.48\pm0.02\) \\
	   FF Sim Unlimited & \(0.88\pm0.02^\circ\) & \(0.61\pm0.01^\circ\) & \(-0.01\pm0.03\) \\
	   FF Sim All Effects & \(0.88\pm0.02^\circ\) & \(0.69\pm0.01^\circ\) & \(0.31\pm0.03\) \\
    \hline
    \end{tabular}
    \caption{Summary of achieved and simulated results across the whole data taking period.}
  	\label{t:LongFF}
  \end{center}
\end{table}
%\end{minipage}
%\pagebreak
%}

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_histDownstreamPhase}
  \caption{Histogram showing the downstream phase distribution with the PFF system off (blue) and on (red) across the whole data taking period.}
  \label{f:longFF_histDownstreamPhase}
\end{figure}

Alternatively, rather than showing each individual dataset Figures~\ref{f:longFF_histDownstreamPhase}---\ref{f:longFF_scatterFFSimReal} and Table~\ref{t:LongFF} present the upstream-downstream phase distribution and overall jitter improvement with all the datasets combined. In order to yield meaningful results the mean upstream and downstream phase (both with FF on and FF off) are subtracted separately for each dataset. The effect of this can be seen by comparing Figure~\ref{f:longFF_noMeanSubHistory} (with no mean subtraction) and Figure~\ref{f:longFF_history}. Without this subtraction any calculated jitter and correlation values across the combined dataset would be dominated by changes in the downstream phase resulting from changing the zero point (offset) for the correction between datasets, in addition to the large step in the downstream phase between the 16:00 and 16:04 datasets due to a beam setup change.

Overall, the actual system is able to reduce an initial downstream jitter of \(1.40\pm0.03^\circ\) by a factor of two, down to \(0.72\pm0.01^\circ\) (Figures~\ref{f:longFF_histDownstreamPhase},~\ref{f:longFF_scatterFFOff} and~\ref{f:longFF_scatterFFOn}). Due to the non-optimal setup in some datasets as shown the PFF system does not remove all correlation between the upstream and corrected downstream phase, with the initial correlation of \(0.89\pm0.01\) reduced only to \(0.48\pm0.02\). With a completely optimal setup and unlimited correction range all the correlation would be removed and the jitter could have been reduced further to \(0.61\pm0.01^\circ\) (Figure~\ref{f:longFF_scatterFFSimOpt}). However, considering the constraints of the actual system and non-optimal setup, the achieved downstream jitter and residual correlation are as expected (Figure~\ref{f:longFF_scatterFFSimReal}).

Optimisations to the PFF system setup can therefore yield around a 15\% reduction in corrected downstream phase jitter in a typical dataset. To demonstrate a larger reduction and achieve CLIC level phase stability both on short and long time scales at CTF3 the beam conditions are more critical. Further improvements not only to the best phase propagation (downstream phase jitter and upstream-downstream phase correlation) achieved so far but also clearly to the stability of these conditions are required.

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_scatterFFOff}
  \caption{Downstream phase vs. upstream phase with the PFF system off across the whole data taking period.}
  \label{f:longFF_scatterFFOff}

  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_scatterFFOn}
  \caption{Downstream phase vs. upstream phase with the PFF system on across the whole data taking period.}
  \label{f:longFF_scatterFFOn}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_scatterFFSimOpt}
  \caption{Unlimited simulation of the downstream phase vs. upstream phase distribution across the whole data taking period}
  \label{f:longFF_scatterFFSimOpt}

  \includegraphics[width=0.75\textwidth]{Figures/feedforward/longFF_scatterFFSimReal}
  \caption{All Effects simulation of the downstream phase vs. upstream phase distribution across the whole data taking period.}
  \label{f:longFF_scatterFFSimReal}
\end{figure}

\FloatBarrier

\newsection{resultsSumm}{Summary}

With the best phase propagation conditions achieved to date and an optimised PFF system setup, a measured mean downstream phase jitter of \(0.28\pm0.02^\circ\) has been achieved with the PFF prototype at CTF3. The stability of the phase along the pulse is also improved significantly, with the amplitude of the phase sag and other static features in the phase reduced by close to a factor seven, and an achieved point-by-point jitter of \(0.36\pm0.01^\circ\). Across a CLIC pulse length and excluding the phase monitor resolution component of the measured jitter, these results correspond to a beam jitter of \(0.28\pm0.01^\circ\), close to the CLIC target of \(0.2^\circ\).

The routinely achievable corrected downstream phase jitter is closer to \(0.4^\circ\) on short time scales, or \(0.7^\circ\) on the scale of hours. The main limitation is the phase propagation, with large variations in the initial (uncorrected) downstream phase jitter and upstream-downstream phase correlation between datasets. Nevertheless, it has also been identified that the methods used to set the system gain and channel offset could be improved. Moving towards automated procedures would yield a reduction of around 15\% in the achieved corrected jitter for a typical dataset. These results describe the status at the end of 2015. Recently, in 2016, the stability of CTF3 has been improved and it has been possible to routinely achieve corrected downstream phase jitters below \(0.3^\circ\).
